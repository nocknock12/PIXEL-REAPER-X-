<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PIXEL REAPER X ‚Äî CHAOS ARENA</title>
<style id="admin-style">
/* ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ */
#admin-panel {
  position:fixed;top:0;right:0;bottom:0;width:340px;background:#080810;border-left:2px solid #b060ff;
  z-index:9999;display:none;flex-direction:column;overflow:hidden;font-family:'Orbitron',monospace;
}
#admin-panel.open{display:flex;}
#admin-toggle{position:fixed;top:8px;right:8px;z-index:10000;background:#0d0d1a;border:2px solid #b060ff;
  color:#b060ff;font-family:'Orbitron',monospace;font-size:8px;font-weight:700;padding:6px 10px;
  cursor:pointer;letter-spacing:1px;}
#admin-toggle:hover{background:#b060ff;color:#fff;}
#admin-header{background:#0d0d1a;padding:10px 12px;border-bottom:2px solid #1e1e3a;display:flex;justify-content:space-between;align-items:center;}
#admin-header h2{font-size:10px;color:#b060ff;letter-spacing:3px;font-weight:700;}
#admin-close{background:none;border:1px solid #555;color:#aaa;font-size:9px;font-family:'Orbitron',monospace;cursor:pointer;padding:3px 7px;}
#admin-body{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:10px;}
.admin-section{border:1px solid #1e1e3a;padding:10px;}
.admin-section h3{font-size:8px;color:#b060ff;letter-spacing:2px;margin-bottom:8px;border-bottom:1px solid #1e1e3a;padding-bottom:4px;font-weight:700;}
.admin-row{display:flex;align-items:center;gap:6px;margin-bottom:5px;}
.admin-row label{font-size:8px;color:#888;min-width:80px;font-family:'Rajdhani',sans-serif;font-weight:700;}
.admin-input{background:#0a0a18;border:1px solid #2a2a40;color:#c8c8e0;font-family:'Orbitron',monospace;font-size:8px;padding:4px 6px;flex:1;}
.admin-input:focus{outline:none;border-color:#b060ff;}
.admin-select{background:#0a0a18;border:1px solid #2a2a40;color:#c8c8e0;font-family:'Orbitron',monospace;font-size:8px;padding:4px 6px;width:100%;cursor:pointer;}
.admin-btn{background:transparent;border:1px solid #b060ff;color:#b060ff;font-family:'Orbitron',monospace;font-size:8px;padding:5px 10px;cursor:pointer;letter-spacing:1px;}
.admin-btn:hover{background:#b060ff;color:#fff;}
.admin-btn.green{border-color:#40e080;color:#40e080;}
.admin-btn.green:hover{background:#40e080;color:#111;}
.admin-btn.red{border-color:#ff3c6e;color:#ff3c6e;}
.admin-btn.red:hover{background:#ff3c6e;color:#fff;}
.admin-grid{display:flex;flex-wrap:wrap;gap:4px;max-height:100px;overflow-y:auto;}
.admin-chip{font-size:7px;padding:2px 5px;border:1px solid #2a2a40;color:#666;cursor:pointer;transition:all .15s;font-family:'Orbitron',monospace;}
.admin-chip.sel{border-color:#b060ff;color:#b060ff;background:#0d001a;}
.admin-chip.sel-wep{border-color:#3c8eff;color:#3c8eff;background:#000d1a;}
.admin-range{width:100%;accent-color:#b060ff;}
.admin-stat-row{display:flex;align-items:center;gap:6px;margin-bottom:4px;}
.admin-stat-row label{font-size:7px;color:#666;width:70px;font-family:'Rajdhani',sans-serif;font-weight:700;}
.admin-stat-val{font-size:8px;color:#b060ff;width:28px;text-align:right;font-family:'Orbitron',monospace;}

/* ‚îÄ‚îÄ HERO CLASS SELECTION ‚îÄ‚îÄ */
#screen-hero{position:fixed;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);z-index:10;}
#screen-hero.active{display:flex;}
.hero-grid{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;max-width:820px;margin:16px 0;}
.hero-card{background:#0d0d1a;border:2px solid #1e1e3a;padding:12px;width:175px;cursor:pointer;transition:all .2s;position:relative;}
.hero-card:hover{transform:scale(1.03);}
.hero-card.sel{border-color:#b060ff;box-shadow:0 0 16px #b060ff44;}
.hero-card .hc-icon{font-size:28px;text-align:center;margin-bottom:6px;}
.hero-card .hc-name{font-size:8px;font-weight:700;color:#fff;text-align:center;margin-bottom:3px;font-family:'Orbitron',monospace;letter-spacing:1px;}
.hero-card .hc-role{font-size:9px;color:var(--dim);text-align:center;margin-bottom:6px;font-family:'Rajdhani',sans-serif;font-weight:700;}
.hero-card .hc-stats{font-size:9px;color:#555;line-height:1.8;font-family:'Rajdhani',sans-serif;}
.hero-card .hc-power{font-size:8px;color:#b060ff;margin-top:5px;border-top:1px solid #1e1e3a;padding-top:5px;font-family:'Orbitron',monospace;}
.hero-card .hc-badge{position:absolute;top:5px;right:5px;font-size:7px;padding:2px 5px;border:1px solid;font-family:'Orbitron',monospace;}

/* ‚îÄ‚îÄ LANGUAGE BUTTON ‚îÄ‚îÄ */
#lang-toggle{position:fixed;top:8px;left:8px;z-index:10000;background:#0d0d1a;border:2px solid #3c8eff;
  color:#3c8eff;font-family:'Orbitron',monospace;font-size:8px;font-weight:700;padding:6px 10px;cursor:pointer;letter-spacing:1px;}
#lang-toggle:hover{background:#3c8eff;color:#fff;}

/* ‚îÄ‚îÄ COOLDOWN DISPLAY ‚îÄ‚îÄ */
.hero-cd-bar{position:absolute;bottom:0;left:0;right:0;height:3px;background:#333;}
.hero-cd-fill{height:100%;background:linear-gradient(90deg,#b060ff,#3c8eff);transition:width .1s;}
</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=VT323&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #07070f;
  --panel: #0d0d1a;
  --border: #1e1e3a;
  --accent: #ff3c6e;
  --accent2: #3c8eff;
  --text: #c8c8e0;
  --dim: #555570;
  --gold: #ffd060;
  --green: #40e080;
  --purple: #b060ff;
  --orange: #ff8030;
  --cyan: #22ddff;
}
*{margin:0;padding:0;box-sizing:border-box;image-rendering:pixelated;}
body{background:var(--bg);color:var(--text);font-family:'Orbitron',monospace;display:flex;flex-direction:column;align-items:center;min-height:100vh;overflow:hidden;user-select:none;}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
#screen-menu,#screen-lobby,#screen-game,#screen-over{
  position:fixed;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;
  background:var(--bg);z-index:10;
}
#screen-menu.active,#screen-lobby.active,#screen-game.active,#screen-over.active{display:flex;}
#screen-game{background:transparent;pointer-events:none;}
#screen-game canvas{pointer-events:all;}

/* ‚îÄ‚îÄ GRID BG ‚îÄ‚îÄ */
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:linear-gradient(rgba(40,40,100,.06) 1px,transparent 1px),linear-gradient(90deg,rgba(40,40,100,.06) 1px,transparent 1px);
  background-size:40px 40px;}

/* ‚îÄ‚îÄ MENU ‚îÄ‚îÄ */
.menu-title{font-size:clamp(22px,3.5vw,38px);color:#fff;letter-spacing:6px;
  text-shadow:0 0 30px var(--accent),0 0 60px var(--accent2);margin-bottom:6px;
  animation:pulse 2s ease-in-out infinite;font-weight:900;}
.menu-sub{font-size:9px;color:var(--dim);letter-spacing:3px;margin-bottom:32px;font-family:'Rajdhani',sans-serif;font-weight:700;}
@keyframes pulse{0%,100%{text-shadow:0 0 20px var(--accent),0 0 50px var(--accent2);}50%{text-shadow:0 0 40px var(--accent),0 0 80px var(--accent2),0 0 120px #fff4;}}

.btn{background:transparent;color:#fff;border:2px solid var(--accent);padding:10px 22px;
  font-family:'Orbitron',monospace;font-size:9px;font-weight:700;cursor:pointer;letter-spacing:2px;
  transition:all .15s;margin:4px;text-transform:uppercase;}
.btn:hover{background:var(--accent);box-shadow:0 0 20px var(--accent);transform:scale(1.03);}
.btn.blue{border-color:var(--accent2)}.btn.blue:hover{background:var(--accent2);box-shadow:0 0 20px var(--accent2);}
.btn.gold{border-color:var(--gold)}.btn.gold:hover{background:var(--gold);color:#111;box-shadow:0 0 20px var(--gold);}
.btn.green{border-color:var(--green)}.btn.green:hover{background:var(--green);color:#111;box-shadow:0 0 20px var(--green);}
.btn.sm{font-size:8px;padding:7px 14px;}

.diff-select{display:flex;gap:8px;margin:16px 0;flex-wrap:wrap;justify-content:center;}
.diff-btn{border:2px solid var(--border);color:var(--dim);background:transparent;font-family:'Orbitron',monospace;font-size:8px;font-weight:700;padding:7px 13px;cursor:pointer;transition:all .2s;text-transform:uppercase;}
.diff-btn.active{border-color:var(--gold);color:var(--gold);box-shadow:0 0 12px #ffd06044;}
.diff-btn[data-d="easy"].active{border-color:var(--green);color:var(--green);}
.diff-btn[data-d="hard"].active{border-color:var(--orange);color:var(--orange);}
.diff-btn[data-d="insane"].active{border-color:var(--accent);color:var(--accent);animation:pulse2 .8s ease-in-out infinite;}
@keyframes pulse2{0%,100%{box-shadow:0 0 8px #ff3c6e44;}50%{box-shadow:0 0 20px var(--accent);}}

.prog-bar-wrap{width:280px;height:7px;background:#111;border:1px solid var(--border);margin:4px 0;}
.prog-bar-fill{height:100%;background:linear-gradient(90deg,var(--accent2),var(--purple));transition:width .4s;}
.xp-display{font-size:8px;color:var(--gold);margin:4px 0;font-family:'Orbitron',sans-serif;}
.unlocks-grid{display:flex;flex-wrap:wrap;gap:5px;max-width:480px;justify-content:center;margin-top:10px;}
.unlock-badge{font-size:7px;padding:3px 7px;border:1px solid var(--border);color:var(--dim);font-family:'Rajdhani',sans-serif;font-weight:700;}
.unlock-badge.done{border-color:var(--gold);color:var(--gold);}

/* ‚îÄ‚îÄ LOBBY ‚îÄ‚îÄ */
.lobby-wrap{display:flex;gap:14px;align-items:flex-start;max-width:920px;width:100%;padding:0 16px;}
.lobby-panel{background:var(--panel);border:2px solid var(--border);padding:12px;flex:1;min-width:190px;}
.lobby-panel h3{font-size:8px;font-weight:700;color:var(--dim);margin-bottom:9px;letter-spacing:2px;border-bottom:1px solid var(--border);padding-bottom:5px;font-family:'Orbitron',monospace;text-transform:uppercase;}

.rng-item{display:flex;align-items:center;gap:7px;margin-bottom:6px;padding:5px 7px;border:1px solid var(--border);background:#080810;position:relative;}
.rng-item .rarity{font-size:7px;font-weight:700;padding:2px 4px;margin-left:auto;white-space:nowrap;font-family:'Orbitron',monospace;}
.rng-item .item-icon{font-size:17px;min-width:22px;text-align:center;}
.rng-item .item-info{flex:1;}
.rng-item .item-name{font-size:8px;font-weight:700;color:#fff;margin-bottom:2px;font-family:'Orbitron',monospace;}
.rng-item .item-desc{font-size:11px;color:var(--dim);line-height:1.4;font-family:'Rajdhani',sans-serif;}
.rarity.common{color:#aaa;border:1px solid #444;}
.rarity.uncommon{color:var(--green);border:1px solid var(--green);}
.rarity.rare{color:var(--accent2);border:1px solid var(--accent2);}
.rarity.epic{color:var(--purple);border:1px solid var(--purple);}
.rarity.legendary{color:var(--gold);border:1px solid var(--gold);animation:glow-gold .8s ease-in-out infinite;}
@keyframes glow-gold{0%,100%{box-shadow:0 0 4px #ffd06044;}50%{box-shadow:0 0 12px var(--gold);}}

.modifier-chip{display:inline-flex;align-items:center;gap:5px;padding:4px 8px;border:1px solid var(--purple);color:var(--purple);font-size:8px;margin:2px;background:#0d001a;font-family:'Orbitron',monospace;font-weight:700;}
.map-preview-wrap{background:#080810;border:1px solid var(--border);height:80px;width:100%;margin-bottom:10px;position:relative;overflow:hidden;}

/* ‚îÄ‚îÄ IN-GAME HUD ‚îÄ‚îÄ */
#game-wrap{display:flex;flex-direction:column;align-items:center;width:100%;}
#ui-top{display:flex;justify-content:space-between;align-items:flex-start;width:900px;padding:6px 0 4px 0;gap:8px;}
.hud-panel{background:#0a0a14dd;border:2px solid var(--border);padding:7px 9px;min-width:190px;backdrop-filter:blur(4px);}
.hud-name{font-size:8px;font-weight:700;color:var(--dim);margin-bottom:4px;letter-spacing:1px;font-family:'Orbitron',monospace;text-transform:uppercase;}
.bar-wrap{width:100%;height:8px;background:#080810;border:1px solid #1a1a2a;margin-bottom:3px;position:relative;}
.bar-fill{height:100%;transition:width .1s;}
.hp-bar{background:linear-gradient(90deg,#c02020,#ff5050);}
.en-bar{background:linear-gradient(90deg,#1a50c0,#5090ff);}
.am-bar{background:linear-gradient(90deg,#b08000,#ffc030);}
.bar-val{font-size:11px;color:#888;position:absolute;right:3px;top:0;font-family:'VT323',monospace;}
.wep-row{font-size:8px;font-weight:700;color:var(--gold);margin-top:4px;display:flex;align-items:center;gap:4px;flex-wrap:wrap;font-family:'Orbitron',monospace;}
.wep-rarity-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0;}
.status-icons{display:flex;gap:2px;margin-top:3px;flex-wrap:wrap;}
.status-chip{font-size:9px;padding:1px 3px;border-radius:1px;}
.status-chip.burn{background:#ff400044;}.status-chip.freeze{background:#4080ff44;}.status-chip.stun{background:#ffff0044;}.status-chip.poison{background:#40ff4044;}

#center-hud{text-align:center;flex:1;}
#score-val{font-size:17px;color:#fff;text-shadow:0 0 10px var(--accent2);font-family:'Orbitron',monospace;font-weight:900;}
#wave-val{font-size:8px;font-weight:700;color:var(--dim);margin-top:2px;font-family:'Orbitron',monospace;}
#combo-display{font-size:9px;font-weight:700;color:var(--gold);margin-top:3px;min-height:13px;text-shadow:0 0 8px var(--gold);font-family:'Orbitron',monospace;}
#modifier-banner{font-size:8px;color:var(--purple);margin-top:3px;letter-spacing:1px;font-family:'Rajdhani',sans-serif;font-weight:700;}

#ui-bottom{display:flex;justify-content:space-between;align-items:flex-end;width:900px;padding:4px 0 3px;}
.controls-hint{font-size:10px;color:#2a2a40;line-height:1.9;font-family:'Rajdhani',sans-serif;font-weight:500;}
.controls-hint span{color:#3a3a58;}

#abilities-row{display:flex;gap:5px;}
.abil-slot{width:46px;height:46px;border:2px solid #1a1a2a;background:#0a0a14;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;font-size:16px;cursor:default;}
.abil-slot .akey{font-size:7px;font-weight:700;color:#333;position:absolute;top:2px;left:3px;font-family:'Orbitron',monospace;}
.abil-slot .alabel{font-size:7px;font-weight:700;color:#555;position:absolute;bottom:2px;text-align:center;line-height:1.2;font-family:'Orbitron',monospace;}
.abil-slot .acd{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.78);transition:height .1s;}
.abil-slot.ready{border-color:#3a3a5a;}.abil-slot.on-cd{opacity:.7;}.abil-slot.active{border-color:var(--purple);box-shadow:0 0 8px var(--purple);}

#kill-feed{position:fixed;right:10px;top:50%;transform:translateY(-50%);pointer-events:none;z-index:99;display:flex;flex-direction:column;gap:3px;max-width:210px;}
.kf-msg{font-size:12px;color:#ff6060;text-align:right;opacity:1;transition:opacity 2s;font-family:'VT323',monospace;}
.kf-msg.info{color:#6090ff;}.kf-msg.good{color:#40e080;}.kf-msg.legendary{color:var(--gold);text-shadow:0 0 6px var(--gold);}

#dmg-overlay{position:fixed;inset:0;pointer-events:none;z-index:200;transition:background .1s;}
#slow-vignette{position:fixed;inset:0;pointer-events:none;z-index:150;opacity:0;transition:opacity .3s;background:radial-gradient(ellipse at center,transparent 35%,rgba(80,20,160,.6) 100%);}
#fog-overlay{position:fixed;inset:0;pointer-events:none;z-index:160;display:none;background:radial-gradient(ellipse at center,transparent 20%,rgba(0,0,0,.85) 100%);}
.game-canvas-wrap{position:relative;}

/* ‚îÄ‚îÄ GAME OVER ‚îÄ‚îÄ */
.over-title{font-size:28px;margin-bottom:6px;font-family:'Orbitron',monospace;font-weight:900;}
.over-score{font-size:13px;color:var(--gold);margin-bottom:5px;font-family:'Orbitron',monospace;font-weight:700;}
.over-wave{font-size:9px;color:var(--dim);margin-bottom:18px;font-family:'Orbitron',monospace;}
.xp-gained{font-size:10px;color:var(--green);margin-bottom:18px;font-family:'Orbitron',monospace;font-weight:700;}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LANGUAGE TOGGLE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<button id="lang-toggle" onclick="toggleLang()">üåê TR/EN</button>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADMIN TOGGLE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<button id="admin-toggle" onclick="toggleAdmin()">‚öôÔ∏è ADMIN</button>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADMIN PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="admin-panel">
  <div id="admin-header">
    <h2>‚öôÔ∏è ADMIN PANEL</h2>
    <button id="admin-close" onclick="toggleAdmin()">‚úï CLOSE</button>
  </div>
  <div id="admin-body">
    <div class="admin-section">
      <h3>HERO PRESET</h3>
      <div class="admin-row">
        <label>Class</label>
        <select id="ap-hero" class="admin-select" onchange="applyHeroPreset()">
          <option value="">‚Äî CUSTOM ‚Äî</option>
          <option value="teleporter">üåÄ Teleporter</option>
          <option value="speedster">üí® Speedster</option>
          <option value="brute">üí™ Power Brute</option>
          <option value="tank">üõ° Tank</option>
          <option value="tactical">üéØ Tactical</option>
          <option value="gravity">üåç Gravity User</option>
        </select>
      </div>
    </div>
    <div class="admin-section">
      <h3>WEAPONS (select up to 3)</h3>
      <div style="margin-bottom:5px">
        <select id="ap-wep-cat" class="admin-select" onchange="refreshAdminWeapons()">
          <option value="">All</option>
          <option value="melee">Melee</option>
          <option value="pistol">Pistol</option>
          <option value="rifle">Rifle</option>
          <option value="heavy">Heavy</option>
          <option value="experimental">Experimental</option>
        </select>
      </div>
      <div id="ap-weapons-grid" class="admin-grid"></div>
    </div>
    <div class="admin-section">
      <h3>ABILITIES (select up to 4)</h3>
      <div id="ap-abilities-grid" class="admin-grid"></div>
    </div>
    <div class="admin-section">
      <h3>STATS</h3>
      <div class="admin-stat-row">
        <label>Max HP</label>
        <input type="range" class="admin-range" id="ap-maxhp" min="60" max="400" value="100" oninput="updateAdminStat('maxhp',this.value)">
        <span class="admin-stat-val" id="ap-maxhp-val">100</span>
      </div>
      <div class="admin-stat-row">
        <label>Speed</label>
        <input type="range" class="admin-range" id="ap-speed" min="0.5" max="3" step="0.1" value="1" oninput="updateAdminStat('speed',this.value)">
        <span class="admin-stat-val" id="ap-speed-val">1x</span>
      </div>
      <div class="admin-stat-row">
        <label>Dmg Mult</label>
        <input type="range" class="admin-range" id="ap-dmg" min="0.5" max="4" step="0.1" value="1" oninput="updateAdminStat('dmg',this.value)">
        <span class="admin-stat-val" id="ap-dmg-val">1x</span>
      </div>
      <div class="admin-stat-row">
        <label>CD Reduce</label>
        <input type="range" class="admin-range" id="ap-cdr" min="0" max="0.9" step="0.05" value="0" oninput="updateAdminStat('cdr',this.value)">
        <span class="admin-stat-val" id="ap-cdr-val">0%</span>
      </div>
    </div>
    <div class="admin-section">
      <h3>ACTIONS</h3>
      <div style="display:flex;flex-wrap:wrap;gap:4px;">
        <button class="admin-btn green" onclick="applyAdminConfig()">‚ñ∂ APPLY & PLAY</button>
        <button class="admin-btn" onclick="adminFillHP()">üíä FILL HP</button>
        <button class="admin-btn" onclick="adminFillEnergy()">‚ö° FILL ENERGY</button>
        <button class="admin-btn" onclick="adminFillAmmo()">üì¶ FILL AMMO</button>
        <button class="admin-btn red" onclick="adminKillEnemy()">üíÄ KILL ENEMY</button>
        <button class="admin-btn" onclick="resetAdminConfig()">‚Ü© RESET</button>
      </div>
    </div>
    <div class="admin-section">
      <h3>LIVE ADJUST (in-game)</h3>
      <div id="ap-live-section" style="font-size:8px;color:#555;font-family:'Rajdhani',sans-serif;">Start a game to use live adjustments.</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HERO SELECTION SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-hero">
  <div class="menu-title" id="hero-title">SELECT YOUR HERO</div>
  <div class="menu-sub" id="hero-sub">EACH CLASS HAS A UNIQUE SPECIAL ABILITY</div>
  <div class="hero-grid" id="hero-grid"></div>
  <div style="display:flex;gap:8px;margin-top:8px;">
    <button class="btn green" id="hero-confirm" onclick="confirmHero()">‚ñ∫ CONFIRM CLASS</button>
    <button class="btn sm" onclick="showScreen('menu')">‚Üê BACK</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MENU SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-menu">
  <div class="menu-title">PIXEL REAPER X</div>
  <div class="menu-sub">CHAOS ARENA ‚Äî EVERY ROUND IS DIFFERENT</div>

  <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;justify-content:center;">
    <button class="btn" onclick="gotoHeroSelect()" id="btn-new-game">‚ñ∫ NEW GAME</button>
    <button class="btn gold" onclick="showProgression()" id="btn-progression">‚òÖ PROGRESSION</button>
    <button class="btn blue" onclick="showScreen('hero')" id="btn-hero">ü¶∏ HERO CLASS</button>
  </div>

  <div style="font-size:8px;color:var(--dim);margin-bottom:8px;font-family:'Orbitron',monospace;letter-spacing:1px;" id="diff-label">SELECT DIFFICULTY</div>
  <div class="diff-select" id="diff-select">
    <button class="diff-btn" data-d="easy" onclick="setDiff(this)">EASY</button>
    <button class="diff-btn active" data-d="normal" onclick="setDiff(this)">NORMAL</button>
    <button class="diff-btn" data-d="hard" onclick="setDiff(this)">HARD</button>
    <button class="diff-btn" data-d="insane" onclick="setDiff(this)">INSANE</button>
  </div>

  <div id="prog-panel" style="margin-top:18px;text-align:center;display:none;max-width:500px;">
    <div class="xp-display">LEVEL <span id="level-num">1</span> ‚Äî <span id="xp-cur">0</span>/<span id="xp-next">500</span> XP</div>
    <div class="prog-bar-wrap" style="margin:5px auto;"><div class="prog-bar-fill" id="xp-bar" style="width:0%"></div></div>
    <div style="font-size:8px;color:var(--dim);margin:7px 0 4px;font-family:'Orbitron',monospace;">UNLOCKS</div>
    <div class="unlocks-grid" id="unlocks-grid"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOBBY SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-lobby">
  <div style="font-size:11px;font-weight:700;color:var(--accent);margin-bottom:4px;letter-spacing:3px;font-family:'Orbitron',monospace;">üé≤ RANDOMIZING LOADOUT...</div>
  <div style="font-size:9px;color:var(--dim);margin-bottom:14px;font-family:'Rajdhani',sans-serif;font-weight:700;" id="map-theme-label">MAP: ???</div>

  <div class="lobby-wrap">
    <div class="lobby-panel" style="flex:1.3;">
      <h3>YOUR WEAPONS</h3>
      <div id="lobby-weapons"></div>
      <h3 style="margin-top:10px;">YOUR ABILITIES</h3>
      <div id="lobby-abilities"></div>
    </div>
    <div class="lobby-panel" style="flex:1;">
      <h3>MAP PREVIEW</h3>
      <div class="map-preview-wrap">
        <canvas id="map-preview-canvas" width="240" height="80"></canvas>
      </div>
      <h3>MODIFIERS</h3>
      <div id="lobby-modifiers" style="display:flex;flex-wrap:wrap;gap:3px;"></div>
    </div>
    <div class="lobby-panel">
      <h3>ENEMY LOADOUT</h3>
      <div id="lobby-enemy"></div>
      <h3 style="margin-top:10px;">DIFFICULTY</h3>
      <div id="lobby-diff" style="font-size:9px;margin-top:5px;font-family:'Orbitron',monospace;font-weight:700;"></div>
    </div>
  </div>

  <div style="display:flex;gap:8px;margin-top:16px;">
    <button class="btn sm" onclick="rerollLobby()">üé≤ REROLL (<span id="rerolls-left">1</span> left)</button>
    <button class="btn green" onclick="startRound()">‚ñ∫ FIGHT!</button>
    <button class="btn sm" onclick="showScreen('menu')">‚Üê BACK</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAME SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-game">
  <div id="game-wrap">
    <div id="ui-top">
      <div class="hud-panel" id="p-hud">
        <div class="hud-name">‚ñ∂ PLAYER</div>
        <div class="bar-wrap"><div class="bar-fill hp-bar" id="p-hp-bar" style="width:100%"></div><div class="bar-val" id="p-hp-val">100</div></div>
        <div class="bar-wrap"><div class="bar-fill en-bar" id="p-en-bar" style="width:100%"></div><div class="bar-val" id="p-en-val">100</div></div>
        <div class="bar-wrap"><div class="bar-fill am-bar" id="p-am-bar" style="width:100%"></div><div class="bar-val" id="p-am-val">30</div></div>
        <div class="wep-row"><div class="wep-rarity-dot" id="p-wep-dot"></div><span id="p-wep-name">‚Äî</span></div>
        <div class="status-icons" id="p-statuses"></div>
      </div>
      <div id="center-hud">
        <div id="score-val">00000</div>
        <div id="wave-val">WAVE 1</div>
        <div id="combo-display"></div>
        <div id="modifier-banner"></div>
      </div>
      <div class="hud-panel" style="text-align:right;">
        <div class="hud-name" style="color:#e06060;">ENEMY ‚óÄ</div>
        <div class="bar-wrap"><div class="bar-fill hp-bar" id="e-hp-bar" style="width:100%"></div><div class="bar-val" id="e-hp-val">150</div></div>
        <div class="bar-wrap"><div class="bar-fill am-bar" id="e-am-bar" style="width:100%"></div><div class="bar-val" id="e-am-val">‚àû</div></div>
        <div class="wep-row" style="justify-content:flex-end;"><span id="e-wep-name">‚Äî</span><div class="wep-rarity-dot" id="e-wep-dot"></div></div>
        <div class="status-icons" id="e-statuses" style="justify-content:flex-end;"></div>
      </div>
    </div>
    <div class="game-canvas-wrap">
      <canvas id="gcanvas" width="900" height="480" style="display:block;cursor:crosshair;border:2px solid var(--border);box-shadow:0 0 40px rgba(60,80,200,.15);"></canvas>
    </div>
    <div id="ui-bottom">
      <div class="controls-hint"><span>WASD</span> MOVE &nbsp;<span>SPACE</span> JUMP &nbsp;<span>MOUSE</span> AIM/FIRE<br><span>Q</span> SWAP &nbsp;<span>R</span> RELOAD &nbsp;<span>X</span> MELEE &nbsp;<span>1-4</span> ABILITIES</div>
      <div id="abilities-row"></div>
      <div class="controls-hint" style="text-align:right;">Crits deal 2-3√ó damage<br>Status effects stack<br>Combos multiply score</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAME OVER SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-over">
  <div class="over-title" id="over-title">GAME OVER</div>
  <div class="over-score" id="over-score">SCORE: 00000</div>
  <div class="over-wave" id="over-wave">WAVE REACHED: 1</div>
  <div class="xp-gained" id="over-xp">+0 XP EARNED</div>
  <div style="display:flex;gap:8px;">
    <button class="btn" onclick="gotoLobby()">‚ñ∫ PLAY AGAIN</button>
    <button class="btn sm" onclick="showScreen('menu')">MENU</button>
  </div>
</div>

<div id="dmg-overlay"></div>
<div id="slow-vignette"></div>
<div id="fog-overlay"></div>
<div id="kill-feed"></div>

<script>
'use strict';
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PIXEL REAPER X ‚Äî CHAOS ARENA  |  EXPANDED EDITION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ PROGRESSION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PROG = (() => {
  const d = { xp:0, level:1, totalWaves:0, totalKills:0, highScore:0, unlocked:[] };
  try { return {...d, ...JSON.parse(localStorage.getItem('pxr_prog')||'{}')}; }
  catch { return {...d}; }
})();
function saveProg() { try { localStorage.setItem('pxr_prog', JSON.stringify(PROG)); } catch{} }
function addXP(amt) {
  PROG.xp += amt;
  const xpPerLevel = 500 + PROG.level * 200;
  while (PROG.xp >= xpPerLevel) { PROG.xp -= xpPerLevel; PROG.level++; }
  saveProg();
}
const UNLOCK_LIST = [
  { id:'reroll2',       name:'EXTRA REROLL',    desc:'2 rerolls per lobby',     req:3  },
  { id:'legendary_boost',name:'LEGEND BOOST',   desc:'+5% legendary chance',    req:5  },
  { id:'start_hp',      name:'IRON BODY',        desc:'Start with 120 HP',       req:8  },
  { id:'ability4',      name:'4TH ABILITY',      desc:'Always get 4 abilities',  req:12 },
  { id:'reflect_unlock',name:'REFLECTOR',        desc:'Reflect bullets',         req:15 },
  { id:'berserk_unlock',name:'BERSERKER',        desc:'Berserk mode',            req:20 },
];

// ‚îÄ‚îÄ WEAPON DEFINITIONS (100 weapons) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const WEAPON_DEFS = {
  // ‚îÄ‚îÄ MELEE (15) ‚îÄ‚îÄ
  FISTS:        { cat:'melee', name:'FISTS',         icon:'üëä', dmg:[8,14],    rate:300,  range:35, ammo:Infinity, reload:0,    rarity:'common',    color:'#ffaa88', effect:null,    desc:'No ammo, very fast.' },
  KNIFE:        { cat:'melee', name:'COMBAT KNIFE',  icon:'üî™', dmg:[18,26],   rate:220,  range:32, ammo:Infinity, reload:0,    rarity:'common',    color:'#cccccc', effect:'bleed', desc:'Rapid slashes. Bleeds.' },
  SWORD:        { cat:'melee', name:'KATANA',        icon:'‚öîÔ∏è', dmg:[28,40],   rate:500,  range:45, ammo:Infinity, reload:0,    rarity:'uncommon',  color:'#88ccff', effect:'bleed', desc:'Ignores some armor.' },
  HAMMER:       { cat:'melee', name:'WARHAMMER',     icon:'üî®', dmg:[55,80],   rate:900,  range:40, ammo:Infinity, reload:0,    rarity:'rare',      color:'#aaaaaa', effect:'stun',  desc:'Stuns on hit.' },
  SPEAR:        { cat:'melee', name:'ENERGY SPEAR',  icon:'üî±', dmg:[38,54],   rate:550,  range:60, ammo:Infinity, reload:0,    rarity:'uncommon',  color:'#44ffcc', effect:null,    desc:'Extra long reach.' },
  CHAINSAW:     { cat:'melee', name:'CHAINSAW',      icon:'ü™ö', dmg:[15,22],   rate:100,  range:38, ammo:Infinity, reload:0,    rarity:'epic',      color:'#ff8800', effect:'burn',  desc:'Rapid burning.' },
  SCYTHE:       { cat:'melee', name:'DEATH SCYTHE',  icon:'‚ö∞Ô∏è', dmg:[44,62],   rate:650,  range:52, ammo:Infinity, reload:0,    rarity:'rare',      color:'#cc44ff', effect:'poison',desc:'Wide sweep. Poisons.' },
  CLAWS:        { cat:'melee', name:'VOID CLAWS',    icon:'ü¶Ö', dmg:[20,30],   rate:180,  range:30, ammo:Infinity, reload:0,    rarity:'rare',      color:'#6644ff', effect:null,    desc:'Triple-hit combo.' },
  MACE:         { cat:'melee', name:'THUNDER MACE',  icon:'ü™Ñ', dmg:[60,90],   rate:950,  range:38, ammo:Infinity, reload:0,    rarity:'epic',      color:'#ffee44', effect:'stun',  desc:'Huge stun radius.' },
  WHIP:         { cat:'melee', name:'PLASMA WHIP',   icon:'üåÄ', dmg:[25,36],   rate:280,  range:72, ammo:Infinity, reload:0,    rarity:'rare',      color:'#ff44aa', effect:'burn',  desc:'Longest melee range.' },
  BASEBALL_BAT: { cat:'melee', name:'RIOT BATON',    icon:'üèè', dmg:[32,48],   rate:620,  range:42, ammo:Infinity, reload:0,    rarity:'uncommon',  color:'#ffbb55', effect:'stun',  desc:'Knockback on hit.' },
  DRILLS:       { cat:'melee', name:'DRILL ARMS',    icon:'üî©', dmg:[12,18],   rate:80,   range:28, ammo:Infinity, reload:0,    rarity:'uncommon',  color:'#aabbcc', effect:'bleed', desc:'Fastest melee attack.' },
  LANCE:        { cat:'melee', name:'LASER LANCE',   icon:'üîã', dmg:[70,100],  rate:1200, range:58, ammo:Infinity, reload:0,    rarity:'epic',      color:'#ff2288', effect:null,    desc:'Piercing thrust.' },
  PLASMA_BLADE: { cat:'melee', name:'PLASMA BLADE',  icon:'üó°Ô∏è', dmg:[70,110],  rate:600,  range:50, ammo:Infinity, reload:0,    rarity:'legendary', color:'#ff40ff', effect:'poison',desc:'Exotic energy blade.' },
  VOID_SWORD:   { cat:'melee', name:'VOID REAPER',   icon:'üíÄ', dmg:[90,130],  rate:800,  range:55, ammo:Infinity, reload:0,    rarity:'legendary', color:'#8800ff', effect:'bleed', desc:'Legendary executioner.' },

  // ‚îÄ‚îÄ PISTOLS (15) ‚îÄ‚îÄ
  PISTOL:       { cat:'pistol', name:'M9 PISTOL',     icon:'üî´', dmg:[22,32],   rate:380,  speed:14, spread:.06, ammo:12, reload:900,  rarity:'common',    color:'#ffee88', proj:1, desc:'Reliable sidearm.' },
  REVOLVER:     { cat:'pistol', name:'REVOLVER',      icon:'üî´', dmg:[50,70],   rate:700,  speed:15, spread:.03, ammo:6,  reload:1400, rarity:'uncommon',  color:'#ff9966', proj:1, desc:'High damage, slow.' },
  DUAL_PISTOLS: { cat:'pistol', name:'DUAL PISTOLS',  icon:'üî´', dmg:[18,28],   rate:200,  speed:14, spread:.08, ammo:24, reload:1100, rarity:'rare',      color:'#ffdd44', proj:2, desc:'Double fire rate!' },
  HAND_CANNON:  { cat:'pistol', name:'HAND CANNON',   icon:'üí•', dmg:[85,120],  rate:1000, speed:16, spread:.04, ammo:4,  reload:1800, rarity:'epic',      color:'#ff6600', proj:1, crit:0.5, desc:'50% crit chance.' },
  VOID_GUN:     { cat:'pistol', name:'VOID GUN',      icon:'üåÄ', dmg:[40,60],   rate:400,  speed:13, spread:.05, ammo:8,  reload:1200, rarity:'legendary', color:'#8040ff', proj:1, effect:'freeze', pierce:true, desc:'Pierces all targets.' },
  DEAGLE:       { cat:'pistol', name:'DESERT EAGLE',  icon:'üî´', dmg:[60,88],   rate:600,  speed:15, spread:.05, ammo:7,  reload:1600, rarity:'uncommon',  color:'#ffcc88', proj:1, desc:'Power handgun.' },
  NEEDLE_GUN:   { cat:'pistol', name:'NEEDLE GUN',    icon:'üíâ', dmg:[12,18],   rate:150,  speed:18, spread:.02, ammo:30, reload:1000, rarity:'common',    color:'#44ffaa', proj:1, effect:'poison', desc:'Fast, poisons target.' },
  STUN_PISTOL:  { cat:'pistol', name:'STUN PISTOL',   icon:'‚ö°', dmg:[20,30],   rate:500,  speed:13, spread:.06, ammo:8,  reload:1200, rarity:'uncommon',  color:'#ffff44', proj:1, effect:'stun',   desc:'Stuns on hit.' },
  PLASMA_PISTOL:{ cat:'pistol', name:'PLASMA PISTOL', icon:'üîÆ', dmg:[35,52],   rate:350,  speed:14, spread:.07, ammo:14, reload:1300, rarity:'rare',      color:'#ff44ff', proj:1, effect:'burn',   desc:'Plasma burns.' },
  SCATTER_SHOT: { cat:'pistol', name:'SCATTER SHOT',  icon:'üî´', dmg:[14,20],   rate:600,  speed:12, spread:.30, ammo:6,  reload:1100, rarity:'uncommon',  color:'#ffaa44', proj:5, desc:'Mini shotgun pistol.' },
  MAGNUM:       { cat:'pistol', name:'MAGNUM X',      icon:'üî´', dmg:[75,105],  rate:850,  speed:16, spread:.03, ammo:5,  reload:1500, rarity:'rare',      color:'#ff8855', proj:1, crit:0.35, desc:'High crit potential.' },
  FREEZE_GUN:   { cat:'pistol', name:'CRYO PISTOL',   icon:'‚ùÑÔ∏è', dmg:[18,26],   rate:420,  speed:12, spread:.05, ammo:10, reload:1100, rarity:'rare',      color:'#88ddff', proj:1, effect:'freeze', desc:'Freezes enemies solid.' },
  CHAIN_SHOT:   { cat:'pistol', name:'CHAIN SHOT',    icon:'‚õìÔ∏è', dmg:[30,44],   rate:550,  speed:14, spread:.04, ammo:8,  reload:1300, rarity:'epic',      color:'#ffcc33', proj:1, bouncy:2, desc:'Bullets chain-bounce.' },
  SOUL_PISTOL:  { cat:'pistol', name:'SOUL PISTOL',   icon:'üåë', dmg:[45,65],   rate:450,  speed:13, spread:.04, ammo:9,  reload:1400, rarity:'epic',      color:'#aa44ff', proj:1, effect:'poison', pierce:true, desc:'Soul rounds pierce.' },
  GOLDEN_GUN:   { cat:'pistol', name:'GOLDEN GUN',    icon:'‚≠ê', dmg:[120,180], rate:1500, speed:18, spread:.01, ammo:1,  reload:2500, rarity:'legendary', color:'#ffd060', proj:1, crit:0.99, desc:'One shot, high crit.' },

  // ‚îÄ‚îÄ RIFLES (20) ‚îÄ‚îÄ
  AR:           { cat:'rifle', name:'ASSAULT RIFLE',  icon:'üî´', dmg:[16,24],   rate:130,  speed:15, spread:.05, ammo:30, reload:1800, rarity:'common',    proj:1, auto:true, color:'#ffcc44', desc:'Full auto, versatile.' },
  SHOTGUN:      { cat:'rifle', name:'SHOTGUN',        icon:'üî´', dmg:[18,26],   rate:650,  speed:11, spread:.28, ammo:8,  reload:2000, rarity:'uncommon',  proj:8, color:'#ff8844', desc:'8 pellets per shot.' },
  SNIPER:       { cat:'rifle', name:'SNIPER',         icon:'üéØ', dmg:[90,130],  rate:1400, speed:24, spread:.01, ammo:5,  reload:2500, rarity:'rare',      proj:1, crit:0.35, color:'#44ffcc', desc:'35% crit. Long range.' },
  SMG:          { cat:'rifle', name:'SMG',            icon:'üî´', dmg:[10,16],   rate:70,   speed:16, spread:.12, ammo:40, reload:1400, rarity:'common',    proj:1, auto:true, color:'#ffaa22', desc:'Spray and pray.' },
  RAILGUN:      { cat:'rifle', name:'RAILGUN',        icon:'‚ö°', dmg:[200,280], rate:3000, speed:30, spread:.00, ammo:1,  reload:3500, rarity:'legendary', proj:1, pierce:true, color:'#22ffff', desc:'Instant kill potential.' },
  BURST_RIFLE:  { cat:'rifle', name:'BURST RIFLE',    icon:'üî´', dmg:[20,30],   rate:80,   speed:15, spread:.06, ammo:24, reload:1800, rarity:'uncommon',  proj:1, burst:3, burstDelay:80, color:'#ffbb44', desc:'3-round burst.' },
  LMG:          { cat:'rifle', name:'LIGHT MG',       icon:'üî´', dmg:[14,20],   rate:90,   speed:15, spread:.09, ammo:60, reload:2800, rarity:'uncommon',  proj:1, auto:true, color:'#ffdd55', desc:'High capacity LMG.' },
  CARBINE:      { cat:'rifle', name:'CARBINE',        icon:'üî´', dmg:[22,32],   rate:160,  speed:16, spread:.04, ammo:20, reload:1600, rarity:'common',    proj:1, auto:true, color:'#ffaa88', desc:'Balanced carbine.' },
  LEVER_ACTION: { cat:'rifle', name:'LEVER ACTION',   icon:'üéØ', dmg:[55,78],   rate:950,  speed:20, spread:.02, ammo:8,  reload:2200, rarity:'uncommon',  proj:1, color:'#ffcc66', desc:'Cowboy rifle. Power.' },
  BULLPUP:      { cat:'rifle', name:'BULLPUP',        icon:'üî´', dmg:[19,27],   rate:110,  speed:16, spread:.04, ammo:28, reload:1500, rarity:'common',    proj:1, auto:true, color:'#aaff88', desc:'Compact full-auto.' },
  MARKSMAN:     { cat:'rifle', name:'MARKSMAN RIFLE', icon:'üéØ', dmg:[70,100],  rate:900,  speed:22, spread:.02, ammo:10, reload:2200, rarity:'rare',      proj:1, crit:0.25, color:'#44ddbb', desc:'Semi-auto precision.' },
  HYPER_RIFLE:  { cat:'rifle', name:'HYPER RIFLE',    icon:'üî•', dmg:[25,38],   rate:95,   speed:17, spread:.05, ammo:35, reload:2000, rarity:'rare',      proj:1, auto:true, effect:'burn', color:'#ff8822', desc:'Burn rounds. Fast.' },
  CRYO_RIFLE:   { cat:'rifle', name:'CRYO RIFLE',     icon:'‚ùÑÔ∏è', dmg:[22,34],   rate:120,  speed:15, spread:.06, ammo:25, reload:1900, rarity:'rare',      proj:1, auto:true, effect:'freeze', color:'#66ccff', desc:'Spray freeze rounds.' },
  STORM_RIFLE:  { cat:'rifle', name:'STORM RIFLE',    icon:'‚ö°', dmg:[18,26],   rate:85,   speed:16, spread:.07, ammo:36, reload:1800, rarity:'rare',      proj:1, auto:true, effect:'stun', color:'#ffff88', desc:'Stun rounds auto.' },
  TOXIC_RIFLE:  { cat:'rifle', name:'TOXIC RIFLE',    icon:'‚ò†Ô∏è', dmg:[15,22],   rate:100,  speed:15, spread:.06, ammo:32, reload:1800, rarity:'rare',      proj:1, auto:true, effect:'poison', color:'#66ff66', desc:'Poison rounds.' },
  TWIN_BARREL:  { cat:'rifle', name:'TWIN BARREL',    icon:'üî´', dmg:[28,42],   rate:300,  speed:13, spread:.14, ammo:16, reload:2100, rarity:'uncommon',  proj:4, color:'#ffbb66', desc:'4 shots per trigger.' },
  PHANTOM:      { cat:'rifle', name:'PHANTOM RIFLE',  icon:'üëª', dmg:[55,80],   rate:700,  speed:22, spread:.01, ammo:8,  reload:2200, rarity:'epic',      proj:1, pierce:true, color:'#ccaaff', desc:'Piercing ghost round.' },
  THUNDER_RIFLE:{ cat:'rifle', name:'THUNDER RIFLE',  icon:'‚ö°', dmg:[80,115],  rate:1200, speed:18, spread:.03, ammo:6,  reload:2400, rarity:'epic',      proj:1, explosive:true, explodeR:55, color:'#ffee00', desc:'Thunder explosive rounds.' },
  STAR_SNIPER:  { cat:'rifle', name:'STAR SNIPER',    icon:'‚ú®', dmg:[130,190], rate:2000, speed:28, spread:.00, ammo:3,  reload:3200, rarity:'legendary', proj:1, crit:0.5, pierce:true, color:'#ffffaa', desc:'Star-piercing shot.' },
  OMEGA_CANNON: { cat:'rifle', name:'OMEGA CANNON',   icon:'üåü', dmg:[150,220], rate:2500, speed:20, spread:.01, ammo:4,  reload:3000, rarity:'legendary', proj:1, explosive:true, explodeR:80, color:'#ffaa00', desc:'Legendary cannon round.' },

  // ‚îÄ‚îÄ HEAVY (20) ‚îÄ‚îÄ
  ROCKET:       { cat:'heavy', name:'ROCKET LAUNCHER',  icon:'üöÄ', dmg:[100,140], rate:1800, speed:7,  spread:.02, ammo:3,  reload:3000, rarity:'rare',      proj:1, explosive:true, explodeR:90,  color:'#ff4422', desc:'AOE explosion.' },
  MINIGUN:      { cat:'heavy', name:'MINIGUN',           icon:'üí•', dmg:[8,14],    rate:60,   speed:14, spread:.18, ammo:80, reload:4000, rarity:'epic',      proj:1, auto:true, spinup:800, color:'#ffdd00', desc:'Spinup, insane RoF.' },
  GRENADE_L:    { cat:'heavy', name:'GRENADE LAUNCHER',  icon:'üí£', dmg:[80,110],  rate:1000, speed:9,  spread:.05, ammo:6,  reload:2500, rarity:'rare',      proj:1, explosive:true, explodeR:80, gravity:0.3, bounce:true, color:'#88ff44', desc:'Bouncing grenades.' },
  FLAMETHROWER: { cat:'heavy', name:'FLAMETHROWER',      icon:'üî•', dmg:[6,12],    rate:50,   speed:7,  spread:.35, ammo:60, reload:3000, rarity:'epic',      proj:1, auto:true, effect:'burn', short:true, color:'#ff6600', desc:'Short range BURN.' },
  BLACK_HOLE:   { cat:'heavy', name:'SINGULARITY',       icon:'üåë', dmg:[30,50],   rate:2500, speed:4,  spread:.00, ammo:2,  reload:4000, rarity:'legendary', proj:1, blackhole:true, color:'#6600cc', desc:'Sucks enemies in.' },
  MORTAR:       { cat:'heavy', name:'MORTAR',            icon:'üí£', dmg:[90,130],  rate:1600, speed:8,  spread:.04, ammo:4,  reload:2800, rarity:'rare',      proj:1, explosive:true, explodeR:100, gravity:0.5, bounce:true, color:'#cc8833', desc:'Arcing explosive shell.' },
  PLASMA_CANNON:{ cat:'heavy', name:'PLASMA CANNON',     icon:'üîÆ', dmg:[120,170], rate:2200, speed:6,  spread:.02, ammo:3,  reload:3500, rarity:'epic',      proj:1, explosive:true, explodeR:70, color:'#ff44ff', desc:'Plasma AOE burst.' },
  AUTOCANNON:   { cat:'heavy', name:'AUTOCANNON',        icon:'üí•', dmg:[28,40],   rate:200,  speed:14, spread:.07, ammo:30, reload:3000, rarity:'epic',      proj:1, auto:true, explosive:true, explodeR:35, color:'#ff8800', desc:'Auto explosive rounds.' },
  NUKE_LAUNCHER:{ cat:'heavy', name:'MINI NUKE',         icon:'‚ò¢Ô∏è', dmg:[200,300], rate:4000, speed:5,  spread:.00, ammo:1,  reload:5000, rarity:'legendary', proj:1, explosive:true, explodeR:160, gravity:0.2, color:'#ffff00', desc:'Massive nuclear blast.' },
  HELLFIRE:     { cat:'heavy', name:'HELLFIRE',          icon:'üî•', dmg:[40,60],   rate:800,  speed:8,  spread:.06, ammo:6,  reload:2800, rarity:'epic',      proj:1, explosive:true, explodeR:65, effect:'burn', color:'#ff3300', desc:'Incendiary rocket.' },
  SPIKE_CANNON: { cat:'heavy', name:'SPIKE CANNON',      icon:'üìå', dmg:[70,95],   rate:1400, speed:12, spread:.03, ammo:5,  reload:2600, rarity:'rare',      proj:3, color:'#aaaaaa', desc:'3 spikes per shot.' },
  CHAIN_GUN:    { cat:'heavy', name:'CHAINGUN',          icon:'‚öôÔ∏è', dmg:[12,18],   rate:50,   speed:15, spread:.15, ammo:100,reload:4500, rarity:'rare',      proj:1, auto:true, spinup:600, color:'#ddcc44', desc:'Max-speed chain.' },
  ACID_LAUNCHER:{ cat:'heavy', name:'ACID LAUNCHER',     icon:'üß™', dmg:[50,70],   rate:1200, speed:8,  spread:.03, ammo:4,  reload:2800, rarity:'epic',      proj:1, explosive:true, explodeR:60, effect:'poison', color:'#66ff33', desc:'Acid AOE poisons area.' },
  THUNDER_CANNON:{ cat:'heavy', name:'THUNDER CANNON',   icon:'‚ö°', dmg:[160,220], rate:2800, speed:8,  spread:.01, ammo:2,  reload:4000, rarity:'legendary', proj:1, explosive:true, explodeR:110, color:'#ffffff', desc:'God-tier thunder round.' },
  VORTEX_GUN:   { cat:'heavy', name:'VORTEX GUN',        icon:'üå™Ô∏è', dmg:[40,60],   rate:1800, speed:5,  spread:.00, ammo:3,  reload:3200, rarity:'legendary', proj:1, blackhole:true, color:'#9944ff', desc:'Creates a vortex.' },
  CRYO_CANNON:  { cat:'heavy', name:'CRYO CANNON',       icon:'‚ùÑÔ∏è', dmg:[70,100],  rate:1600, speed:7,  spread:.03, ammo:4,  reload:2800, rarity:'rare',      proj:1, explosive:true, explodeR:75, effect:'freeze', color:'#44aaff', desc:'Cryo explosion.' },
  FIRESTORM:    { cat:'heavy', name:'FIRESTORM',         icon:'üî•', dmg:[8,14],    rate:40,   speed:8,  spread:.40, ammo:80, reload:3500, rarity:'epic',      proj:2, auto:true, effect:'burn', short:true, color:'#ff5500', desc:'Double flamethrower.' },
  LANCE_CANNON: { cat:'heavy', name:'LANCE CANNON',      icon:'üî±', dmg:[100,140], rate:2000, speed:15, spread:.00, ammo:3,  reload:3000, rarity:'epic',      proj:1, pierce:true, color:'#ff44cc', desc:'Piercing heavy round.' },
  GRAVITY_BOMB: { cat:'heavy', name:'GRAVITY BOMB',      icon:'üåç', dmg:[60,90],   rate:2200, speed:6,  spread:.02, ammo:3,  reload:3800, rarity:'legendary', proj:1, blackhole:true, gravity:0.6, color:'#4466ff', desc:'Gravity well bomb.' },
  DOOM_CANNON:  { cat:'heavy', name:'DOOM CANNON',       icon:'‚ò†Ô∏è', dmg:[250,350], rate:5000, speed:4,  spread:.00, ammo:1,  reload:6000, rarity:'legendary', proj:1, explosive:true, explodeR:200, pierce:true, color:'#ff0000', desc:'Ultimate destruction.' },

  // ‚îÄ‚îÄ EXPERIMENTAL (15) ‚îÄ‚îÄ
  BOUNCER:      { cat:'experimental', name:'BOUNCER',       icon:'üîµ', dmg:[30,45],  rate:400,  speed:12, spread:.02, ammo:10, reload:1500, rarity:'rare',      proj:1, bouncy:3,  color:'#44aaff', desc:'Bullets bounce 3 times.' },
  TIME_PISTOL:  { cat:'experimental', name:'TIME PISTOL',   icon:'‚åõ', dmg:[35,55],  rate:500,  speed:10, spread:.04, ammo:8,  reload:1600, rarity:'epic',      proj:1, effect:'slow_bullet', color:'#cc88ff', desc:'Bullets slow enemies.' },
  CLONE_GUN:    { cat:'experimental', name:'CLONE GUN',     icon:'üë•', dmg:[25,35],  rate:350,  speed:13, spread:.08, ammo:12, reload:1800, rarity:'legendary', proj:3, spread_mode:'fan', color:'#ff88ff', desc:'3 bullets in a fan.' },
  GRAVITY_GUN:  { cat:'experimental', name:'GRAVITY GUN',   icon:'üåç', dmg:[20,30],  rate:600,  speed:6,  spread:.01, ammo:8,  reload:2000, rarity:'epic',      proj:1, gravity_flip:true, color:'#44ff88', desc:'Bullets curve down.' },
  LASER:        { cat:'experimental', name:'LASER RIFLE',   icon:'üî¥', dmg:[45,65],  rate:200,  speed:25, spread:.00, ammo:20, reload:2000, rarity:'rare',      proj:1, laser:true, color:'#ff4444', desc:'Instant hitscan laser.' },
  MIRROR_GUN:   { cat:'experimental', name:'MIRROR GUN',    icon:'ü™û', dmg:[28,42],  rate:450,  speed:14, spread:.03, ammo:10, reload:1700, rarity:'epic',      proj:1, bouncy:5, color:'#ccffff', desc:'5 bounces, mirror path.' },
  PRISM_GUN:    { cat:'experimental', name:'PRISM GUN',     icon:'üî∑', dmg:[22,34],  rate:350,  speed:13, spread:.06, ammo:15, reload:1800, rarity:'rare',      proj:4, spread_mode:'fan', color:'#88ffff', desc:'4-way prism shot.' },
  WARP_SHOT:    { cat:'experimental', name:'WARP SHOT',     icon:'üåÄ', dmg:[40,60],  rate:600,  speed:8,  spread:.00, ammo:6,  reload:1800, rarity:'epic',      proj:1, gravity_flip:true, bouncy:2, color:'#aa44ff', desc:'Warp physics bullet.' },
  SONIC_BLASTER:{ cat:'experimental', name:'SONIC BLASTER', icon:'üì¢', dmg:[30,45],  rate:300,  speed:11, spread:.20, ammo:14, reload:1600, rarity:'rare',      proj:6, color:'#ffffaa', desc:'6-shot sonic burst.' },
  PHASE_GUN:    { cat:'experimental', name:'PHASE GUN',     icon:'üëª', dmg:[50,75],  rate:550,  speed:20, spread:.02, ammo:8,  reload:1900, rarity:'epic',      proj:1, pierce:true, laser:true, color:'#88aaff', desc:'Phase through walls.' },
  STORM_CASTER: { cat:'experimental', name:'STORM CASTER',  icon:'‚ö°', dmg:[15,22],  rate:80,   speed:14, spread:.15, ammo:50, reload:2200, rarity:'epic',      proj:1, auto:true, effect:'stun', color:'#ffff66', desc:'Storm auto-stunner.' },
  CHAOS_CANNON: { cat:'experimental', name:'CHAOS CANNON',  icon:'üé≤', dmg:[1,200],  rate:400,  speed:14, spread:.20, ammo:12, reload:1500, rarity:'legendary', proj:1, color:'#ff88ff', desc:'Random damage 1-200!' },
  OMEGA_BEAM:   { cat:'experimental', name:'OMEGA BEAM',    icon:'‚òÄÔ∏è', dmg:[80,120], rate:1200, speed:30, spread:.00, ammo:5,  reload:2800, rarity:'legendary', proj:1, laser:true, pierce:true, color:'#ffffff', desc:'Hitscan sun beam.' },
  VOID_CANNON:  { cat:'experimental', name:'VOID CANNON',   icon:'üåë', dmg:[60,90],  rate:900,  speed:10, spread:.02, ammo:4,  reload:2400, rarity:'legendary', proj:1, blackhole:true, pierce:true, color:'#660099', desc:'Void singularity shot.' },
  QUANTUM_GUN:  { cat:'experimental', name:'QUANTUM GUN',   icon:'‚öõÔ∏è', dmg:[35,100], rate:350,  speed:16, spread:.05, ammo:10, reload:2000, rarity:'legendary', proj:2, spread_mode:'fan', pierce:true, color:'#66ffcc', desc:'Quantum superposition.' },

  // ‚îÄ‚îÄ SHOTGUNS (15) ‚îÄ‚îÄ
  DB_SHOTGUN:   { cat:'shotgun', name:'DOUBLE BARREL',    icon:'üî´', dmg:[22,32],  rate:800,  speed:10, spread:.32, ammo:4,  reload:1800, rarity:'common',   proj:8,  color:'#ffaa55', desc:'Classic double barrel.' },
  COMBAT_SHOT:  { cat:'shotgun', name:'COMBAT SHOTGUN',   icon:'üî´', dmg:[18,26],  rate:500,  speed:11, spread:.25, ammo:8,  reload:2000, rarity:'common',   proj:8,  color:'#ff9933', desc:'Pump action. Reliable.' },
  AUTO_SHOT:    { cat:'shotgun', name:'AUTO SHOTGUN',     icon:'üî´', dmg:[14,20],  rate:300,  speed:10, spread:.28, ammo:10, reload:2200, rarity:'uncommon', proj:6,  auto:true, color:'#ff7722', desc:'Semi-auto shotgun.' },
  SLUG:         { cat:'shotgun', name:'SLUG CANNON',      icon:'üéØ', dmg:[70,100], rate:900,  speed:14, spread:.03, ammo:5,  reload:2000, rarity:'rare',     proj:1,  color:'#ffcc66', desc:'Single slug. Precise.' },
  FRAG_SHOT:    { cat:'shotgun', name:'FRAG SHOTGUN',     icon:'üí£', dmg:[20,30],  rate:700,  speed:10, spread:.30, ammo:6,  reload:2200, rarity:'rare',     proj:8,  explosive:true, explodeR:40, color:'#ff8833', desc:'Each pellet explodes.' },
  ICE_SHOT:     { cat:'shotgun', name:'CRYO SHOTGUN',     icon:'‚ùÑÔ∏è', dmg:[16,24],  rate:600,  speed:10, spread:.28, ammo:7,  reload:2100, rarity:'uncommon', proj:7,  effect:'freeze', color:'#88ccff', desc:'Freeze pellets.' },
  FIRE_SHOT:    { cat:'shotgun', name:'INCENDIARY SHOT',  icon:'üî•', dmg:[16,24],  rate:600,  speed:10, spread:.28, ammo:7,  reload:2100, rarity:'uncommon', proj:7,  effect:'burn',   color:'#ff6622', desc:'Incendiary pellets.' },
  WIDE_SHOT:    { cat:'shotgun', name:'WIDE BARREL',      icon:'üî´', dmg:[12,18],  rate:550,  speed:9,  spread:.50, ammo:6,  reload:2000, rarity:'uncommon', proj:12, color:'#ffbb44', desc:'Massive spread, 12 pellets.' },
  HEAVY_SHOT:   { cat:'shotgun', name:'HEAVY SHOTGUN',    icon:'üí•', dmg:[28,40],  rate:800,  speed:11, spread:.22, ammo:6,  reload:2400, rarity:'rare',     proj:8,  color:'#ff5500', desc:'High damage per pellet.' },
  PLASMA_SHOT:  { cat:'shotgun', name:'PLASMA SHOTGUN',   icon:'üîÆ', dmg:[18,28],  rate:500,  speed:10, spread:.30, ammo:8,  reload:2200, rarity:'rare',     proj:7,  effect:'burn',   color:'#ff44cc', desc:'Plasma burn pellets.' },
  VOID_SHOT:    { cat:'shotgun', name:'VOID SHOTGUN',     icon:'üåë', dmg:[24,36],  rate:600,  speed:10, spread:.26, ammo:6,  reload:2100, rarity:'epic',     proj:7,  effect:'poison', pierce:true, color:'#8833ff', desc:'Void pellets pierce.' },
  SCATTER_BOMB: { cat:'shotgun', name:'SCATTER BOMB',     icon:'üí£', dmg:[30,45],  rate:1100, speed:8,  spread:.35, ammo:4,  reload:2600, rarity:'epic',     proj:10, explosive:true, explodeR:30, color:'#ff8800', desc:'10 mini-explosions.' },
  DRAGON_SHOT:  { cat:'shotgun', name:'DRAGON SHOT',      icon:'üêâ', dmg:[20,30],  rate:450,  speed:9,  spread:.35, ammo:8,  reload:2300, rarity:'epic',     proj:8,  auto:true, effect:'burn', color:'#ff4400', desc:'Dragon breath auto.' },
  STAR_SCATTER: { cat:'shotgun', name:'STAR SCATTER',     icon:'‚ú®', dmg:[22,33],  rate:700,  speed:11, spread:.24, ammo:7,  reload:2200, rarity:'legendary',proj:8,  bouncy:1, crit:0.25, color:'#ffffaa', desc:'Pellets bounce once. Crit.' },
  OMEGA_SHOT:   { cat:'shotgun', name:'OMEGA SHOTGUN',    icon:'üåü', dmg:[35,52],  rate:600,  speed:12, spread:.20, ammo:8,  reload:2500, rarity:'legendary',proj:10, pierce:true, color:'#ffaa00', desc:'10-pierce legendary pellets.' },
};

// ‚îÄ‚îÄ ABILITY DEFINITIONS (100 abilities) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ABILITY_DEFS = {
  // ‚îÄ‚îÄ MOVEMENT (15) ‚îÄ‚îÄ
  DASH:           { name:'DASH',          icon:'üí®', cd:2500,  energyCost:20, duration:150,  rarity:'common',    color:'#4488ff', desc:'Burst of speed.' },
  DOUBLE_DASH:    { name:'DOUBLE DASH',   icon:'üí®', cd:3500,  energyCost:30, duration:150,  rarity:'uncommon',  color:'#6688ff', desc:'Dash twice rapidly.' },
  TELEPORT:       { name:'TELEPORT',      icon:'üåÄ', cd:4000,  energyCost:35,                rarity:'rare',      color:'#ff44ff', desc:'Teleport to cursor.' },
  BLINK:          { name:'BLINK',         icon:'‚ö°', cd:1800,  energyCost:25,                rarity:'uncommon',  color:'#aaccff', desc:'Short-range instant blink.' },
  SUPER_JUMP:     { name:'SUPER JUMP',    icon:'ü¶ò', cd:5000,  energyCost:30, duration:200,  rarity:'uncommon',  color:'#44ddff', desc:'Massive jump boost.' },
  PHASE_SHIFT:    { name:'PHASE SHIFT',   icon:'üëª', cd:6000,  energyCost:40, duration:2000, rarity:'rare',      color:'#aaaaff', desc:'Phase through walls.' },
  ROCKET_BOOST:   { name:'ROCKET BOOST',  icon:'üöÄ', cd:7000,  energyCost:45, duration:300,  rarity:'rare',      color:'#ff8833', desc:'Rocket-powered dash.' },
  WARP:           { name:'WARP JUMP',     icon:'üåä', cd:5500,  energyCost:35,                rarity:'rare',      color:'#44ffee', desc:'Warp 3√ó dash distance.' },
  GROUND_SLAM:    { name:'GROUND SLAM',   icon:'üí•', cd:4000,  energyCost:30,                rarity:'uncommon',  color:'#ff8800', desc:'Slam down for AOE.' },
  VAULT:          { name:'VAULT',         icon:'üèÉ', cd:3000,  energyCost:20, duration:200,  rarity:'common',    color:'#88ff88', desc:'Vault forward over gap.' },
  FLIP:           { name:'FLIP DODGE',    icon:'ü§∏', cd:2200,  energyCost:25, duration:180,  rarity:'common',    color:'#ffaa44', desc:'Flip dodge backwards.' },
  RUSH:           { name:'RUSH',          icon:'‚ö°', cd:4500,  energyCost:35, duration:400,  rarity:'rare',      color:'#ffff44', desc:'Unstoppable charge.' },
  SPEED_BURST:    { name:'SPEED BURST',   icon:'üí®', cd:6000,  energyCost:40, duration:3000, rarity:'rare',      color:'#44ffaa', desc:'Speed boost 3 seconds.' },
  SHADOW_STEP:    { name:'SHADOW STEP',   icon:'üåë', cd:3500,  energyCost:30,                rarity:'uncommon',  color:'#888888', desc:'Teleport behind enemy.' },
  AIR_DASH:       { name:'AIR DASH',      icon:'üå¨Ô∏è', cd:2800,  energyCost:25, duration:200,  rarity:'uncommon',  color:'#88ddff', desc:'Dash in any direction.' },

  // ‚îÄ‚îÄ DEFENSE (15) ‚îÄ‚îÄ
  SHIELD:         { name:'SHIELD',        icon:'üõ°Ô∏è', cd:8000,  energyCost:30, duration:2000, rarity:'uncommon',  color:'#44ccff', desc:'Block all bullets.' },
  REFLECT:        { name:'REFLECT',       icon:'ü™û', cd:9000,  energyCost:40, duration:1500, rarity:'epic',      color:'#ffffff', desc:'Reflect enemy bullets.' },
  IRON_SKIN:      { name:'IRON SKIN',     icon:'ü¶æ', cd:10000, energyCost:50, duration:3000, rarity:'rare',      color:'#aaaaaa', desc:'50% damage reduction.' },
  BARRIER:        { name:'BARRIER',       icon:'üî≤', cd:12000, energyCost:60, duration:2500, rarity:'rare',      color:'#4488aa', desc:'Impenetrable barrier.' },
  DODGE_ROLL:     { name:'DODGE ROLL',    icon:'üé≥', cd:3000,  energyCost:20, duration:200,  rarity:'common',    color:'#88aa88', desc:'Roll, invincible during.' },
  COUNTER:        { name:'COUNTER',       icon:'‚öîÔ∏è', cd:7000,  energyCost:35, duration:1000, rarity:'rare',      color:'#ff8844', desc:'Counter next attack.' },
  AEGIS:          { name:'AEGIS SHIELD',  icon:'üèõÔ∏è', cd:14000, energyCost:70, duration:4000, rarity:'epic',      color:'#aaeeee', desc:'Full aegis protection.' },
  DECOY:          { name:'DECOY',         icon:'üë§', cd:10000, energyCost:30, duration:3000, rarity:'rare',      color:'#ffaa44', desc:'Spawn decoy dummy.' },
  CLONE:          { name:'CLONE',         icon:'üë•', cd:12000, energyCost:50, duration:3000, rarity:'epic',      color:'#ff88ff', desc:'Clone absorbs hits.' },
  SHROUD:         { name:'SHROUD',        icon:'üå´Ô∏è', cd:9000,  energyCost:45, duration:2500, rarity:'rare',      color:'#888899', desc:'Become invisible briefly.' },
  THORNS:         { name:'THORNS',        icon:'üåµ', cd:8000,  energyCost:40, duration:3000, rarity:'uncommon',  color:'#44aa44', desc:'Reflect melee damage.' },
  NULLIFY:        { name:'NULLIFY',       icon:'‚õî', cd:11000, energyCost:55, duration:1500, rarity:'epic',      color:'#ff4444', desc:'Cancel next status.' },
  PHASE_ARMOR:    { name:'PHASE ARMOR',   icon:'üîÆ', cd:13000, energyCost:65, duration:2000, rarity:'epic',      color:'#8844ff', desc:'Phase armor absorbs.' },
  REGEN_FIELD:    { name:'REGEN FIELD',   icon:'üíö', cd:15000, energyCost:70, duration:5000, rarity:'legendary', color:'#44ff88', desc:'Regen HP 5 seconds.' },
  DIVINE_SHIELD:  { name:'DIVINE SHIELD', icon:'‚ú®', cd:18000, energyCost:80, duration:3000, rarity:'legendary', color:'#ffffee', desc:'Total invulnerability.' },

  // ‚îÄ‚îÄ OFFENSE (15) ‚îÄ‚îÄ
  GRENADE:        { name:'GRENADE',       icon:'üí£', cd:5000,  energyCost:15,                rarity:'common',    color:'#88ff44', desc:'Throw explosive.' },
  EMP:            { name:'EMP BLAST',     icon:'‚ö°', cd:12000, energyCost:45,                rarity:'epic',      color:'#ffff00', desc:'Stun enemy 2s.' },
  AIRSTRIKE:      { name:'AIRSTRIKE',     icon:'‚úàÔ∏è', cd:18000, energyCost:70,                rarity:'legendary', color:'#ff6600', desc:'Carpet bomb.' },
  BERSERK:        { name:'BERSERK',       icon:'üò°', cd:15000, energyCost:50, duration:4000, rarity:'epic',      color:'#ff2200', desc:'+100% dmg, tough mode.' },
  TURRET:         { name:'TURRET',        icon:'üî´', cd:16000, energyCost:65, duration:5000, rarity:'epic',      color:'#ffaa00', desc:'Deploy auto-turret.' },
  CLUSTER:        { name:'CLUSTER BOMB',  icon:'üí•', cd:14000, energyCost:60,                rarity:'rare',      color:'#ff8800', desc:'Cluster of explosions.' },
  POISON_CLOUD:   { name:'POISON CLOUD',  icon:'‚ò†Ô∏è', cd:10000, energyCost:40, duration:4000, rarity:'rare',      color:'#44ff44', desc:'Toxic cloud area.' },
  CHAIN_LIGHTNING:{ name:'CHAIN LIGHTNING',icon:'‚ö°', cd:11000, energyCost:50,               rarity:'rare',      color:'#ffff88', desc:'Lightning chains enemy.' },
  FREEZE_BOMB:    { name:'FREEZE BOMB',   icon:'‚ùÑÔ∏è', cd:9000,  energyCost:40,                rarity:'rare',      color:'#44aaff', desc:'Cryo bomb freeze burst.' },
  FIRE_STORM:     { name:'FIRE STORM',    icon:'üî•', cd:13000, energyCost:55, duration:3000, rarity:'epic',      color:'#ff4400', desc:'Fire rain around you.' },
  VOID_STRIKE:    { name:'VOID STRIKE',   icon:'üåë', cd:12000, energyCost:55,                rarity:'epic',      color:'#6600cc', desc:'Void energy strike.' },
  SUMMON_BLADES:  { name:'SUMMON BLADES', icon:'‚öîÔ∏è', cd:14000, energyCost:60, duration:3000, rarity:'epic',      color:'#ccccff', desc:'Orbit blades around you.' },
  METEOR:         { name:'METEOR',        icon:'‚òÑÔ∏è', cd:16000, energyCost:65,                rarity:'legendary', color:'#ff8822', desc:'Call down meteor.' },
  NOVA_BLAST:     { name:'NOVA BLAST',    icon:'üí´', cd:20000, energyCost:80,                rarity:'legendary', color:'#ffffaa', desc:'360¬∞ energy nova.' },
  JUDGEMENT:      { name:'JUDGEMENT',     icon:'‚ö°', cd:25000, energyCost:90,                rarity:'legendary', color:'#ffffff', desc:'Instant kill if enemy<30%.' },

  // ‚îÄ‚îÄ HEALING (10) ‚îÄ‚îÄ
  HEAL:           { name:'HEAL',          icon:'üíä', cd:14000, energyCost:60,                rarity:'uncommon',  color:'#40ff80', desc:'Restore 40 HP.' },
  BIG_HEAL:       { name:'BIG HEAL',      icon:'üíâ', cd:18000, energyCost:75,                rarity:'rare',      color:'#40ff80', desc:'Restore 70 HP.' },
  LIFE_LEECH:     { name:'LIFE LEECH',    icon:'üßõ', cd:10000, energyCost:45, duration:5000, rarity:'rare',      color:'#ff44aa', desc:'15% lifesteal 5 sec.' },
  BLOOD_PACT:     { name:'BLOOD PACT',    icon:'ü©∏', cd:8000,  energyCost:30,                rarity:'uncommon',  color:'#ff2244', desc:'Trade HP for energy.' },
  MEDPACK:        { name:'MEDPACK',       icon:'üè•', cd:12000, energyCost:40,                rarity:'common',    color:'#44ff88', desc:'Drop medpack.' },
  PHOENIX:        { name:'PHOENIX',       icon:'üê¶', cd:30000, energyCost:80,                rarity:'legendary', color:'#ffaa44', desc:'Revive once per game.' },
  TRANSFUSION:    { name:'TRANSFUSION',   icon:'ü©∏', cd:9000,  energyCost:50,                rarity:'uncommon',  color:'#ff6688', desc:'Convert enemy HP to yours.' },
  ADRENALINE:     { name:'ADRENALINE',    icon:'üí™', cd:11000, energyCost:45, duration:3000, rarity:'rare',      color:'#ffcc44', desc:'Adrenaline burst ‚Äî regen speed.' },
  SOUL_DRAIN:     { name:'SOUL DRAIN',    icon:'üíÄ', cd:13000, energyCost:55,                rarity:'epic',      color:'#aa44ff', desc:'Drain 30 HP from enemy.' },
  MASS_REGEN:     { name:'MASS REGEN',    icon:'üíö', cd:20000, energyCost:70, duration:8000, rarity:'legendary', color:'#22ff88', desc:'Regen 5HP/sec for 8s.' },

  // ‚îÄ‚îÄ UTILITY (15) ‚îÄ‚îÄ
  TIME_SLOW:      { name:'TIME SLOW',     icon:'‚è≥', cd:12000, energyCost:20, duration:5000, rarity:'rare',      color:'#b060ff', desc:'Slow world to 20%.' },
  WARP_FIELD:     { name:'WARP FIELD',    icon:'üåä', cd:20000, energyCost:80, duration:5000, rarity:'legendary', color:'#ff00ff', desc:'Bullets gravitate to cursor.' },
  SCAN:           { name:'SCAN',          icon:'üëÅÔ∏è', cd:6000,  energyCost:20, duration:4000, rarity:'common',    color:'#44ddff', desc:'Reveal enemy position.' },
  OVERLOAD:       { name:'OVERLOAD',      icon:'‚ö°', cd:8000,  energyCost:35,                rarity:'uncommon',  color:'#ffff88', desc:'Overload, refill ammo.' },
  RELOAD_BOOST:   { name:'RELOAD BOOST',  icon:'‚ü≥',  cd:5000,  energyCost:25, duration:3000, rarity:'common',    color:'#88aaff', desc:'2√ó reload speed 3s.' },
  AMMO_SUPPLY:    { name:'AMMO SUPPLY',   icon:'üì¶', cd:12000, energyCost:30,                rarity:'uncommon',  color:'#ffcc88', desc:'Full ammo refill.' },
  ENERGY_BURST:   { name:'ENERGY BURST',  icon:'‚ö°', cd:9000,  energyCost:0,                 rarity:'uncommon',  color:'#8888ff', desc:'Instant full energy.' },
  COUNTER_HACK:   { name:'COUNTER HACK',  icon:'üíª', cd:14000, energyCost:50,                rarity:'rare',      color:'#44ffaa', desc:'Disable enemy ability 5s.' },
  TIME_LOCK:      { name:'TIME LOCK',     icon:'üîí', cd:15000, energyCost:60,                rarity:'epic',      color:'#aa88ff', desc:'Freeze enemy in time 3s.' },
  DISPLACE:       { name:'DISPLACE',      icon:'üîÑ', cd:7000,  energyCost:35,                rarity:'rare',      color:'#ff88cc', desc:'Swap places with enemy.' },
  GRAVITY_WELL:   { name:'GRAVITY WELL',  icon:'üåç', cd:12000, energyCost:50, duration:3000, rarity:'rare',      color:'#4466ff', desc:'Gravity pull enemy toward you.' },
  MIRROR_IMAGE:   { name:'MIRROR IMAGE',  icon:'ü™û', cd:11000, energyCost:45, duration:4000, rarity:'epic',      color:'#ccddff', desc:'Mirror copy confuses AI.' },
  OVERCHARGE:     { name:'OVERCHARGE',    icon:'üîã', cd:10000, energyCost:60, duration:3000, rarity:'epic',      color:'#ffee44', desc:'+50% bullet dmg 3s.' },
  QUANTUM_LOCK:   { name:'QUANTUM LOCK',  icon:'‚öõÔ∏è', cd:18000, energyCost:75, duration:2000, rarity:'legendary', color:'#44ffff', desc:'Freeze time for enemy only.' },
  OMNISLASH:      { name:'OMNISLASH',     icon:'üåü', cd:22000, energyCost:85,                rarity:'legendary', color:'#ffdd44', desc:'Hit enemy 10 times instantly.' },

  // ‚îÄ‚îÄ PASSIVE (15) ‚îÄ‚îÄ
  DOUBLE_JUMP:    { name:'DOUBLE JUMP',   icon:'‚¨ÜÔ∏è', cd:0,     energyCost:0,  passive:true,  rarity:'uncommon',  color:'#44aaff', desc:'Jump again in midair.' },
  WALL_CLING:     { name:'WALL CLING',    icon:'üß≤', cd:0,     energyCost:0,  passive:true,  rarity:'common',    color:'#aa8855', desc:'Cling to walls.' },
  REGEN_PASSIVE:  { name:'PASSIVE REGEN', icon:'üíö', cd:0,     energyCost:0,  passive:true,  rarity:'uncommon',  color:'#44ff88', desc:'Slowly regen HP.' },
  CRIT_BOOST:     { name:'CRIT BOOST',    icon:'üéØ', cd:0,     energyCost:0,  passive:true,  rarity:'rare',      color:'#ffff44', desc:'+15% crit chance.' },
  ARMOR:          { name:'TOUGH SKIN',    icon:'ü¶æ', cd:0,     energyCost:0,  passive:true,  rarity:'common',    color:'#888888', desc:'20% damage reduction.' },
  SPEED_PASSIVE:  { name:'SPEED DEMON',   icon:'üëü', cd:0,     energyCost:0,  passive:true,  rarity:'uncommon',  color:'#ffaa44', desc:'+30% move speed.' },
  ENERGY_REGEN:   { name:'ENERGY REGEN',  icon:'‚ö°', cd:0,     energyCost:0,  passive:true,  rarity:'common',    color:'#4488ff', desc:'2√ó energy regen rate.' },
  COMBO_MASTER:   { name:'COMBO MASTER',  icon:'üé≠', cd:0,     energyCost:0,  passive:true,  rarity:'rare',      color:'#ff88ff', desc:'Combos last 50% longer.' },
  AMMO_SAVER:     { name:'AMMO SAVER',    icon:'üìå', cd:0,     energyCost:0,  passive:true,  rarity:'uncommon',  color:'#aaffaa', desc:'20% chance no ammo use.' },
  DEFLECT:        { name:'DEFLECT',       icon:'üõ°Ô∏è', cd:0,     energyCost:0,  passive:true,  rarity:'rare',      color:'#44ccff', desc:'10% chance deflect bullet.' },
  BLOODLUST:      { name:'BLOODLUST',     icon:'ü©∏', cd:0,     energyCost:0,  passive:true,  rarity:'epic',      color:'#ff4444', desc:'Kills restore 10 HP.' },
  HASTE:          { name:'HASTE',         icon:'‚ö°', cd:0,     energyCost:0,  passive:true,  rarity:'epic',      color:'#ffff00', desc:'30% reduced ability CDs.' },
  TITAN:          { name:'TITAN',         icon:'üèîÔ∏è', cd:0,     energyCost:0,  passive:true,  rarity:'legendary', color:'#aaaaaa', desc:'HP cap +50, armor +30%.' },
  PHANTOM_PASSIVE:{ name:'PHANTOM',       icon:'üëª', cd:0,     energyCost:0,  passive:true,  rarity:'legendary', color:'#8888ff', desc:'25% dodge chance.' },
  GODLIKE:        { name:'GODLIKE',       icon:'‚≠ê', cd:0,     energyCost:0,  passive:true,  rarity:'legendary', color:'#ffd060', desc:'All stats +20%.' },

  // ‚îÄ‚îÄ SPECIAL (15) ‚îÄ‚îÄ
  REWIND:         { name:'REWIND',        icon:'‚è™', cd:16000, energyCost:70,                rarity:'epic',      color:'#aa88ff', desc:'Rewind position 3s back.' },
  COPY_CAT:       { name:'COPY CAT',      icon:'üê±', cd:14000, energyCost:60,                rarity:'epic',      color:'#ffaa88', desc:'Copy enemy last ability.' },
  SACRIFICE:      { name:'SACRIFICE',     icon:'üíÄ', cd:5000,  energyCost:0,                 rarity:'rare',      color:'#ff0000', desc:'Spend 25 HP for 50 energy.' },
  SECOND_WIND:    { name:'SECOND WIND',   icon:'üå¨Ô∏è', cd:20000, energyCost:0,  passive:true,  rarity:'legendary', color:'#aaffaa', desc:'Auto-revive at 1 HP once.' },
  RAGE:           { name:'RAGE',          icon:'üí¢', cd:12000, energyCost:0,  duration:4000, rarity:'rare',      color:'#ff4400', desc:'More dmg as HP decreases.' },
  LAST_STAND:     { name:'LAST STAND',    icon:'üè≥Ô∏è', cd:0,     energyCost:0,  passive:true,  rarity:'epic',      color:'#ff8800', desc:'+75% dmg when below 25 HP.' },
  VENGEANCE:      { name:'VENGEANCE',     icon:'üò§', cd:10000, energyCost:40, duration:3000, rarity:'rare',      color:'#ff6644', desc:'Return 50% dmg to attacker.' },
  WILD_CARD:      { name:'WILD CARD',     icon:'üÉè', cd:8000,  energyCost:30,                rarity:'rare',      color:'#ff88cc', desc:'Random ability triggered.' },
  STATIC_FIELD:   { name:'STATIC FIELD',  icon:'‚ö°', cd:9000,  energyCost:40, duration:3000, rarity:'rare',      color:'#ffff66', desc:'Nearby bullets slow down.' },
  ANCHOR:         { name:'ANCHOR',        icon:'‚öì', cd:11000, energyCost:45, duration:2000, rarity:'uncommon',  color:'#4488aa', desc:'Lock enemy in place.' },
  NANO_SWARM:     { name:'NANO SWARM',    icon:'üêù', cd:14000, energyCost:55, duration:4000, rarity:'epic',      color:'#aaff44', desc:'Nanobots burn enemy over time.' },
  BULLET_TIME:    { name:'BULLET TIME',   icon:'üéØ', cd:18000, energyCost:60, duration:3000, rarity:'legendary', color:'#ccffff', desc:'You move, world frozen.' },
  SOUL_LINK:      { name:'SOUL LINK',     icon:'üíû', cd:12000, energyCost:50, duration:5000, rarity:'epic',      color:'#ff88aa', desc:'Link HP ‚Äî dmg splits both.' },
  MATRIX:         { name:'MATRIX',        icon:'üü©', cd:20000, energyCost:75, duration:4000, rarity:'legendary', color:'#00ff44', desc:'Dodge all bullets 4s.' },
  APOCALYPSE:     { name:'APOCALYPSE',    icon:'üåã', cd:30000, energyCost:100,               rarity:'legendary', color:'#ff2200', desc:'Full arena destruction.' },
};

// ‚îÄ‚îÄ MAP THEMES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MAP_THEMES = [
  { id:'neon',     name:'NEON CITY',    sky:['#040010','#080018'], ground:'#0a0020', plat:'#1a0040', platTop:'#6020ff', star:true,  rain:false, glow:'#6020ff' },
  { id:'wasteland',name:'WASTELAND',    sky:['#120806','#1e1006'], ground:'#1a0e04', plat:'#3a1e08', platTop:'#804020', star:false, dust:true,  glow:'#ff6020' },
  { id:'void',     name:'THE VOID',     sky:['#000008','#000010'], ground:'#050510', plat:'#0a0a20', platTop:'#2020ff', star:true,  rain:false, glow:'#2040ff' },
  { id:'jungle',   name:'CYBER JUNGLE', sky:['#041008','#081a0c'], ground:'#0a1e08', plat:'#0f2a0a', platTop:'#20cc40', star:false, rain:true,  glow:'#20cc40' },
  { id:'ice',      name:'FROZEN HELL',  sky:['#080e18','#0c1624'], ground:'#0e1a28', plat:'#1a2e40', platTop:'#60aaff', star:true,  rain:false, glow:'#60aaff' },
  { id:'lava',     name:'LAVA CORE',    sky:['#180604','#200a02'], ground:'#1a0800', plat:'#300c04', platTop:'#ff4400', star:false, rain:false, glow:'#ff4400' },
  { id:'glitch',   name:'GLITCH ZONE',  sky:['#080010','#100018'], ground:'#0a0010', plat:'#1a0028', platTop:'#ff00ff', star:true,  rain:false, glitch:true, glow:'#ff00ff' },
  { id:'space',    name:'DEEP SPACE',   sky:['#000000','#020208'], ground:'#050508', plat:'#0a0a18', platTop:'#4444ff', star:true,  rain:false, glow:'#4444ff' },
  { id:'storm',    name:'STORM WORLD',  sky:['#101020','#181828'], ground:'#0e0e1e', plat:'#202030', platTop:'#ffff44', star:false, rain:true,  glow:'#ffff44' },
  { id:'inferno',  name:'INFERNO',      sky:['#1a0400','#240600'], ground:'#1e0600', plat:'#360800', platTop:'#ff6600', star:false, dust:true,  glow:'#ff6600' },
];

// ‚îÄ‚îÄ MODIFIERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MODIFIER_DEFS = [
  { id:'low_grav',      icon:'üåô', name:'LOW GRAVITY',   desc:'Gravity 50%',          color:'#88aaff' },
  { id:'double_speed',  icon:'‚ö°', name:'DOUBLE SPEED',  desc:'Move 2√ó faster',       color:'#ffff44' },
  { id:'fog',           icon:'üå´Ô∏è', name:'FOG OF WAR',    desc:'Limited visibility',   color:'#aaaaaa' },
  { id:'glass_cannon',  icon:'üíé', name:'GLASS CANNON',  desc:'+100% dmg dealt/taken',color:'#44ffcc' },
  { id:'infinite_ammo', icon:'‚àû',  name:'INFINITE AMMO', desc:'No reloading!',        color:'#40ff80' },
  { id:'giant_heads',   icon:'üóø', name:'BIG HEAD MODE', desc:'Crit hitbox 3√ó larger',color:'#ff8844' },
  { id:'one_shot',      icon:'üíÄ', name:'ONE SHOT MODE', desc:'Instant kill on crit', color:'#ff2244' },
  { id:'shield_leech',  icon:'üßõ', name:'LIFE STEAL',    desc:'10% dmg dealt heals',  color:'#ff44aa' },
  { id:'super_jump',    icon:'ü¶ò', name:'SUPER JUMP',    desc:'Jump 2√ó higher',       color:'#44ddff' },
  { id:'bullet_rain',   icon:'üåßÔ∏è', name:'BULLET RAIN',   desc:'Enemy fires 50% faster',color:'#ff6060'},
  { id:'chaos_mode',    icon:'üé≤', name:'CHAOS MODE',    desc:'Random effects every 5s',color:'#ff88ff'},
  { id:'magnet_bullets',icon:'üß≤', name:'HOMING SHOTS',  desc:'Bullets slightly home', color:'#44aaff'},
];

// ‚îÄ‚îÄ RARITY COLORS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const RARITY_COLORS = { common:'#aaaaaa', uncommon:'#40e080', rare:'#3c8eff', epic:'#b060ff', legendary:'#ffd060' };

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let selectedDiff = 'normal';
let rerollsLeft = 1;
let currentLobby = null;
let gameState = null;
let animId = null;

// ‚îÄ‚îÄ DIFFICULTY CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DIFF_CONFIG = {
  easy:   { aimError:80, reactionMs:800, aggression:0.4, retreatDist:60,  dodgeChance:0.05, strategyChange:3000, hpMult:0.8, label:'EASY',   color:'#40e080' },
  normal: { aimError:40, reactionMs:450, aggression:0.6, retreatDist:80,  dodgeChance:0.12, strategyChange:2000, hpMult:1.0, label:'NORMAL', color:'#ffd060' },
  hard:   { aimError:18, reactionMs:250, aggression:0.75,retreatDist:100, dodgeChance:0.22, strategyChange:1400, hpMult:1.3, label:'HARD',   color:'#ff8030' },
  insane: { aimError:5,  reactionMs:80,  aggression:0.95,retreatDist:130, dodgeChance:0.40, strategyChange:800,  hpMult:1.7, label:'INSANE', color:'#ff3c6e' },
};

// ‚îÄ‚îÄ UTILITY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const rnd = (a,b) => a + Math.random()*(b-a);
const rndInt = (a,b) => Math.floor(rnd(a,b+1));
const pick = arr => arr[Math.floor(Math.random()*arr.length)];
const clamp = (v,a,b) => Math.max(a,Math.min(b,v));

function weightedPick(pool, defs) {
  const weights = { common:50, uncommon:28, rare:14, epic:6, legendary:2 };
  if (PROG.unlocked.includes('legendary_boost')) weights.legendary += 5;
  const total = pool.reduce((s,k) => s + (weights[defs[k]?.rarity]||1), 0);
  let r = Math.random()*total;
  for (const k of pool) {
    r -= weights[defs[k]?.rarity]||1;
    if (r <= 0) return k;
  }
  return pool[0];
}

// ‚îÄ‚îÄ SCREEN MANAGEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showScreen(id) {
  document.querySelectorAll('[id^="screen-"]').forEach(s=>s.classList.remove('active'));
  document.getElementById('screen-'+id).classList.add('active');
}
function setDiff(btn) {
  document.querySelectorAll('.diff-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  selectedDiff = btn.dataset.d;
}
function showProgression() {
  const xpPerLevel = 500 + PROG.level*200;
  document.getElementById('level-num').textContent = PROG.level;
  document.getElementById('xp-cur').textContent = PROG.xp;
  document.getElementById('xp-next').textContent = xpPerLevel;
  document.getElementById('xp-bar').style.width = (PROG.xp/xpPerLevel*100)+'%';
  const grid = document.getElementById('unlocks-grid');
  grid.innerHTML = UNLOCK_LIST.map(u=>`
    <div class="unlock-badge ${PROG.level>=u.req?'done':''}">
      ${u.name}<br><span style="color:#555;font-size:10px;font-family:'Rajdhani',sans-serif">${PROG.level>=u.req?'‚úì UNLOCKED':'LV'+u.req}</span>
    </div>`).join('');
  document.getElementById('prog-panel').style.display='block';
}

// ‚îÄ‚îÄ LOBBY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _baseGotoLobby() {
  rerollsLeft = PROG.unlocked.includes('reroll2') ? 2 : 1;
  rollLobby();
  showScreen('lobby');
}
function _baseRollLobby() {
  const theme = pick(MAP_THEMES);
  document.getElementById('map-theme-label').textContent = 'MAP: '+theme.name;
  drawMapPreview(theme);

  const allWepKeys = Object.keys(WEAPON_DEFS);
  const playerWeapons = [];
  const usedCats = new Set();
  const weapCount = 2 + (PROG.level >= 6 ? 1 : 0);
  let attempts = 0;
  while (playerWeapons.length < weapCount && attempts < 200) {
    attempts++;
    const k = weightedPick(allWepKeys, WEAPON_DEFS);
    const def = WEAPON_DEFS[k];
    if (!def) continue;
    if (!usedCats.has(def.cat)) { playerWeapons.push(k); usedCats.add(def.cat); }
  }

  const allAbilKeys = Object.keys(ABILITY_DEFS);
  const playerAbils = [];
  const abilCount = PROG.unlocked.includes('ability4') ? 4 : rndInt(2,3);
  attempts = 0;
  while (playerAbils.length < abilCount && attempts < 200) {
    attempts++;
    const k = weightedPick(allAbilKeys, ABILITY_DEFS);
    if (!playerAbils.includes(k)) playerAbils.push(k);
  }

  const enemyWeapons = [];
  const eUsedCats = new Set();
  attempts = 0;
  while (enemyWeapons.length < 2 && attempts < 200) {
    attempts++;
    const k = weightedPick(allWepKeys, WEAPON_DEFS);
    const def = WEAPON_DEFS[k];
    if (!def) continue;
    // Avoid passive-only or experimental for enemy (keep it fair)
    if (!eUsedCats.has(def.cat) && def.cat !== 'experimental') { enemyWeapons.push(k); eUsedCats.add(def.cat); }
  }
  // Fallback: if enemy weapons empty, give defaults
  if (enemyWeapons.length === 0) enemyWeapons.push('AR');
  if (enemyWeapons.length === 1) enemyWeapons.push('PISTOL');

  const mods = [];
  const modCount = rndInt(1,2);
  let mattempts = 0;
  while (mods.length < modCount && mattempts < 50) {
    mattempts++;
    const m = pick(MODIFIER_DEFS);
    if (!mods.find(x=>x.id===m.id)) mods.push(m);
  }

  currentLobby = { theme, playerWeapons, playerAbils, enemyWeapons, mods };
  renderLobby();
}
function rerollLobby() {
  if (rerollsLeft <= 0) return;
  rerollsLeft--;
  document.getElementById('rerolls-left').textContent = rerollsLeft;
  rollLobby();
}
function renderLobby() {
  const { playerWeapons, playerAbils, enemyWeapons, mods } = currentLobby;
  document.getElementById('lobby-weapons').innerHTML = playerWeapons.map(k=>{
    const d=WEAPON_DEFS[k];
    if(!d) return `<div class="rng-item"><div class="item-icon">‚öîÔ∏è</div><div class="item-info"><div class="item-name">${k}</div></div></div>`;
    return `<div class="rng-item"><div class="item-icon">${d.icon}</div><div class="item-info"><div class="item-name">${d.name}</div><div class="item-desc">${d.desc} | DMG:${d.dmg[0]}-${d.dmg[1]}</div></div><div class="rarity ${d.rarity}" style="color:${RARITY_COLORS[d.rarity]}">${d.rarity.toUpperCase()}</div></div>`;
  }).join('');
  document.getElementById('lobby-abilities').innerHTML = playerAbils.map((k,i)=>{
    const d=ABILITY_DEFS[k];
    if(!d) return '';
    return `<div class="rng-item"><div class="item-icon">${d.icon}</div><div class="item-info"><div class="item-name">[${i+1}] ${d.name}</div><div class="item-desc">${d.desc}</div></div><div class="rarity ${d.rarity}" style="color:${RARITY_COLORS[d.rarity]||'#aaa'}">${(d.rarity||'common').toUpperCase()}</div></div>`;
  }).join('');
  // Hero class badge
  const hero = getHeroClass();
  if (hero) {
    const heroDiv = document.createElement('div');
    heroDiv.style.cssText = 'border:1px solid '+hero.color+';padding:4px 8px;margin-bottom:8px;color:'+hero.color+';font-size:8px;font-family:"Orbitron",monospace;font-weight:700;';
    heroDiv.textContent = hero.icon + ' ' + hero.name + ' ‚Äî ' + hero.role;
    const lwContainer = document.getElementById('lobby-weapons');
    lwContainer.parentNode.insertBefore(heroDiv, lwContainer);
  }
  document.getElementById('lobby-enemy').innerHTML = enemyWeapons.map(k=>{
    const d=WEAPON_DEFS[k];
    if(!d) return '';
    return `<div class="rng-item"><div class="item-icon">${d.icon}</div><div class="item-info"><div class="item-name">${d.name}</div><div class="item-desc">${d.rarity.toUpperCase()} | ${d.cat.toUpperCase()}</div></div></div>`;
  }).join('');
  const dc=DIFF_CONFIG[selectedDiff];
  document.getElementById('lobby-diff').innerHTML=`<span style="color:${dc.color}">‚óÜ ${dc.label}</span>`;
  document.getElementById('lobby-modifiers').innerHTML=mods.map(m=>`<div class="modifier-chip"><span style="font-size:14px">${m.icon}</span>${m.name}</div>`).join('');
}
function drawMapPreview(theme) {
  const c=document.getElementById('map-preview-canvas');
  const cx=c.getContext('2d');
  const W2=240,H2=80;
  const sg=cx.createLinearGradient(0,0,0,H2);
  sg.addColorStop(0,theme.sky[0]); sg.addColorStop(1,theme.sky[1]);
  cx.fillStyle=sg; cx.fillRect(0,0,W2,H2);
  cx.fillStyle=theme.plat;
  [[0,60,W2,20],[40,42,70,8],[110,34,70,8],[180,42,60,8]].forEach(([x,y,w,h])=>{
    cx.fillRect(x,y,w,h);
    cx.fillStyle=theme.platTop; cx.fillRect(x,y,w,2); cx.fillStyle=theme.plat;
  });
}

// ‚îÄ‚îÄ START ROUND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startRound() {
  if (!currentLobby) return;
  showScreen('game');
  initGame(currentLobby);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME ENGINE ‚Äî core unchanged from working version
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const canvas = document.getElementById('gcanvas');
const ctx = canvas.getContext('2d');
ctx.imageSmoothingEnabled = false;
const W=900, H=480;

let GS = null;

function _baseInitGame(lobby) {
  if (animId) cancelAnimationFrame(animId);

  const diff = DIFF_CONFIG[selectedDiff];
  const mods = lobby.mods;
  const hasMod = id => mods.some(m=>m.id===id);
  const baseHp = PROG.unlocked.includes('start_hp') ? 120 : 100;

  const pWeapons = lobby.playerWeapons.map(k => {
    const d = {...WEAPON_DEFS[k]};
    d.ammoLeft = isFinite(d.ammo) ? d.ammo : Infinity;
    d.maxAmmo = d.ammoLeft;
    d.key = k;
    d.reloading = false; d.reloadEnd = 0; d.lastShot = 0;
    d.spinLevel = 0; d.burstCount = 0; d.burstNext = 0;
    if (hasMod('infinite_ammo')) d.ammoLeft = Infinity;
    return d;
  });

  const pAbils = lobby.playerAbils.map((k,i) => ({
    key: k, def: ABILITY_DEFS[k],
    cd: 0, active: false, activeEnd: 0, slot: i
  }));

  const eWeapons = lobby.enemyWeapons.map(k => {
    const d = {...WEAPON_DEFS[k]};
    d.ammoLeft = isFinite(d.ammo) ? d.ammo : Infinity;
    d.maxAmmo = d.ammoLeft;
    d.key = k;
    d.reloading = false; d.reloadEnd = 0; d.lastShot = 0;
    d.spinLevel = 0;
    if (hasMod('bullet_rain')) d.rate = Math.floor(d.rate * 0.6);
    return d;
  });

  const platforms = generatePlatforms();

  const gravMult   = hasMod('low_grav')      ? 0.45 : 1;
  const speedMult  = hasMod('double_speed')  ? 2    : 1;
  const jumpMult   = hasMod('super_jump')    ? 1.7  : 1;
  const glassCannon= hasMod('glass_cannon');
  const lifeSteal  = hasMod('shield_leech');
  const bigHead    = hasMod('giant_heads');
  const oneShot    = hasMod('one_shot');

  GS = {
    lobby, diff, theme: lobby.theme,
    score:0, wave:1, combo:0, comboTimer:0,
    running:true, paused:false,
    mods, hasMod, gravMult, speedMult, jumpMult, glassCannon, lifeSteal, bigHead, oneShot,
    platforms,
    bullets:[], particles:[], explosions:[], damageNums:[], blackholes:[], decoys:[],
    timeSlow:false, timeSlowEnd:0,
    bgParticles: generateBgParticles(lobby.theme),
    overchargeEnd: 0,

    player: {
      x:140, y:350, w:18, h:28,
      vx:0, vy:0, onGround:false, facing:1,
      hp: baseHp*(glassCannon?0.6:1), maxHp: baseHp*(glassCannon?0.6:1),
      energy:100, maxEnergy:100,
      weapons:pWeapons, weapIdx:0,
      abilities:pAbils,
      statuses:[],
      invincible:0,
      dashing:false, dashTimer:0, dashVx:0,
      reflecting:false, reflectEnd:0,
      berserk:false, berserkEnd:0,
      decoyActive:false,
      mheld:false,
    },

    enemy: {
      x:720, y:350, w:18, h:28,
      vx:0, vy:0, onGround:false, facing:-1,
      hp: 150 * diff.hpMult,
      maxHp: 150 * diff.hpMult,
      weapons:eWeapons, weapIdx:0,
      statuses:[],
      invincible:0,
      ai: {
        state:'idle', stateTimer:0, stratTimer:diff.strategyChange,
        jumpCd:0, dodgeCd:0, lastSawPlayer:0,
        aimOffset:{x:0,y:0}, aimUpdateTimer:0,
        reactionBuffer:[],
      },
    },

    keys:{}, mouse:{x:450,y:240,down:false},
    lastTime:0,
    fogMod: hasMod('fog'),
  };

  setupHUD(GS);
  setupInput(GS);
  document.getElementById('fog-overlay').style.display = GS.fogMod ? 'block' : 'none';

  lastTime = performance.now();
  animId = requestAnimationFrame(gameLoop);
}

function generatePlatforms() {
  const FLOOR = 380;
  const plats = [{ x:0, y:FLOOR+28, w:W, h:100, ground:true }];
  const configs = [[130,300],[370,258],[620,300],[255,198],[505,198],[780,260],[50,200]];
  configs.forEach(([px,py]) => {
    const pw = rndInt(110,160);
    plats.push({ x:px, y:py, w:pw, h:14 });
  });
  return plats;
}

function generateBgParticles(theme) {
  const particles = [];
  if (theme.star || theme.rain || theme.dust) {
    for (let i=0;i<60;i++) {
      particles.push({
        x:rnd(0,W), y:rnd(0,H),
        vx: theme.rain?rnd(-0.5,-0.2):theme.dust?rnd(-0.3,0.3):0,
        vy: theme.rain?rnd(1.5,3):theme.dust?rnd(-0.1,0.2):0,
        size: theme.star?(Math.random()<0.1?2:1):1.5,
        alpha: rnd(0.2,0.8), type: theme.rain?'rain':theme.dust?'dust':'star'
      });
    }
  }
  return particles;
}

// ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setupInput(gs) {
  document.onkeydown = e => {
    if (!gs.running) return;
    gs.keys[e.code] = true;
    if (e.code==='KeyQ') gs.player.weapIdx = (gs.player.weapIdx+1)%gs.player.weapons.length;
    if (e.code==='KeyR') {
      const w=gs.player.weapons[gs.player.weapIdx];
      if (!w.reloading && isFinite(w.maxAmmo) && w.ammoLeft<w.maxAmmo) {
        w.reloading=true; w.reloadEnd=Date.now()+w.reload;
      }
    }
    if (['Digit1','Digit2','Digit3','Digit4'].includes(e.code)) {
      const idx=parseInt(e.code.replace('Digit',''))-1;
      if (gs.player.abilities[idx]) activateAbility(gs,idx);
    }
    if (e.code==='KeyX') meleePunch(gs);
    e.preventDefault?.();
  };
  document.onkeyup = e => { gs.keys[e.code]=false; };
  canvas.onmousemove = e => {
    const r=canvas.getBoundingClientRect();
    gs.mouse.x=e.clientX-r.left; gs.mouse.y=e.clientY-r.top;
  };
  canvas.onmousedown = e => { gs.mouse.down=true; e.preventDefault(); };
  canvas.onmouseup = () => { gs.mouse.down=false; };
}

// ‚îÄ‚îÄ ABILITY ACTIVATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _baseActivateAbility(gs, idx) {
  const ab = gs.player.abilities[idx];
  if (!ab || !ab.def) return;
  if (ab.def.passive) return; // passive abilities don't activate
  if (ab.cd > 0) return;
  if (gs.player.energy < ab.def.energyCost) return;
  gs.player.energy -= ab.def.energyCost;
  ab.cd = ab.def.cd || 5000;

  const k = ab.key;
  const p = gs.player;

  // ‚îÄ‚îÄ MOVEMENT ABILITIES ‚îÄ‚îÄ
  if (k==='DASH'||k==='DOUBLE_DASH') {
    p.dashing=true; p.dashTimer=150; p.dashVx=p.facing*14*gs.speedMult;
    if (k==='DOUBLE_DASH') { setTimeout(()=>{ p.dashing=true; p.dashTimer=150; p.dashVx=p.facing*14*gs.speedMult; },220); }
    burst(p.x+9,p.y+14,'#4488ff',8,3);
  }
  else if (k==='TELEPORT'||k==='BLINK') {
    const range = k==='BLINK' ? 120 : Infinity;
    const dx2=gs.mouse.x-p.x-9, dy2=gs.mouse.y-p.y-14;
    const len2=Math.sqrt(dx2*dx2+dy2*dy2)||1;
    const dist2=Math.min(len2, range);
    p.x=clamp(p.x+dx2/len2*dist2,0,W-p.w);
    p.y=clamp(p.y+dy2/len2*dist2,0,H-p.h);
    p.vy=0; burst(p.x+9,p.y+14,'#ff44ff',14,5); kf('üåÄ TELEPORT','info');
  }
  else if (k==='SUPER_JUMP') { if (p.onGround||true) { p.vy=-20*gs.jumpMult; burst(p.x+9,p.y+p.h,'#44ddff',10,3); } }
  else if (k==='GROUND_SLAM') {
    p.vy=18; p.vx=0;
    setTimeout(()=>{
      const d2=Math.sqrt((gs.enemy.x-p.x)**2+(gs.enemy.y-p.y)**2);
      if(d2<120){ damageEnemy(gs,rndInt(40,70)); burst(p.x,p.y+p.h,'#ff8800',16,6); kf('üí• GROUND SLAM!','good'); }
    },300);
  }
  else if (k==='VAULT'||k==='AIR_DASH'||k==='FLIP') {
    const dir=k==='FLIP'?-p.facing:p.facing;
    p.dashing=true; p.dashTimer=200; p.dashVx=dir*12;
    if (k==='AIR_DASH') p.vy=-3;
    burst(p.x+9,p.y+14,'#88aaff',6,2);
  }
  else if (k==='RUSH') { p.dashing=true; p.dashTimer=400; p.dashVx=p.facing*18; burst(p.x+9,p.y+14,'#ffaa44',10,4); kf('‚ö° RUSH!','info'); }
  else if (k==='SPEED_BURST') { ab.active=true; ab.activeEnd=Date.now()+3000; kf('üí® SPEED BOOST!','info'); }
  else if (k==='SHADOW_STEP') {
    const ex=gs.enemy.x, ey=gs.enemy.y;
    p.x=clamp(ex-(p.facing*60),0,W-p.w); p.y=clamp(ey,0,H-p.h);
    p.vy=0; burst(p.x+9,p.y+14,'#888888',10,3); kf('üåë SHADOW STEP','info');
  }
  else if (k==='WARP') { p.dashing=true; p.dashTimer=150; p.dashVx=p.facing*42; burst(p.x+9,p.y+14,'#44ffee',12,5); kf('üåä WARP JUMP','info'); }

  // ‚îÄ‚îÄ DEFENSE ABILITIES ‚îÄ‚îÄ
  else if (k==='SHIELD'||k==='AEGIS'||k==='DIVINE_SHIELD') { ab.active=true; ab.activeEnd=Date.now()+(ab.def.duration||2000); kf('üõ° SHIELD ACTIVE','info'); }
  else if (k==='REFLECT') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; p.reflecting=true; p.reflectEnd=Date.now()+ab.def.duration; kf('ü™û REFLECT ACTIVE','info'); }
  else if (k==='IRON_SKIN'||k==='BARRIER'||k==='PHASE_ARMOR') { ab.active=true; ab.activeEnd=Date.now()+(ab.def.duration||2500); kf('ü¶æ ARMOR ACTIVE','info'); }
  else if (k==='DODGE_ROLL') { p.invincible=300; p.dashing=true; p.dashTimer=200; p.dashVx=p.facing*10; burst(p.x+9,p.y+14,'#88aa88',6,2); }
  else if (k==='COUNTER') { ab.active=true; ab.activeEnd=Date.now()+1000; kf('‚öîÔ∏è COUNTER READY','info'); }
  else if (k==='DECOY'||k==='CLONE'||k==='MIRROR_IMAGE') { gs.decoys.push({x:p.x,y:p.y,end:Date.now()+(ab.def.duration||3000)}); kf('üë§ DECOY PLACED','info'); }
  else if (k==='SHROUD') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üå´Ô∏è INVISIBLE!','info'); }
  else if (k==='THORNS') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üåµ THORNS ACTIVE','info'); }
  else if (k==='NULLIFY') { p.statuses=[]; kf('‚õî STATUSES CLEARED','good'); }
  else if (k==='REGEN_FIELD') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üíö REGEN FIELD','good'); }

  // ‚îÄ‚îÄ OFFENSE ABILITIES ‚îÄ‚îÄ
  else if (k==='GRENADE') { throwGrenade(gs); }
  else if (k==='EMP') { applyStatus(gs.enemy,'stun',2000); burst(gs.enemy.x+9,gs.enemy.y+14,'#ffff00',16,5); kf('‚ö° ENEMY STUNNED!','good'); }
  else if (k==='AIRSTRIKE') { airstrike(gs); }
  else if (k==='BERSERK') { p.berserk=true; p.berserkEnd=Date.now()+ab.def.duration; kf('üò° BERSERK MODE!','legendary'); burst(p.x+9,p.y+14,'#ff2200',20,6); }
  else if (k==='CLUSTER') { for(let ci=0;ci<5;ci++) setTimeout(()=>triggerExplosionAt(gs,rnd(gs.enemy.x-80,gs.enemy.x+80),rnd(gs.enemy.y-80,gs.enemy.y+80),60,[30,55],'enemy'),ci*150); kf('üí• CLUSTER BOMB!','legendary'); }
  else if (k==='POISON_CLOUD') { applyStatus(gs.enemy,'poison',ab.def.duration); burst(gs.enemy.x+9,gs.enemy.y+14,'#44ff44',14,4); kf('‚ò†Ô∏è POISON CLOUD!','good'); }
  else if (k==='CHAIN_LIGHTNING') { const ld=rndInt(40,80); damageEnemy(gs,ld); applyStatus(gs.enemy,'stun',1500); spawnDmgNum(gs,gs.enemy.x+9,gs.enemy.y,ld,'#ffff88',false); kf('‚ö° CHAIN LIGHTNING!','good'); }
  else if (k==='FREEZE_BOMB') { applyStatus(gs.enemy,'freeze',2500); burst(gs.enemy.x+9,gs.enemy.y+14,'#44aaff',12,4); kf('‚ùÑÔ∏è FROZEN!','good'); }
  else if (k==='FIRE_STORM') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üî• FIRE STORM!','legendary'); }
  else if (k==='VOID_STRIKE') { const vsd=rndInt(60,100); damageEnemy(gs,vsd); spawnDmgNum(gs,gs.enemy.x+9,gs.enemy.y,vsd,'#aa44ff',true); burst(gs.enemy.x+9,gs.enemy.y+14,'#6600cc',16,6); kf('üåë VOID STRIKE!','legendary'); }
  else if (k==='METEOR') { for(let mi=0;mi<3;mi++) setTimeout(()=>{ const mx=rnd(gs.enemy.x-100,gs.enemy.x+100); triggerExplosionAt(gs,mx,0,80,[60,100],'enemy'); burst(mx,200,'#ff8822',20,8); },mi*400); kf('‚òÑÔ∏è METEOR STRIKE!','legendary'); }
  else if (k==='NOVA_BLAST') { const nd=rndInt(80,130); damageEnemy(gs,nd); applyStatus(gs.enemy,'stun',1000); spawnDmgNum(gs,gs.enemy.x+9,gs.enemy.y,nd,'#ffffaa',true); burst(p.x+9,p.y+14,'#ffffaa',25,8); kf('üí´ NOVA BLAST!','legendary'); }
  else if (k==='JUDGEMENT') { if(gs.enemy.hp/gs.enemy.maxHp<0.30){ damageEnemy(gs,99999); kf('‚ö° JUDGEMENT!','legendary'); } else { gs.player.energy+=ab.def.energyCost; ab.cd=1000; kf('‚ö° Enemy HP too high!','info'); } }
  else if (k==='SUMMON_BLADES') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('‚öîÔ∏è BLADES SUMMONED!','good'); }
  else if (k==='TURRET') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üî´ TURRET DEPLOYED!','good'); }
  else if (k==='OMNISLASH') { for(let oi=0;oi<10;oi++) setTimeout(()=>{ const od=rndInt(15,30); damageEnemy(gs,od); spawnDmgNum(gs,gs.enemy.x+9,gs.enemy.y-oi*4,od,'#ffdd44',false); },oi*80); kf('üåü OMNISLASH!','legendary'); }
  else if (k==='APOCALYPSE') { for(let ai2=0;ai2<12;ai2++) setTimeout(()=>triggerExplosionAt(gs,rnd(50,W-50),rnd(100,H-100),100,[50,90],'enemy'),ai2*200); kf('üåã APOCALYPSE!','legendary'); }

  // ‚îÄ‚îÄ HEALING ABILITIES ‚îÄ‚îÄ
  else if (k==='HEAL') { p.hp=Math.min(p.maxHp,p.hp+40); burst(p.x+9,p.y+14,'#40ff80',10,3); kf('üíä HEALED 40 HP','good'); }
  else if (k==='BIG_HEAL') { p.hp=Math.min(p.maxHp,p.hp+70); burst(p.x+9,p.y+14,'#40ff80',16,4); kf('üíâ HEALED 70 HP','good'); }
  else if (k==='LIFE_LEECH') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üßõ LIFE LEECH ACTIVE','info'); }
  else if (k==='BLOOD_PACT') { if(p.hp>30){ p.hp-=25; p.energy=Math.min(p.maxEnergy,p.energy+50); kf('ü©∏ BLOOD PACT','info'); } }
  else if (k==='MEDPACK') { p.hp=Math.min(p.maxHp,p.hp+30); kf('üè• MEDPACK +30 HP','good'); }
  else if (k==='TRANSFUSION') { const td=Math.min(30,gs.enemy.hp-1); gs.enemy.hp-=td; p.hp=Math.min(p.maxHp,p.hp+td); kf('ü©∏ TRANSFUSION!','good'); }
  else if (k==='ADRENALINE') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üí™ ADRENALINE!','good'); }
  else if (k==='SOUL_DRAIN') { const sd2=30; damageEnemy(gs,sd2); p.hp=Math.min(p.maxHp,p.hp+sd2); kf('üíÄ SOUL DRAINED!','good'); }
  else if (k==='MASS_REGEN') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üíö MASS REGEN!','good'); }
  else if (k==='PHOENIX') { ab.active=true; ab.activeEnd=Date.now()+99999999; kf('üê¶ PHOENIX READY','legendary'); }

  // ‚îÄ‚îÄ UTILITY ABILITIES ‚îÄ‚îÄ
  else if (k==='TIME_SLOW') { gs.timeSlow=true; gs.timeSlowEnd=Date.now()+(ab.def.duration||5000); document.getElementById('slow-vignette').style.opacity=1; kf('‚¨° TIME SLOW','info'); }
  else if (k==='WARP_FIELD') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üåä WARP FIELD!','legendary'); }
  else if (k==='SCAN') { kf(`üëÅÔ∏è ENEMY HP: ${Math.ceil(gs.enemy.hp)}/${Math.ceil(gs.enemy.maxHp)}`,'info'); }
  else if (k==='OVERLOAD') { const ow=p.weapons[p.weapIdx]; ow.ammoLeft=ow.maxAmmo||Infinity; ow.reloading=false; kf('‚ö° AMMO REFILLED','good'); }
  else if (k==='AMMO_SUPPLY') { p.weapons.forEach(w=>{w.ammoLeft=w.maxAmmo||Infinity;w.reloading=false;}); kf('üì¶ ALL AMMO REFILLED','good'); }
  else if (k==='ENERGY_BURST') { p.energy=p.maxEnergy; kf('‚ö° FULL ENERGY!','good'); }
  else if (k==='COUNTER_HACK') { applyStatus(gs.enemy,'stun',5000); kf('üíª ENEMY HACKED!','good'); }
  else if (k==='TIME_LOCK') { applyStatus(gs.enemy,'freeze',3000); applyStatus(gs.enemy,'stun',3000); kf('üîí TIME LOCKED!','legendary'); }
  else if (k==='DISPLACE') { const tx3=p.x,ty3=p.y; p.x=gs.enemy.x; p.y=gs.enemy.y; gs.enemy.x=tx3; gs.enemy.y=ty3; burst(p.x+9,p.y+14,'#ff88cc',12,5); kf('üîÑ DISPLACED!','good'); }
  else if (k==='GRAVITY_WELL') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üåç GRAVITY WELL!','info'); }
  else if (k==='OVERCHARGE') { gs.overchargeEnd=Date.now()+ab.def.duration; kf('üîã OVERCHARGED!','good'); }
  else if (k==='QUANTUM_LOCK') { applyStatus(gs.enemy,'freeze',2000); applyStatus(gs.enemy,'stun',2000); burst(gs.enemy.x+9,gs.enemy.y+14,'#44ffff',14,5); kf('‚öõÔ∏è QUANTUM LOCK!','legendary'); }
  else if (k==='RELOAD_BOOST') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('‚ü≥ FAST RELOAD!','info'); }

  // ‚îÄ‚îÄ SPECIAL ABILITIES ‚îÄ‚îÄ
  else if (k==='SACRIFICE') { if(p.hp>30){ p.hp-=25; p.energy=Math.min(p.maxEnergy,p.energy+50); kf('üíÄ SACRIFICE','info'); } }
  else if (k==='RAGE') { ab.active=true; ab.activeEnd=Date.now()+(ab.def.duration||4000); kf('üí¢ RAGE MODE!','legendary'); }
  else if (k==='VENGEANCE') { ab.active=true; ab.activeEnd=Date.now()+(ab.def.duration||3000); kf('üò§ VENGEANCE READY!','info'); }
  else if (k==='WILD_CARD') {
    const wAbils=['HEAL','EMP','FREEZE_BOMB','DASH','GRENADE','TELEPORT','VOID_STRIKE'];
    const wk=pick(wAbils); const wIdx=p.abilities.findIndex(a=>a.key===wk);
    if(wIdx>=0) activateAbility(gs,wIdx); else { p.hp=Math.min(p.maxHp,p.hp+25); kf('üÉè WILD CARD: +25 HP','good'); }
  }
  else if (k==='STATIC_FIELD') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('‚ö° STATIC FIELD!','info'); }
  else if (k==='ANCHOR') { applyStatus(gs.enemy,'freeze',2000); gs.enemy.vx=0; kf('‚öì ANCHORED!','good'); }
  else if (k==='NANO_SWARM') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üêù NANO SWARM!','good'); }
  else if (k==='BULLET_TIME') { gs.timeSlow=true; gs.timeSlowEnd=Date.now()+ab.def.duration; document.getElementById('slow-vignette').style.opacity=1; kf('üéØ BULLET TIME!','legendary'); }
  else if (k==='SOUL_LINK') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üíû SOUL LINKED!','info'); }
  else if (k==='MATRIX') { p.invincible=ab.def.duration; kf('üü© MATRIX MODE!','legendary'); }
  else if (k==='REWIND') { p.x=clamp(p.x+p.vx*-180,0,W-p.w); p.y=clamp(p.y+p.vy*-180,0,H-p.h); p.vy=0; burst(p.x+9,p.y+14,'#aa88ff',12,5); kf('‚è™ REWIND!','info'); }
  else if (k==='COPY_CAT') { const eid=gs.enemy.ai.lastAbilUsed||'HEAL'; kf('üê± COPY: '+eid,'info'); }
}

function throwGrenade(gs) {
  const dx=gs.mouse.x-gs.player.x-9, dy=gs.mouse.y-gs.player.y-14;
  const len=Math.sqrt(dx*dx+dy*dy)||1;
  gs.bullets.push({ x:gs.player.x+9, y:gs.player.y, vx:dx/len*9, vy:-8, owner:'player',
    type:'grenade', timer:1800, bounces:0, dmg:[80,110], explodeR:85, color:'#88ff44' });
}

function airstrike(gs) {
  kf('‚úàÔ∏è AIRSTRIKE INBOUND!','legendary');
  for (let i=0;i<6;i++) {
    setTimeout(()=>{
      const tx=rnd(50,W-50);
      gs.explosions.push({x:tx,y:0,r:0,maxR:100,life:25});
      const d2=Math.sqrt((gs.enemy.x+9-tx)**2+(gs.enemy.y+14)**2);
      if (Math.abs(gs.enemy.x+9-tx)<80) { const d3=calcDmg([80,120],false,gs); damageEnemy(gs,d3.dmg); spawnDmgNum(gs,gs.enemy.x+9,gs.enemy.y,d3.dmg,'#ff6600',d3.crit); }
      burst(tx,H*0.4,'#ff8800',20,7);
    },i*300);
  }
}

function meleePunch(gs) {
  const melee=gs.player.weapons.find(w=>w.cat==='melee');
  if (!melee) {
    const d=calcDmg([8,14],false,gs);
    if (Math.abs((gs.player.x+gs.player.facing*45)-gs.enemy.x)<50&&Math.abs(gs.player.y-gs.enemy.y)<30) {
      damageEnemy(gs,d.dmg); kf(`üëä PUNCH ${d.dmg}dmg`,'info');
    }
  }
  burst(gs.player.x+gs.player.facing*30+9,gs.player.y+14,'#ffaa88',5,2);
}

// ‚îÄ‚îÄ PHYSICS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const GRAVITY_BASE = 0.55;
const FLOOR_Y = 380;

function physicsStep(e, gs, dt) {
  const sf=gs.timeSlow?0.2:1;
  const frozen=hasStatus(e,'freeze'), stunned=hasStatus(e,'stun');
  if (frozen||stunned) { e.vx=0; return; }
  const g=GRAVITY_BASE*gs.gravMult*sf;
  e.vy+=g*(dt/16);
  e.x+=e.vx*sf*(dt/16);
  e.y+=e.vy*sf*(dt/16);
  e.onGround=false;
  for (const p of gs.platforms) {
    if (e.x+e.w>p.x&&e.x<p.x+p.w) {
      if (e.y+e.h>=p.y&&e.y+e.h<=p.y+p.h+Math.abs(e.vy)+6&&e.vy>=0) {
        e.y=p.y-e.h; e.vy=0; e.onGround=true;
      }
    }
  }
  e.x=clamp(e.x,0,W-e.w);
  if (e.y>H+50) { e.y=FLOOR_Y; e.vy=0; }
}

// ‚îÄ‚îÄ PLAYER UPDATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _origUpdatePlayer(gs, dt) {
  const p=gs.player;
  const sf=gs.timeSlow?0.3:1;
  // Speed passive check
  const hasSpeedPassive = p.abilities.some(a=>a.def?.passive&&a.key==='SPEED_PASSIVE');
  const speedBonus = hasSpeedPassive?1.3:1;
  const hasSpeedBurst = p.abilities.some(a=>a.key==='SPEED_BURST'&&a.active&&Date.now()<a.activeEnd);
  const spd=5*gs.speedMult*sf*speedBonus*(hasSpeedBurst?1.6:1);
  const stunned=hasStatus(p,'stun'), frozen=hasStatus(p,'freeze');

  if (p.dashing&&p.dashTimer>0) {
    p.dashTimer-=dt; p.vx=p.dashVx;
    if (p.dashTimer<=0) { p.dashing=false; p.vx=0; }
  } else if (!stunned&&!frozen) {
    if (gs.keys['KeyA']||gs.keys['ArrowLeft'])  { p.vx=-spd; p.facing=-1; }
    else if (gs.keys['KeyD']||gs.keys['ArrowRight']) { p.vx=spd; p.facing=1; }
    else p.vx=0;
  }
  if ((gs.keys['KeyW']||gs.keys['ArrowUp']||gs.keys['Space'])&&p.onGround&&!stunned&&!frozen) {
    p.vy=-12*gs.jumpMult; burst(p.x+9,p.y+p.h,'#4488ff33',4,1.5);
  }

  physicsStep(p,gs,dt);
  p.facing=gs.mouse.x>p.x+9?1:-1;

  // Shooting
  const w=p.weapons[p.weapIdx];
  if (w.reloading&&Date.now()>=w.reloadEnd) {
    w.reloading=false; w.ammoLeft=w.maxAmmo;
    if (isFinite(w.maxAmmo)) kf('‚ü≥ RELOADED','info');
  }
  if (!w.reloading&&!stunned&&!frozen) {
    if (w.cat==='melee') {
      if (gs.mouse.down&&!p.mheld) doMeleeAttack(gs,p,w,gs.enemy,false);
    } else {
      if (w.spinup) {
        if (gs.mouse.down) w.spinLevel=Math.min(1,w.spinLevel+dt/w.spinup);
        else w.spinLevel=Math.max(0,w.spinLevel-dt/500);
      }
      if (w.burst&&w.burstCount>0&&Date.now()>=w.burstNext) {
        shootBullet(gs,p,w,gs.mouse.x,gs.mouse.y,'player');
        w.burstCount--; w.burstNext=Date.now()+w.burstDelay;
      }
      if (gs.mouse.down&&(!w.auto?!p.mheld:true)) {
        if (!w.spinup||w.spinLevel>0.9) {
          if (w.burst&&w.burstCount===0) { w.burstCount=w.burst; w.burstNext=Date.now(); }
          else if (!w.burst) shootBullet(gs,p,w,gs.mouse.x,gs.mouse.y,'player');
        }
      }
    }
  }
  p.mheld=gs.mouse.down;

  // Energy regen
  const hasEnergyRegen = p.abilities.some(a=>a.def?.passive&&a.key==='ENERGY_REGEN');
  p.energy=Math.min(p.maxEnergy, p.energy+0.04*(dt/16)*(hasEnergyRegen?2:1));

  // Passive regen HP
  const hasRegenPassive = p.abilities.some(a=>a.def?.passive&&a.key==='REGEN_PASSIVE');
  if (hasRegenPassive) p.hp=Math.min(p.maxHp,p.hp+0.008*(dt/16));

  // Mass regen active
  const massRegenAb = p.abilities.find(a=>a.key==='MASS_REGEN'&&a.active&&Date.now()<a.activeEnd);
  if (massRegenAb) p.hp=Math.min(p.maxHp,p.hp+5*(dt/1000));

  // Regen field active
  const regenFieldAb = p.abilities.find(a=>a.key==='REGEN_FIELD'&&a.active&&Date.now()<a.activeEnd);
  if (regenFieldAb) p.hp=Math.min(p.maxHp,p.hp+3*(dt/1000));

  // Adrenaline active
  const adrAb = p.abilities.find(a=>a.key==='ADRENALINE'&&a.active&&Date.now()<a.activeEnd);
  if (adrAb) p.hp=Math.min(p.maxHp,p.hp+0.05*(dt/16));

  // Turret active
  const turretAb = p.abilities.find(a=>a.key==='TURRET'&&a.active&&Date.now()<a.activeEnd);
  if (turretAb&&!turretAb.lastShot||Date.now()-(turretAb?.lastShot||0)>400) {
    if (turretAb&&gs.enemy.hp>0) {
      turretAb.lastShot=Date.now();
      const td=rndInt(15,25); damageEnemy(gs,td); spawnDmgNum(gs,gs.enemy.x+9,gs.enemy.y,td,'#ffaa00',false);
    }
  }

  // Fire storm active
  const fireStormAb = p.abilities.find(a=>a.key==='FIRE_STORM'&&a.active&&Date.now()<a.activeEnd);
  if (fireStormAb&&!fireStormAb.lastTick||Date.now()-(fireStormAb?.lastTick||0)>300) {
    if (fireStormAb&&gs.enemy.hp>0) { fireStormAb.lastTick=Date.now(); applyStatus(gs.enemy,'burn',2000); }
  }

  // Nano swarm active
  const nanoAb = p.abilities.find(a=>a.key==='NANO_SWARM'&&a.active&&Date.now()<a.activeEnd);
  if (nanoAb&&!nanoAb.lastTick||Date.now()-(nanoAb?.lastTick||0)>500) {
    if (nanoAb&&gs.enemy.hp>0) { nanoAb.lastTick=Date.now(); const nd2=rndInt(4,10); damageEnemy(gs,nd2); spawnDmgNum(gs,gs.enemy.x+9,gs.enemy.y,nd2,'#aaff44',false); }
  }

  tickStatuses(p,gs,dt,false);

  if (p.berserk&&Date.now()>p.berserkEnd) { p.berserk=false; kf('üò° BERSERK ENDED'); }
  if (p.reflecting&&Date.now()>p.reflectEnd) p.reflecting=false;
  if (p.invincible>0) p.invincible-=dt;

  if (gs.timeSlow&&Date.now()>gs.timeSlowEnd) {
    gs.timeSlow=false; document.getElementById('slow-vignette').style.opacity=0;
  }

  p.abilities.forEach(ab=>{
    if (ab.cd>0) ab.cd=Math.max(0,ab.cd-dt);
    if (ab.active&&Date.now()>ab.activeEnd) ab.active=false;
  });

  if (gs.combo>0) { gs.comboTimer-=dt; if (gs.comboTimer<=0) { gs.combo=0; gs.comboTimer=0; } }
}

// ‚îÄ‚îÄ ENEMY AI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateEnemy(gs, dt) {
  const e=gs.enemy, p=gs.player, ai=e.ai, diff=gs.diff;
  const sf=gs.timeSlow?0.15:1;

  ai.stratTimer-=dt*sf; ai.jumpCd-=dt; ai.dodgeCd-=dt; ai.aimUpdateTimer-=dt;
  e.invincible-=dt;

  tickStatuses(e,gs,dt,true);
  const stunned=hasStatus(e,'stun'), frozen=hasStatus(e,'freeze');
  if (stunned||frozen) { e.vx=0; physicsStep(e,gs,dt); return; }

  let target=p;
  if (gs.decoys.length>0&&['hard','insane'].includes(selectedDiff)) target=gs.decoys[0];

  const dx=(target.x+9)-(e.x+9);
  const distToTarget=Math.abs(dx);
  e.facing=dx>0?1:-1;

  if (ai.stratTimer<=0) {
    ai.stratTimer=diff.strategyChange*(0.8+Math.random()*0.4);
    const r=Math.random();
    if (distToTarget>220) ai.state='chase';
    else if (distToTarget<diff.retreatDist&&r<0.5) ai.state='retreat';
    else if (r<diff.aggression) ai.state='aggressive';
    else ai.state=r<0.7?'strafe':'idle';
    if (['hard','insane'].includes(selectedDiff)&&Math.random()<0.4) ai.state='flank';
  }

  const spd=3.5*gs.speedMult*sf;
  switch(ai.state) {
    case 'chase':      e.vx=e.facing*spd; break;
    case 'aggressive': e.vx=e.facing*spd*1.2; break;
    case 'retreat':    e.vx=-e.facing*spd*0.9; break;
    case 'strafe':     e.vx=(Math.sin(Date.now()*0.004)>0?1:-1)*spd; break;
    case 'flank':      e.vx=e.facing*spd*(Math.sin(Date.now()*0.003)*0.5+0.8); break;
    default:           e.vx=0;
  }

  if (ai.dodgeCd<=0&&Math.random()<diff.dodgeChance) {
    e.vx+=(Math.random()<0.5?-1:1)*8*sf; ai.dodgeCd=800+Math.random()*400;
  }
  if (e.onGround&&ai.jumpCd<=0&&Math.random()<(selectedDiff==='insane'?0.02:0.008)) {
    e.vy=-11; ai.jumpCd=1500+Math.random()*1000;
  }
  if (['hard','insane'].includes(selectedDiff)&&e.onGround&&ai.jumpCd<=0) {
    if (p.y<e.y-50&&Math.abs(dx)<200) { e.vy=-13; ai.jumpCd=1800; }
  }

  physicsStep(e,gs,dt);

  if (['hard','insane'].includes(selectedDiff)) {
    const curW=e.weapons[e.weapIdx];
    if (curW.cat==='melee'&&distToTarget>60) e.weapIdx=(e.weapIdx+1)%e.weapons.length;
    if (curW.cat!=='melee'&&distToTarget<45) {
      const mi=e.weapons.findIndex(w=>w.cat==='melee');
      if (mi>=0) e.weapIdx=mi;
    }
  }

  if (ai.aimUpdateTimer<=0) {
    ai.aimUpdateTimer=diff.reactionMs*(0.8+Math.random()*0.4);
    const err=diff.aimError;
    ai.aimOffset={x:(Math.random()-0.5)*err*2, y:(Math.random()-0.5)*err*2};
    if (selectedDiff==='insane') { ai.aimOffset.x+=p.vx*8; ai.aimOffset.y+=p.vy*4; }
  }

  const ew=e.weapons[e.weapIdx];
  if (ew.reloading&&Date.now()>=ew.reloadEnd) { ew.reloading=false; ew.ammoLeft=ew.maxAmmo; }
  if (!ew.reloading&&ew.ammoLeft>0) {
    if (ew.cat==='melee') { if (distToTarget<ew.range+10) doMeleeAttack(gs,e,ew,p,true); }
    else { shootBullet(gs,e,ew,p.x+9+ai.aimOffset.x,p.y+14+ai.aimOffset.y,'enemy'); }
  }
  if (!ew.reloading&&isFinite(ew.maxAmmo)&&ew.ammoLeft===0) {
    ew.reloading=true; ew.reloadEnd=Date.now()+ew.reload;
  }
}

// ‚îÄ‚îÄ SHOOTING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function shootBullet(gs, shooter, w, tx, ty, owner) {
  const now=Date.now();
  const sf=gs.timeSlow?(owner==='player'?1:0.2):1;
  if (now-w.lastShot<w.rate/sf) return;
  if (!isFinite(w.ammoLeft)?false:w.ammoLeft<=0) return;
  w.lastShot=now;
  if (isFinite(w.ammoLeft)) w.ammoLeft--;

  const cx=shooter.x+9, cy=shooter.y+14;
  let dx=tx-cx, dy=ty-cy;
  const len=Math.sqrt(dx*dx+dy*dy)||1;
  dx/=len; dy/=len;

  const berserkMult=(owner==='player'&&gs.player.berserk)?2:1;
  const glassMult=gs.glassCannon?2:1;
  const overchargeMult=(owner==='player'&&Date.now()<gs.overchargeEnd)?1.5:1;
  const lastStandMult=(owner==='player'&&gs.player.hp/gs.player.maxHp<0.25&&gs.player.abilities.some(a=>a.def?.passive&&a.key==='LAST_STAND'))?1.75:1;
  const rageMult=(owner==='player'&&gs.player.abilities.some(a=>a.key==='RAGE'&&a.active&&Date.now()<a.activeEnd))?(2-gs.player.hp/gs.player.maxHp):1;

  const angles=[];
  if (w.spread_mode==='fan'&&w.proj>1) {
    for (let i=0;i<w.proj;i++) angles.push(Math.atan2(dy,dx)+(i-(w.proj-1)/2)*0.25);
  } else {
    for (let i=0;i<(w.proj||1);i++) angles.push(Math.atan2(dy,dx)+(Math.random()-0.5)*w.spread*2);
  }

  for (const angle of angles) {
    const sp=w.speed*(0.9+Math.random()*0.15);
    const d=calcDmg(w.dmg,owner==='player',gs);
    const b={
      x:cx, y:cy,
      vx:Math.cos(angle)*sp, vy:Math.sin(angle)*sp,
      damage:Math.round(d.dmg*berserkMult*glassMult*overchargeMult*lastStandMult*rageMult),
      crit:d.crit, color:w.color||'#ffff44', owner,
      effect:w.effect||null, pierce:w.pierce||false,
      bouncy:w.bouncy||0, laser:w.laser||false,
      explosive:w.explosive||false, explodeR:w.explodeR||80,
      blackhole:w.blackhole||false, gravity_flip:w.gravity_flip||false,
      bounce_wall:w.bounce||false, short_range:w.short||false,
      trail:[], life:w.short?18:90, type:'bullet',
    };
    if (w.gravity_flip) b.gravity=0.25;
    if (w.laser) { processLaser(gs,b,owner); continue; }
    if (w.blackhole) { gs.blackholes.push({x:cx,y:cy,vx:b.vx,vy:b.vy,life:120,r:0,maxR:100}); continue; }
    gs.bullets.push(b);
  }

  // Warp field
  if (gs.player.abilities.some(a=>a.key==='WARP_FIELD'&&a.active&&Date.now()<a.activeEnd)&&owner==='enemy') {
    gs.bullets.forEach(b=>{ if (b.owner==='enemy') { const wdx=gs.mouse.x-b.x,wdy=gs.mouse.y-b.y,wl=Math.sqrt(wdx*wdx+wdy*wdy)||1; b.vx=wdx/wl*(w.speed||10); b.vy=wdy/wl*(w.speed||10); } });
  }
}

function processLaser(gs, b, owner) {
  const target=owner==='player'?gs.enemy:gs.player;
  const shieldAb=gs.player.abilities.find(a=>(a.key==='SHIELD'||a.key==='AEGIS'||a.key==='DIVINE_SHIELD')&&a.active&&Date.now()<a.activeEnd);
  if (owner==='enemy'&&shieldAb) { kf('üõ° LASER BLOCKED!','info'); return; }
  if (owner==='player') {
    if (raycastHit(b.x,b.y,b.vx,b.vy,target)) { damageEnemy(gs,b.damage); spawnDmgNum(gs,target.x+9,target.y,b.damage,b.color,b.crit); }
  } else {
    if (raycastHit(b.x,b.y,b.vx,b.vy,gs.player)&&gs.player.invincible<=0) damagePlayer(gs,b.damage);
  }
  for (let t=0;t<20;t++) burst(b.x+b.vx*t*0.8,b.y+b.vy*t*0.8,b.color,1,0);
}

function raycastHit(ox,oy,dx,dy,target) {
  for (let t=0;t<80;t++) {
    const x=ox+dx*t,y=oy+dy*t;
    if (x>target.x&&x<target.x+target.w&&y>target.y&&y<target.y+target.h) return true;
  }
  return false;
}

function doMeleeAttack(gs, attacker, w, victim, isEnemy) {
  const now=Date.now();
  if (now-w.lastShot<w.rate) return;
  w.lastShot=now;
  const dx=Math.abs(attacker.x-victim.x), dy=Math.abs(attacker.y-victim.y);
  if (dx>w.range+10||dy>40) return;
  const d=calcDmg(w.dmg,!isEnemy,gs);
  const bMult=(!isEnemy&&gs.player.berserk)?2:1;
  const dmg=Math.round(d.dmg*bMult*(gs.glassCannon?2:1));
  if (isEnemy) { damagePlayer(gs,dmg); }
  else { damageEnemy(gs,dmg); if (gs.lifeSteal) gs.player.hp=Math.min(gs.player.maxHp,gs.player.hp+dmg*0.1); }
  spawnDmgNum(gs,victim.x+9,victim.y,dmg,w.color,d.crit);
  burst(victim.x+9,victim.y+14,w.color,8,3);
  if (w.effect) applyStatus(victim,w.effect,2500);
}

function _baseCalcDmg(range, isPlayer, gs) {
  const base=rnd(range[0],range[1]);
  const hasCritBoost=isPlayer&&gs.player.abilities.some(a=>a.def?.passive&&a.key==='CRIT_BOOST');
  const critChance=(gs.bigHead?0.3:0.1)+(hasCritBoost?0.15:0);
  const isCrit=Math.random()<critChance;
  const mult=isCrit?rnd(2,3):1;
  return { dmg:Math.round(base*mult), crit:isCrit };
}

// ‚îÄ‚îÄ BULLET UPDATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateBullets(gs, dt) {
  const sf=gs.timeSlow?0.2:1;

  gs.blackholes=gs.blackholes.filter(bh=>{
    bh.x+=bh.vx*sf*(dt/16); bh.y+=bh.vy*sf*(dt/16);
    bh.vy+=0.1*sf; bh.life-=sf; bh.r=Math.min(bh.maxR,bh.r+2);
    [gs.player,gs.enemy].forEach(e=>{ const ddx=bh.x-(e.x+9),ddy=bh.y-(e.y+14),dl=Math.sqrt(ddx*ddx+ddy*ddy)||1; if(dl<bh.r+30){e.vx+=ddx/dl*2;e.vy+=ddy/dl*1.5;} });
    return bh.life>0;
  });

  const warpAb=gs.player.abilities.find(a=>a.key==='WARP_FIELD'&&a.active&&Date.now()<a.activeEnd);
  const staticFieldAb=gs.player.abilities.find(a=>a.key==='STATIC_FIELD'&&a.active&&Date.now()<a.activeEnd);

  for (let i=gs.bullets.length-1;i>=0;i--) {
    const b=gs.bullets[i];
    if (b.type==='grenade') { updateGrenade(gs,b,i,sf,dt); continue; }

    b.trail.push({x:b.x,y:b.y});
    if (b.trail.length>10) b.trail.shift();

    if (warpAb&&b.owner==='enemy') {
      const wdx=gs.mouse.x-b.x,wdy=gs.mouse.y-b.y,wl=Math.sqrt(wdx*wdx+wdy*wdy)||1;
      b.vx+=wdx/wl*0.5; b.vy+=wdy/wl*0.5;
    }
    // Static field slows bullets
    if (staticFieldAb&&b.owner==='enemy') { b.vx*=0.97; b.vy*=0.97; }

    if (b.gravity) b.vy+=b.gravity*sf;
    else if (!b.gravity_flip) b.vy+=0.08*sf;

    b.x+=b.vx*sf*(dt/16); b.y+=b.vy*sf*(dt/16);
    b.life-=sf*(dt/16);

    if (b.life<=0||b.x<-20||b.x>W+20||b.y>H+20) { gs.bullets.splice(i,1); continue; }

    if (b.bouncy>0) {
      if (b.x<2||b.x>W-2) { b.vx*=-1; b.bouncy--; }
      if (b.y<2) b.vy*=-1;
    }

    let hitPlat=false;
    for (const pl of gs.platforms) {
      if (b.x>pl.x&&b.x<pl.x+pl.w&&b.y>pl.y&&b.y<pl.y+pl.h) {
        if (b.bounce_wall) { b.vy*=-0.6; b.vx*=0.7; hitPlat=false; break; }
        if (b.explosive) { triggerExplosion(gs,b); gs.bullets.splice(i,1); hitPlat=true; break; }
        burst(b.x,b.y,b.color,4,1);
        gs.bullets.splice(i,1); hitPlat=true; break;
      }
    }
    if (hitPlat) continue;

    if (b.owner==='enemy') {
      const shAb=gs.player.abilities.find(a=>(a.key==='SHIELD'||a.key==='AEGIS'||a.key==='DIVINE_SHIELD')&&a.active&&Date.now()<a.activeEnd);
      if (gs.player.reflecting) {
        if (rectHit(b,gs.player,12)) { b.owner='player'; b.vx*=-1.2; b.vy*=-0.5; kf('ü™û REFLECTED!','good'); continue; }
      }
      if (shAb) {
        if (rectHit(b,gs.player,12)) { burst(b.x,b.y,'#44ccff',6); gs.bullets.splice(i,1); continue; }
      }
      // Vengeance retaliation
      const vengAb=gs.player.abilities.find(a=>a.key==='VENGEANCE'&&a.active&&Date.now()<a.activeEnd);
      if (gs.player.invincible<=0&&rectHit(b,gs.player,0)) {
        let dmg=b.damage*(gs.glassCannon?2:1);
        // Armor passive
        const hasArmor=gs.player.abilities.some(a=>a.def?.passive&&a.key==='ARMOR');
        const hasIronSkin=gs.player.abilities.some(a=>(a.key==='IRON_SKIN'||a.key==='BARRIER')&&a.active&&Date.now()<a.activeEnd);
        if (hasArmor) dmg*=0.8;
        if (hasIronSkin) dmg*=0.5;
        damagePlayer(gs,dmg);
        if (vengAb) damageEnemy(gs,Math.round(dmg*0.5));
        if (b.effect) applyStatus(gs.player,b.effect,2000);
        if (gs.lifeSteal) gs.player.hp=Math.min(gs.player.maxHp,gs.player.hp+dmg*0.1);
        if (b.explosive) triggerExplosion(gs,b);
        if (!b.pierce) { gs.bullets.splice(i,1); continue; }
      }
    }

    if (b.owner==='player'&&gs.enemy.hp>0&&gs.enemy.invincible<=0) {
      if (rectHit(b,gs.enemy,0)) {
        damageEnemy(gs,b.damage);
        spawnDmgNum(gs,gs.enemy.x+9,gs.enemy.y,b.damage,b.color,b.crit);
        if (b.effect) applyStatus(gs.enemy,b.effect,2000);
        if (gs.hasMod('one_shot')&&b.crit) damageEnemy(gs,9999);
        if (b.explosive) triggerExplosion(gs,b);
        if (!b.pierce) { gs.bullets.splice(i,1); continue; }
      }
    }
  }
  gs.decoys=gs.decoys.filter(d=>Date.now()<d.end);
}

function updateGrenade(gs,b,i,sf,dt) {
  b.x+=b.vx*sf*(dt/16); b.y+=b.vy*sf*(dt/16);
  b.vy+=GRAVITY_BASE*gs.gravMult*sf*(dt/16);
  b.timer-=dt*sf;
  for (const pl of gs.platforms) {
    if (b.x>pl.x&&b.x<pl.x+pl.w&&b.y+6>pl.y&&b.y+6<pl.y+pl.h+5&&b.vy>0) {
      b.vy*=-0.5; b.vx*=0.7; b.bounces++;
    }
  }
  if (b.x<0||b.x>W) b.vx*=-1;
  if (b.timer<=0) { triggerExplosionAt(gs,b.x,b.y,85,[80,110],'player'); gs.bullets.splice(i,1); }
}

function rectHit(b,e,pad) { return b.x>e.x-pad&&b.x<e.x+e.w+pad&&b.y>e.y-pad&&b.y<e.y+e.h+pad; }
function triggerExplosion(gs,b) { triggerExplosionAt(gs,b.x,b.y,b.explodeR||80,b.dmg||[80,120],b.owner==='player'?'enemy':'player'); }
function triggerExplosionAt(gs,x,y,r,dmgRange,hurtWho) {
  gs.explosions.push({x,y,r:0,maxR:r,life:28});
  burst(x,y,'#ff8822',18,6);
  const targets=hurtWho==='player'?[gs.player]:[gs.enemy];
  targets.forEach(t=>{
    const d2=Math.sqrt((t.x+9-x)**2+(t.y+14-y)**2);
    if (d2<r+20) {
      const fraction=1-clamp(d2/r,0,1);
      const dmg=Math.round(rnd(dmgRange[0],dmgRange[1])*fraction);
      if (dmg>0) {
        if (hurtWho==='player') damagePlayer(gs,dmg);
        else { damageEnemy(gs,dmg); spawnDmgNum(gs,t.x+9,t.y,dmg,'#ff8800',false); }
      }
    }
  });
}

// ‚îÄ‚îÄ DAMAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function damagePlayer(gs, dmg) {
  const p=gs.player;
  if (p.invincible>0) return;
  // Phoenix passive check
  const phoenixAb=p.abilities.find(a=>a.key==='PHOENIX'&&a.active);
  p.hp=Math.max(0,p.hp-dmg);
  p.invincible=300;
  flashDmg();
  if (p.hp<=0) {
    if (phoenixAb) { p.hp=p.maxHp*0.5; p.invincible=2000; phoenixAb.active=false; kf('üê¶ PHOENIX REVIVAL!','legendary'); return; }
    setTimeout(()=>endGame(gs,false),400); gs.running=false;
  }
}

function damageEnemy(gs, dmg) {
  const e=gs.enemy;
  if (e.invincible>0) return;
  e.hp=Math.max(0,e.hp-dmg);
  e.invincible=180;
  gs.score+=dmg*10*Math.max(1,gs.combo);
  gs.combo++;
  const hasComboMaster=gs.player.abilities.some(a=>a.def?.passive&&a.key==='COMBO_MASTER');
  gs.comboTimer=3000*(hasComboMaster?1.5:1);
  if (e.hp<=0&&gs.running) {
    gs.running=false;
    gs.score+=1000*gs.wave;
    PROG.totalKills++;
    kf('üíÄ ENEMY ELIMINATED! +'+(1000*gs.wave),'legendary');
    burst(e.x+9,e.y+14,'#ff4444',30,8);
    setTimeout(()=>endGame(gs,true),1200);
  }
}

// ‚îÄ‚îÄ STATUS EFFECTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applyStatus(entity,type,duration) {
  const existing=entity.statuses.find(s=>s.type===type);
  if (existing) { existing.end=Date.now()+duration; return; }
  entity.statuses.push({type,end:Date.now()+duration});
}
function hasStatus(entity,type) { return entity.statuses.some(s=>s.type===type&&s.end>Date.now()); }
function tickStatuses(entity,gs,dt,isEnemy) {
  entity.statuses=entity.statuses.filter(s=>s.end>Date.now());
  for (const s of entity.statuses) {
    if (s.type==='burn') {
      if (!s.lastTick||Date.now()-s.lastTick>500) {
        s.lastTick=Date.now(); const d=rndInt(4,8);
        if (isEnemy) { damageEnemy(gs,d); spawnDmgNum(gs,entity.x+9,entity.y,d,'#ff6600',false); }
        else damagePlayer(gs,d);
        burst(entity.x+9,entity.y+14,'#ff6600',3,2);
      }
    }
    if (s.type==='poison') {
      if (!s.lastTick||Date.now()-s.lastTick>600) {
        s.lastTick=Date.now(); const d=rndInt(3,6);
        if (isEnemy) { damageEnemy(gs,d); spawnDmgNum(gs,entity.x+9,entity.y,d,'#40ff40',false); }
        else damagePlayer(gs,d);
      }
    }
  }
}

// ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function burst(x,y,color,count,speed=4) {
  if (!GS) return;
  for (let i=0;i<count;i++) {
    const angle=Math.random()*Math.PI*2, s=(0.5+Math.random())*speed;
    GS.particles.push({x,y,vx:Math.cos(angle)*s,vy:Math.sin(angle)*s-0.5,life:20+Math.random()*25,maxLife:45,color,size:1.5+Math.random()*2.5});
  }
}
function spawnDmgNum(gs,x,y,val,color,crit) { gs.damageNums.push({x,y,val,color:crit?'#ffffff':color,life:55,vy:-1.8,crit}); }
function updateParticles(gs,dt) {
  const sf=gs.timeSlow?0.2:1;
  gs.particles=gs.particles.filter(p=>{ p.x+=p.vx*sf*(dt/16); p.y+=p.vy*sf*(dt/16); p.vy+=0.12*sf; p.life-=sf*(dt/16); return p.life>0; });
  gs.damageNums=gs.damageNums.filter(d=>{ d.y+=d.vy; d.life--; return d.life>0; });
  gs.explosions=gs.explosions.filter(e=>{ e.r+=(e.maxR-e.r)*0.22; e.life--; return e.life>0; });
}

// ‚îÄ‚îÄ DRAWING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawFrame(gs) {
  ctx.clearRect(0,0,W,H);
  drawBg(gs);
  drawBullets(gs);
  drawBlackholes(gs);
  drawDecoys(gs);
  drawEntity(gs,gs.player,true);
  if (gs.enemy.hp>0) drawEntity(gs,gs.enemy,false);
  drawParticles(gs);
  drawExplosions(gs);
  drawDamageNums(gs);
  drawReloadBar(gs);
  if (gs.timeSlow) drawTimeslowFx(gs);
  updateHUD(gs);
}

function drawBg(gs) {
  const t=gs.theme;
  const sg=ctx.createLinearGradient(0,0,0,H);
  sg.addColorStop(0,t.sky[0]); sg.addColorStop(1,t.sky[1]);
  ctx.fillStyle=sg; ctx.fillRect(0,0,W,H);

  if (t.glitch&&Math.random()<0.03) {
    ctx.fillStyle='rgba(255,0,255,0.04)';
    ctx.fillRect(0,Math.random()*H,W,rnd(2,8));
  }

  const sf=gs.timeSlow?0.2:1;
  for (const p of gs.bgParticles) {
    p.x+=p.vx*sf; p.y+=p.vy*sf;
    if (p.y>H) p.y=0; if (p.x<0) p.x=W; if (p.x>W) p.x=0;
    ctx.globalAlpha=p.alpha;
    ctx.fillStyle=p.type==='rain'?'rgba(100,160,255,0.5)':p.type==='dust'?'rgba(200,150,80,0.4)':'#fff';
    ctx.fillRect(Math.floor(p.x),Math.floor(p.y),p.size,p.type==='rain'?6:p.size);
  }
  ctx.globalAlpha=1;

  // Buildings
  const bldColor=t.sky[0];
  [[0,180,55],[70,210,75],[155,170,45],[210,195,65],[290,180,38],[340,215,55],[420,165,78],[510,205,48],[570,185,65],[650,195,76],[740,175,58],[820,210,38],[870,185,28]].forEach(([bx,bw,bh])=>{
    ctx.fillStyle=bldColor; ctx.fillRect(bx,H-bh,bw,bh);
    ctx.fillStyle=t.glow+'22';
    for (let wx2=bx+4;wx2<bx+bw-4;wx2+=9) for(let wy=H-bh+6;wy<H-6;wy+=11) {
      if (Math.random()<0.35) ctx.fillRect(wx2,wy,4,5);
    }
  });

  // Platforms
  for (const p of gs.platforms) {
    if (p.ground) {
      const gg=ctx.createLinearGradient(0,p.y,0,p.y+p.h);
      gg.addColorStop(0,t.ground); gg.addColorStop(1,'#040408');
      ctx.fillStyle=gg; ctx.fillRect(p.x,p.y,p.w,p.h);
      ctx.fillStyle=t.platTop; ctx.fillRect(p.x,p.y,p.w,3);
    } else {
      ctx.fillStyle=t.plat; ctx.fillRect(p.x,p.y,p.w,p.h);
      ctx.fillStyle=t.platTop; ctx.fillRect(p.x,p.y,p.w,3);
      ctx.fillStyle=t.plat+'88';
      ctx.fillRect(p.x+8,p.y+p.h,5,18); ctx.fillRect(p.x+p.w-13,p.y+p.h,5,18);
    }
  }
}

function drawEntity(gs,e,isPlayer) {
  let x=Math.floor(e.x), y=Math.floor(e.y);
  const f=e.facing, t=Date.now();
  const bob=e.onGround?Math.sin(t*0.007*(Math.abs(e.vx)+0.5))*1.5:0;
  y+=bob;
  if (e.invincible>0&&Math.floor(e.invincible/70)%2===0) return;

  const hasShield=isPlayer&&gs.player.abilities.some(a=>(a.key==='SHIELD'||a.key==='AEGIS'||a.key==='DIVINE_SHIELD')&&a.active&&Date.now()<a.activeEnd);
  const col=isPlayer?(e.berserk?'#ff2200':hasShield?'#44ccff':'#4488ff'):'#ff4444';
  const dark=isPlayer?'#223388':'#882222';
  const arm=isPlayer?'#336699':'#993333';

  // Shadow
  ctx.globalAlpha=0.35; ctx.fillStyle='#000';
  ctx.beginPath(); ctx.ellipse(x+9,FLOOR_Y+28,9,3,0,0,Math.PI*2); ctx.fill();
  ctx.globalAlpha=1;

  // Legs
  const swing=e.onGround&&Math.abs(e.vx)>0.5?Math.sin(t*0.015)*5:0;
  ctx.fillStyle=dark;
  ctx.fillRect(x+2,y+e.h-10,6,10); ctx.fillRect(x+e.w-8,y+e.h-10,6,10);
  ctx.fillStyle=col;
  ctx.fillRect(x+2-swing,y+e.h-2,7,3); ctx.fillRect(x+e.w-9+swing,y+e.h-2,7,3);

  // Body
  ctx.fillStyle=col; ctx.fillRect(x+2,y+8,e.w-4,e.h-18);
  ctx.fillStyle=dark; ctx.fillRect(x+4,y+10,e.w-8,3);

  // Berserk glow
  if (isPlayer&&e.berserk) {
    ctx.globalAlpha=0.3+Math.sin(t*0.02)*0.2;
    ctx.fillStyle='#ff4400'; ctx.fillRect(x-4,y-4,e.w+8,e.h+8);
    ctx.globalAlpha=1;
  }

  // Head
  ctx.fillStyle=col; ctx.fillRect(x+2,y,e.w-4,12);
  ctx.fillStyle=isPlayer?'#aaddff':'#ffaaaa';
  ctx.fillRect(x+(f>0?e.w-10:4),y+3,6,5);
  ctx.fillStyle=isPlayer?'rgba(100,220,255,0.7)':'rgba(255,100,100,0.7)';
  ctx.fillRect(x+(f>0?e.w-9:5),y+4,4,3);

  // Status glow
  if (hasStatus(e,'burn'))   { ctx.globalAlpha=0.4+Math.sin(t*0.03)*0.2; ctx.fillStyle='#ff6600'; ctx.fillRect(x-2,y-2,e.w+4,e.h+4); ctx.globalAlpha=1; }
  if (hasStatus(e,'freeze')) { ctx.globalAlpha=0.4; ctx.fillStyle='#4488ff'; ctx.fillRect(x-2,y-2,e.w+4,e.h+4); ctx.globalAlpha=1; }
  if (hasStatus(e,'poison')) { ctx.globalAlpha=0.3; ctx.fillStyle='#40ff40'; ctx.fillRect(x-2,y-2,e.w+4,e.h+4); ctx.globalAlpha=1; }

  // Arm + gun
  const w2=e.weapons[e.weapIdx];
  const aimDx=isPlayer?(gs.mouse.x-(x+9)):(gs.player.x+9-(e.x+9));
  const aimDy=isPlayer?(gs.mouse.y-(y+14)):(gs.player.y+14-(e.y+14));
  const aimAngle=Math.atan2(aimDy,aimDx);
  const armX=x+(f>0?e.w-2:4), armY=y+14;
  ctx.fillStyle=arm; ctx.fillRect(armX-(f>0?0:6),armY,6,5);
  ctx.save();
  ctx.translate(armX+(f>0?3:-3),armY+2);
  ctx.rotate(aimAngle);
  if (w2.cat==='melee') {
    ctx.fillStyle='#aaaaaa'; ctx.fillRect(-4,-2,w2.range||40,4);
    ctx.fillStyle='#cccccc'; ctx.fillRect(-4,-3,8,6);
  } else {
    ctx.fillStyle=w2.color||'#aaccff'; ctx.fillRect(0,-2,16,5);
    ctx.fillStyle='#aaaaaa'; ctx.fillRect(14,-3,3,7);
    const shotAge=Date.now()-w2.lastShot;
    if (shotAge<(w2.rate||150)*0.45) {
      ctx.fillStyle='#fff8aa'; ctx.fillRect(17,-5,8,11);
      ctx.fillStyle='#ffdd44'; ctx.fillRect(18,-3,5,7);
    }
  }
  ctx.restore();

  // Shield bubble
  if (hasShield) {
    ctx.strokeStyle=`rgba(68,204,255,${0.5+Math.sin(t*0.01)*0.3})`;
    ctx.lineWidth=3; ctx.beginPath(); ctx.arc(x+9,y+14,22,0,Math.PI*2); ctx.stroke();
  }
  // Reflect shimmer
  if (isPlayer&&e.reflecting) {
    ctx.strokeStyle=`rgba(255,255,255,${0.6+Math.sin(t*0.02)*0.3})`;
    ctx.lineWidth=2; ctx.beginPath(); ctx.arc(x+9,y+14,20,0,Math.PI*2); ctx.stroke();
  }
}

function drawDecoys(gs) {
  for (const d of gs.decoys) {
    const x=Math.floor(d.x),y=Math.floor(d.y);
    const remain=(d.end-Date.now())/3000;
    ctx.globalAlpha=clamp(remain,0,0.8);
    ctx.fillStyle='#ffaa44';
    ctx.fillRect(x+2,y,14,12); ctx.fillRect(x+2,y+8,14,20);
    ctx.globalAlpha=1;
  }
}

function drawBullets(gs) {
  for (const b of gs.bullets) {
    if (b.type==='grenade') {
      const blink=b.timer<600&&Math.floor(Date.now()/80)%2===0;
      ctx.fillStyle=blink?'#ffff00':'#558833';
      ctx.fillRect(Math.floor(b.x-4),Math.floor(b.y-5),8,8);
      ctx.fillStyle='#888'; ctx.fillRect(Math.floor(b.x-1),Math.floor(b.y-9),3,4);
      continue;
    }
    for (let ti=0;ti<b.trail.length;ti++) {
      ctx.globalAlpha=(ti/b.trail.length)*0.55;
      ctx.fillStyle=b.color;
      ctx.fillRect(Math.floor(b.trail[ti].x-1.5),Math.floor(b.trail[ti].y-1.5),3,3);
    }
    ctx.globalAlpha=1;
    ctx.fillStyle=b.color;
    if (b.explosive) {
      ctx.fillRect(Math.floor(b.x-5),Math.floor(b.y-5),10,10);
      ctx.fillStyle='#ffaa44'; ctx.fillRect(Math.floor(b.x-3),Math.floor(b.y-3),6,6);
    } else {
      const bw=b.bouncy?5:4,bh=b.bouncy?4:3;
      ctx.fillRect(Math.floor(b.x-bw/2),Math.floor(b.y-bh/2),bw,bh);
    }
  }
  ctx.globalAlpha=1;
}

function drawBlackholes(gs) {
  for (const bh of gs.blackholes) {
    for (let r2=bh.r;r2>0;r2-=12) {
      ctx.globalAlpha=(1-r2/bh.r)*0.6; ctx.strokeStyle='#8800ff'; ctx.lineWidth=2;
      ctx.beginPath(); ctx.arc(bh.x,bh.y,r2,0,Math.PI*2); ctx.stroke();
    }
    ctx.globalAlpha=0.8; ctx.fillStyle='#220044';
    ctx.beginPath(); ctx.arc(bh.x,bh.y,12,0,Math.PI*2); ctx.fill();
    ctx.globalAlpha=1;
  }
}

function drawParticles(gs) {
  for (const p of gs.particles) {
    ctx.globalAlpha=clamp(p.life/p.maxLife,0,1);
    ctx.fillStyle=p.color;
    ctx.fillRect(Math.floor(p.x-p.size/2),Math.floor(p.y-p.size/2),Math.ceil(p.size),Math.ceil(p.size));
  }
  ctx.globalAlpha=1;
}

function drawExplosions(gs) {
  for (const e of gs.explosions) {
    const a=e.life/28;
    ctx.globalAlpha=a*0.55; ctx.fillStyle='#ff8822';
    ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,Math.PI*2); ctx.fill();
    ctx.globalAlpha=a*0.7; ctx.fillStyle='#ffee44';
    ctx.beginPath(); ctx.arc(e.x,e.y,e.r*0.45,0,Math.PI*2); ctx.fill();
    ctx.globalAlpha=1;
  }
}

function drawDamageNums(gs) {
  for (const d of gs.damageNums) {
    ctx.globalAlpha=d.life/55;
    ctx.fillStyle=d.color;
    ctx.font=`${d.crit?'bold ':''} ${d.crit?16:13}px 'VT323', monospace`;
    if (d.crit) ctx.fillText('CRIT! '+d.val,Math.floor(d.x-15),Math.floor(d.y));
    else ctx.fillText('-'+d.val,Math.floor(d.x),Math.floor(d.y));
  }
  ctx.globalAlpha=1;
}

function drawReloadBar(gs) {
  const w=gs.player.weapons[gs.player.weapIdx];
  if (!w.reloading) return;
  const prog=1-(w.reloadEnd-Date.now())/w.reload;
  const bw=44,bx=gs.player.x+9-bw/2,by=gs.player.y-18;
  ctx.fillStyle='#111'; ctx.fillRect(bx,by,bw,5);
  ctx.fillStyle='#ffaa22'; ctx.fillRect(bx,by,bw*clamp(prog,0,1),5);
  ctx.font='9px "Orbitron",monospace';
  ctx.fillStyle='#fff'; ctx.fillText('RELOAD',bx+2,by+15);
}

function drawTimeslowFx(gs) {
  ctx.fillStyle='rgba(80,20,160,0.06)'; ctx.fillRect(0,0,W,H);
  ctx.font='8px "Orbitron",monospace'; ctx.fillStyle='rgba(160,80,255,0.55)';
  ctx.fillText('‚¨° TIME SLOW',8,18);
}

// ‚îÄ‚îÄ HUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _origSetupHUD(gs) {
  const row=document.getElementById('abilities-row');
  row.innerHTML='';
  gs.player.abilities.forEach((ab,i)=>{
    const el=document.createElement('div');
    el.className='abil-slot'; el.id='aslot'+i;
    el.innerHTML=`<div class="akey">${i+1}</div>${ab.def.icon}<div class="alabel">${ab.def.name.split(' ')[0]}</div><div class="acd" id="acd${i}" style="height:0%"></div>`;
    el.style.borderColor=ab.def.color+'66';
    if (ab.def.passive) el.style.borderColor='#555555'; // passive = dimmed
    row.appendChild(el);
  });
  document.getElementById('modifier-banner').textContent=gs.mods.map(m=>m.icon+m.name).join(' | ');
}

function updateHUD(gs) {
  const p=gs.player,e=gs.enemy,pw=p.weapons[p.weapIdx];
  pct('p-hp-bar',p.hp/p.maxHp*100);
  pct('p-en-bar',p.energy/p.maxEnergy*100);
  const amPct=isFinite(pw.maxAmmo)?pw.ammoLeft/pw.maxAmmo*100:100;
  pct('p-am-bar',amPct);
  document.getElementById('p-hp-val').textContent=Math.ceil(p.hp);
  document.getElementById('p-en-val').textContent=Math.ceil(p.energy);
  document.getElementById('p-am-val').textContent=isFinite(pw.maxAmmo)?pw.ammoLeft+'/'+pw.maxAmmo:'‚àû';
  document.getElementById('p-wep-name').textContent=pw.name;
  document.getElementById('p-wep-dot').style.background=RARITY_COLORS[pw.rarity];
  pct('e-hp-bar',Math.max(0,e.hp/e.maxHp*100));
  document.getElementById('e-hp-val').textContent=Math.ceil(Math.max(0,e.hp));
  const ew=e.weapons[e.weapIdx];
  document.getElementById('e-wep-name').textContent=ew.name;
  document.getElementById('e-wep-dot').style.background=RARITY_COLORS[ew.rarity];
  document.getElementById('score-val').textContent=String(gs.score).padStart(5,'0');
  document.getElementById('wave-val').textContent='WAVE '+gs.wave;
  const comboEl=document.getElementById('combo-display');
  if (gs.combo>2) {
    const lvl=gs.combo>=20?'LEGENDARY':gs.combo>=10?'EPIC':gs.combo>=5?'GREAT':'GOOD';
    comboEl.textContent=`${gs.combo}√ó COMBO ‚Äî ${lvl}!`;
    comboEl.style.color=gs.combo>=20?'#ffd060':gs.combo>=10?'#b060ff':gs.combo>=5?'#3c8eff':'#40e080';
  } else comboEl.textContent='';
  updateStatusIcons('p-statuses',p.statuses);
  updateStatusIcons('e-statuses',e.statuses);
  p.abilities.forEach((ab,i)=>{
    const cdEl=document.getElementById('acd'+i);
    if (cdEl) { const cdPct=ab.cd/ab.def.cd*100; cdEl.style.height=clamp(cdPct,0,100)+'%'; }
    const slot=document.getElementById('aslot'+i);
    if (slot) {
      if (ab.def.passive) { slot.className='abil-slot ready'; slot.style.opacity='0.7'; }
      else slot.className='abil-slot'+(ab.cd>0?' on-cd':' ready')+(ab.active?' active':'');
    }
  });
}

function pct(id,v) { const el=document.getElementById(id); if(el) el.style.width=clamp(v,0,100)+'%'; }

function updateStatusIcons(id,statuses) {
  const el=document.getElementById(id);
  if (!el) return;
  const now=Date.now();
  el.innerHTML=statuses.filter(s=>s.end>now).map(s=>{
    const icons={burn:'üî•',freeze:'‚ùÑÔ∏è',stun:'‚≠ê',poison:'‚ò†Ô∏è',bleed:'ü©∏'};
    return `<div class="status-chip ${s.type}">${icons[s.type]||'?'}</div>`;
  }).join('');
}

// ‚îÄ‚îÄ KILL FEED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function kf(msg,type='') {
  const feed=document.getElementById('kill-feed');
  if (!feed) return;
  const el=document.createElement('div');
  el.className='kf-msg '+type; el.textContent=msg;
  feed.appendChild(el);
  setTimeout(()=>{ el.style.opacity=0; setTimeout(()=>el.remove(),2200); },1800);
}

function flashDmg() {
  const ov=document.getElementById('dmg-overlay');
  ov.style.background='rgba(255,0,0,0.32)';
  setTimeout(()=>ov.style.background='rgba(255,0,0,0)',140);
}

// ‚îÄ‚îÄ GAME LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let lastTime=0;
function gameLoop(ts) {
  if (!GS||!GS.running) return;
  const dt=clamp(ts-lastTime,1,50);
  lastTime=ts;
  updatePlayer(GS,dt);
  if (GS.enemy.hp>0) updateEnemy(GS,dt);
  updateBullets(GS,dt);
  updateParticles(GS,dt);
  drawFrame(GS);
  animId=requestAnimationFrame(gameLoop);
}

// ‚îÄ‚îÄ END GAME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function endGame(gs,won) {
  if (animId) cancelAnimationFrame(animId);
  document.getElementById('fog-overlay').style.display='none';
  document.getElementById('slow-vignette').style.opacity=0;
  document.getElementById('dmg-overlay').style.background='none';
  document.onkeydown=null; document.onkeyup=null;
  canvas.onmousemove=null; canvas.onmousedown=null; canvas.onmouseup=null;
  const xpGain=Math.floor(gs.score/100)+(won?200:50)+gs.wave*30;
  addXP(xpGain);
  PROG.totalWaves+=gs.wave;
  if (gs.score>PROG.highScore) PROG.highScore=gs.score;
  saveProg();
  document.getElementById('over-title').textContent=won?t('victory'):t('eliminated');
  document.getElementById('over-title').style.color=won?'#40e080':'#ff3c6e';
  document.getElementById('over-score').textContent=t('score')+': '+gs.score;
  document.getElementById('over-wave').textContent=t('wave')+': '+gs.wave+' | '+t('hiScore')+': '+PROG.highScore;
  document.getElementById('over-xp').textContent='+'+xpGain+' XP ‚Üí '+t('level')+' '+PROG.level;
  // Remove hero badge
  const badge = document.getElementById('hero-hud-badge');
  if (badge) badge.remove();
  showScreen('over');
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SYSTEM 1: TURKISH LANGUAGE SUPPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentLang = localStorage.getItem('pxr_lang') || 'en';

const LANG = {
  en: {
    title: 'PIXEL REAPER X', sub: 'CHAOS ARENA ‚Äî EVERY ROUND IS DIFFERENT',
    newGame: '‚ñ∫ NEW GAME', progression: '‚òÖ PROGRESSION', heroClass: 'ü¶∏ HERO CLASS',
    selectDiff: 'SELECT DIFFICULTY', easy: 'EASY', normal: 'NORMAL', hard: 'HARD', insane: 'INSANE',
    heroTitle: 'SELECT YOUR HERO', heroSub: 'EACH CLASS HAS A UNIQUE SPECIAL ABILITY',
    confirmClass: '‚ñ∫ CONFIRM CLASS', back: '‚Üê BACK',
    randomizing: 'üé≤ RANDOMIZING LOADOUT...', yourWeapons: 'YOUR WEAPONS',
    yourAbilities: 'YOUR ABILITIES', mapPreview: 'MAP PREVIEW', modifiers: 'MODIFIERS',
    enemyLoadout: 'ENEMY LOADOUT', difficulty: 'DIFFICULTY',
    reroll: 'üé≤ REROLL', fight: '‚ñ∫ FIGHT!',
    victory: 'VICTORY!', eliminated: 'ELIMINATED',
    playAgain: '‚ñ∫ PLAY AGAIN', menu: 'MENU',
    wasd: 'WASD', move: 'MOVE', jump: 'JUMP', mouse: 'MOUSE', aimFire: 'AIM/FIRE',
    swap: 'SWAP', reload: 'RELOAD', melee: 'MELEE', abilities: 'ABILITIES',
    crits: 'Crits deal 2-3√ó damage', status: 'Status effects stack', combos: 'Combos multiply score',
    wave: 'WAVE', player: '‚ñ∂ PLAYER', enemy: 'ENEMY ‚óÄ',
    score: 'SCORE', hiScore: 'HI-SCORE', level: 'LEVEL', xpEarned: 'XP EARNED',
    unlocks: 'UNLOCKS', unlocked: '‚úì UNLOCKED',
  },
  tr: {
    title: 'PIXEL REAPER X', sub: 'KAOS ARENASI ‚Äî HER TUR FARKLIDIR',
    newGame: '‚ñ∫ YENƒ∞ OYUN', progression: '‚òÖ ƒ∞LERLEME', heroClass: 'ü¶∏ KAHRAMAN SINIFI',
    selectDiff: 'ZORLUK SE√á', easy: 'KOLAY', normal: 'NORMAL', hard: 'ZOR', insane: '√áILGIN',
    heroTitle: 'KAHRAMAN SE√á', heroSub: 'HER SINIFIN √ñZEL Bƒ∞R YETENEƒûƒ∞ VAR',
    confirmClass: '‚ñ∫ SINIFI ONAYLA', back: '‚Üê GERƒ∞',
    randomizing: 'üé≤ Y√úKLENIYOR...', yourWeapons: 'Sƒ∞LAHLARIN',
    yourAbilities: 'YETENEKLERƒ∞N', mapPreview: 'HARƒ∞TA √ñNƒ∞ZLEME', modifiers: 'DEƒûƒ∞≈ûTƒ∞Rƒ∞Cƒ∞LER',
    enemyLoadout: 'D√ú≈ûMAN EKƒ∞PMANI', difficulty: 'ZORLUK',
    reroll: 'üé≤ YENƒ∞DEN √áEV', fight: '‚ñ∫ SAVA≈û!',
    victory: 'ZAFER!', eliminated: 'ELENDƒ∞N',
    playAgain: '‚ñ∫ TEKRAR OYNA', menu: 'MEN√ú',
    wasd: 'WASD', move: 'HAREKET', jump: 'ZIPLAMA', mouse: 'FARE', aimFire: 'HEDEF/ATE≈û',
    swap: 'DEƒûƒ∞≈ûTƒ∞R', reload: 'DOLDUR', melee: 'D√ñV√ú≈û', abilities: 'YETENEKler',
    crits: 'ƒ∞sabetler 2-3√ó hasar verir', status: 'Durum etkileri birikir', combos: 'Kombolar skoru √ßarpar',
    wave: 'DALGA', player: '‚ñ∂ OYUNCU', enemy: 'D√ú≈ûMAN ‚óÄ',
    score: 'SKOR', hiScore: 'EN Y√úKSEK', level: 'SEVƒ∞YE', xpEarned: 'XP KAZANILDI',
    unlocks: 'Kƒ∞Lƒ∞T A√áMALAR', unlocked: '‚úì A√áILDI',
  }
};

function t(key) { return (LANG[currentLang] || LANG.en)[key] || LANG.en[key] || key; }

function toggleLang() {
  currentLang = currentLang === 'en' ? 'tr' : 'en';
  localStorage.setItem('pxr_lang', currentLang);
  applyTranslations();
}

function applyTranslations() {
  document.getElementById('lang-toggle').textContent = currentLang === 'en' ? 'üåê TR' : 'üåê EN';
  // Menu
  const mt = document.querySelector('.menu-title');
  if (mt) mt.textContent = t('title');
  const ms = document.querySelector('.menu-sub');
  if (ms) ms.textContent = t('sub');
  const btnNG = document.getElementById('btn-new-game');
  if (btnNG) btnNG.textContent = t('newGame');
  const btnProg = document.getElementById('btn-progression');
  if (btnProg) btnProg.textContent = t('progression');
  const btnHero = document.getElementById('btn-hero');
  if (btnHero) btnHero.textContent = t('heroClass');
  const diffLabel = document.getElementById('diff-label');
  if (diffLabel) diffLabel.textContent = t('selectDiff');
  // Diff buttons
  document.querySelectorAll('.diff-btn').forEach(b => {
    const d = b.dataset.d;
    if (d) b.textContent = t(d) || d.toUpperCase();
  });
  const sdLabel = document.querySelector('[style*="SELECT DIFFICULTY"]') ||
    document.evaluate('//div[contains(text(),"SELECT DIFFICULTY") or contains(text(),"ZORLUK")]', document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
  // Hero
  const heroTitle = document.getElementById('hero-title');
  if (heroTitle) heroTitle.textContent = t('heroTitle');
  const heroSub = document.getElementById('hero-sub');
  if (heroSub) heroSub.textContent = t('heroSub');
  const heroConfirm = document.getElementById('hero-confirm');
  if (heroConfirm) heroConfirm.textContent = t('confirmClass');
  // Lobby
  const mapLabel = document.getElementById('map-theme-label');
  // Over
  if (GS && GS.won !== undefined) {
    const ot = document.getElementById('over-title');
    if (ot) ot.textContent = t(GS.won ? 'victory' : 'eliminated');
  }
  // Hero cards
  renderHeroGrid();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SYSTEM 2: HERO CLASSES (Preset Characters)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const HERO_CLASSES = [
  {
    id: 'teleporter', name: 'TELEPORTER', icon: 'üåÄ', role: 'Mobile Assassin',
    color: '#ff44ff', badge: 'BLINK', badgeColor: '#ff44ff',
    statDesc: ['HP: 90', 'Speed: Fast', 'Damage: High', 'Special: Blink'],
    power: '‚ö° BLINK: Short-range teleport (3s CD)',
    weapons: ['PISTOL','KNIFE'],
    abilities: ['BLINK','DASH','EMP','SHIELD'],
    statMods: { hp: 90, speedMult: 1.3, dmgMult: 1.2, cdr: 0.15 },
    heroAbility: {
      id: 'hero_blink',
      name: currentLang === 'tr' ? 'I≈ûINLANMA' : 'BLINK',
      icon: 'üåÄ',
      cd: 3000, energyCost: 20,
      activate: (gs) => {
        const p = gs.player;
        const dx = gs.mouse.x - p.x - 9, dy = gs.mouse.y - p.y - 14;
        const len = Math.sqrt(dx*dx+dy*dy)||1;
        const dist = Math.min(len, 130);
        p.x = clamp(p.x + dx/len*dist, 0, W-p.w);
        p.y = clamp(p.y + dy/len*dist, 0, H-p.h);
        p.vy = 0;
        burst(p.x+9, p.y+14, '#ff44ff', 14, 5);
        kf('üåÄ BLINK!', 'info');
      }
    }
  },
  {
    id: 'speedster', name: 'SPEEDSTER', icon: 'üí®', role: 'Hit & Run',
    color: '#ffdd44', badge: 'RUSH', badgeColor: '#ffdd44',
    statDesc: ['HP: 85', 'Speed: Very Fast', 'Damage: Normal', 'Special: Speed Surge'],
    power: 'üí® SPEED SURGE: +80% speed for 3s (8s CD)',
    weapons: ['SMG','FISTS'],
    abilities: ['SPEED_BURST','DASH','DODGE_ROLL','HEAL'],
    statMods: { hp: 85, speedMult: 1.5, dmgMult: 0.9, cdr: 0.1 },
    heroAbility: {
      id: 'hero_surge',
      name: currentLang === 'tr' ? 'HIZ DALGASI' : 'SPEED SURGE',
      icon: 'üí®',
      cd: 8000, energyCost: 30, duration: 3000,
      activate: (gs) => {
        const p = gs.player;
        const ab = p.abilities.find(a => a.key === 'hero_surge_active');
        if (ab) { ab.active = true; ab.activeEnd = Date.now() + 3000; }
        gs._heroSpeedActive = Date.now() + 3000;
        burst(p.x+9, p.y+14, '#ffdd44', 10, 3);
        kf('üí® SPEED SURGE!', 'info');
      }
    }
  },
  {
    id: 'brute', name: 'POWER BRUTE', icon: 'üí™', role: 'Damage Dealer',
    color: '#ff4400', badge: 'RAGE', badgeColor: '#ff4400',
    statDesc: ['HP: 110', 'Speed: Normal', 'Damage: Very High', 'Special: Power Surge'],
    power: 'üí™ POWER SURGE: +100% dmg for 4s (10s CD)',
    weapons: ['HAMMER','SHOTGUN'],
    abilities: ['BERSERK','GRENADE','RAGE','BLOOD_PACT'],
    statMods: { hp: 110, speedMult: 1.0, dmgMult: 1.5, cdr: 0.05 },
    heroAbility: {
      id: 'hero_surge_brute',
      name: currentLang === 'tr' ? 'G√ú√á DALGASI' : 'POWER SURGE',
      icon: 'üí™',
      cd: 10000, energyCost: 40, duration: 4000,
      activate: (gs) => {
        const p = gs.player;
        p.berserk = true; p.berserkEnd = Date.now() + 4000;
        burst(p.x+9, p.y+14, '#ff2200', 20, 6);
        kf('üí™ POWER SURGE!', 'legendary');
      }
    }
  },
  {
    id: 'tank', name: 'TANK', icon: 'üõ°', role: 'Frontline Defender',
    color: '#44aaff', badge: 'FORTRESS', badgeColor: '#44aaff',
    statDesc: ['HP: 200', 'Speed: Slow', 'Damage: Normal', 'Special: Iron Wall'],
    power: 'üõ° IRON WALL: Full shield 4s (12s CD)',
    weapons: ['LMG','MACE'],
    abilities: ['SHIELD','IRON_SKIN','REGEN_FIELD','REFLECT'],
    statMods: { hp: 200, speedMult: 0.7, dmgMult: 1.0, cdr: 0.0 },
    heroAbility: {
      id: 'hero_ironwall',
      name: currentLang === 'tr' ? 'DEMƒ∞R DUVAR' : 'IRON WALL',
      icon: 'üõ°',
      cd: 12000, energyCost: 50, duration: 4000,
      activate: (gs) => {
        const p = gs.player;
        const shieldAb = p.abilities.find(a => a.key === 'SHIELD');
        if (shieldAb) { shieldAb.active = true; shieldAb.activeEnd = Date.now() + 4000; }
        p.invincible = 4000;
        burst(p.x+9, p.y+14, '#44aaff', 16, 4);
        kf('üõ° IRON WALL!', 'info');
      }
    }
  },
  {
    id: 'tactical', name: 'TACTICAL', icon: 'üéØ', role: 'Ability Specialist',
    color: '#40e080', badge: 'EXPERT', badgeColor: '#40e080',
    statDesc: ['HP: 95', 'Speed: Normal', 'Damage: Normal', 'Special: CD Reset'],
    power: 'üéØ TACTICAL RESET: Halve all CDs (15s CD)',
    weapons: ['MARKSMAN','STUN_PISTOL'],
    abilities: ['EMP','FREEZE_BOMB','SCAN','OVERLOAD'],
    statMods: { hp: 95, speedMult: 1.0, dmgMult: 1.1, cdr: 0.35 },
    heroAbility: {
      id: 'hero_reset',
      name: currentLang === 'tr' ? 'TAKTƒ∞K SIFIRLA' : 'TACTICAL RESET',
      icon: 'üéØ',
      cd: 15000, energyCost: 60,
      activate: (gs) => {
        const p = gs.player;
        p.abilities.forEach(ab => { ab.cd = Math.floor(ab.cd * 0.3); });
        burst(p.x+9, p.y+14, '#40e080', 12, 4);
        kf('üéØ TACTICAL RESET!', 'good');
      }
    }
  },
  {
    id: 'gravity', name: 'GRAVITY USER', icon: 'üåç', role: 'Reality Bender',
    color: '#aa44ff', badge: 'WARP', badgeColor: '#aa44ff',
    statDesc: ['HP: 100', 'Speed: Normal', 'Damage: Normal', 'Special: Low Gravity'],
    power: 'üåç GRAV SHIFT: Low gravity for 5s (9s CD)',
    weapons: ['VOID_GUN','SPEAR'],
    abilities: ['GRAVITY_WELL','BLACKHOLE','DISPLACE','SUPER_JUMP'],
    statMods: { hp: 100, speedMult: 1.1, dmgMult: 1.0, cdr: 0.15 },
    heroAbility: {
      id: 'hero_gravshift',
      name: currentLang === 'tr' ? 'YER√áEK. DEƒûƒ∞≈ûƒ∞M' : 'GRAV SHIFT',
      icon: 'üåç',
      cd: 9000, energyCost: 35, duration: 5000,
      activate: (gs) => {
        gs._gravShiftEnd = Date.now() + 5000;
        gs._gravShiftOrig = gs.gravMult;
        gs.gravMult = 0.2;
        burst(gs.player.x+9, gs.player.y+14, '#aa44ff', 14, 5);
        kf('üåç GRAV SHIFT!', 'info');
        setTimeout(() => { if (gs._gravShiftEnd && Date.now() >= gs._gravShiftEnd) gs.gravMult = gs._gravShiftOrig || 1; }, 5100);
      }
    }
  }
];

let selectedHero = null;

function gotoHeroSelect() {
  renderHeroGrid();
  showScreen('hero');
}

function renderHeroGrid() {
  const grid = document.getElementById('hero-grid');
  if (!grid) return;
  grid.innerHTML = HERO_CLASSES.map(h => `
    <div class="hero-card ${selectedHero===h.id?'sel':''}" onclick="selectHero('${h.id}')" style="border-color:${selectedHero===h.id?h.color:'#1e1e3a'}">
      <div class="hc-badge" style="color:${h.color};border-color:${h.color}">${h.badge}</div>
      <div class="hc-icon">${h.icon}</div>
      <div class="hc-name" style="color:${h.color}">${h.name}</div>
      <div class="hc-role">${h.role}</div>
      <div class="hc-stats">${h.statDesc.map(s=>`‚Ä¢ ${s}`).join('<br>')}</div>
      <div class="hc-power">${h.power}</div>
    </div>
  `).join('');
}

function selectHero(id) {
  selectedHero = id;
  renderHeroGrid();
}

function confirmHero() {
  if (!selectedHero) selectedHero = null;
  gotoLobby();
}

function getHeroClass() {
  if (!selectedHero) return null;
  return HERO_CLASSES.find(h => h.id === selectedHero);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SYSTEM 3: ADMIN PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const adminConfig = {
  weapons: [],
  abilities: [],
  maxHp: 100,
  speedMult: 1,
  dmgMult: 1,
  cdr: 0,
};

function toggleAdmin() {
  const panel = document.getElementById('admin-panel');
  panel.classList.toggle('open');
  if (panel.classList.contains('open')) {
    refreshAdminWeapons();
    refreshAdminAbilities();
    updateLiveAdmin();
  }
}

function refreshAdminWeapons() {
  const cat = document.getElementById('ap-wep-cat')?.value || '';
  const grid = document.getElementById('ap-weapons-grid');
  if (!grid) return;
  const keys = Object.keys(WEAPON_DEFS).filter(k => !cat || WEAPON_DEFS[k].cat === cat);
  grid.innerHTML = keys.map(k => {
    const d = WEAPON_DEFS[k];
    const sel = adminConfig.weapons.includes(k);
    return `<div class="admin-chip ${sel?'sel-wep':''}" onclick="toggleAdminWeapon('${k}')" title="${d.desc}">${d.icon} ${d.name.substring(0,8)}</div>`;
  }).join('');
}

function refreshAdminAbilities() {
  const grid = document.getElementById('ap-abilities-grid');
  if (!grid) return;
  const keys = Object.keys(ABILITY_DEFS).filter(k => !ABILITY_DEFS[k].passive);
  grid.innerHTML = keys.map(k => {
    const d = ABILITY_DEFS[k];
    const sel = adminConfig.abilities.includes(k);
    return `<div class="admin-chip ${sel?'sel':''}" onclick="toggleAdminAbility('${k}')" title="${d.desc}">${d.icon} ${d.name.substring(0,10)}</div>`;
  }).join('');
}

function toggleAdminWeapon(k) {
  const idx = adminConfig.weapons.indexOf(k);
  if (idx >= 0) { adminConfig.weapons.splice(idx, 1); }
  else if (adminConfig.weapons.length < 3) { adminConfig.weapons.push(k); }
  refreshAdminWeapons();
}

function toggleAdminAbility(k) {
  const idx = adminConfig.abilities.indexOf(k);
  if (idx >= 0) { adminConfig.abilities.splice(idx, 1); }
  else if (adminConfig.abilities.length < 4) { adminConfig.abilities.push(k); }
  refreshAdminAbilities();
}

function updateAdminStat(stat, val) {
  const v = parseFloat(val);
  if (stat === 'maxhp') { adminConfig.maxHp = v; document.getElementById('ap-maxhp-val').textContent = v; }
  if (stat === 'speed') { adminConfig.speedMult = v; document.getElementById('ap-speed-val').textContent = v+'x'; }
  if (stat === 'dmg') { adminConfig.dmgMult = v; document.getElementById('ap-dmg-val').textContent = v+'x'; }
  if (stat === 'cdr') { adminConfig.cdr = v; document.getElementById('ap-cdr-val').textContent = Math.round(v*100)+'%'; }
}

function applyHeroPreset() {
  const id = document.getElementById('ap-hero')?.value;
  if (!id) return;
  const hero = HERO_CLASSES.find(h => h.id === id);
  if (!hero) return;
  adminConfig.weapons = [...hero.weapons];
  adminConfig.abilities = [...hero.abilities];
  adminConfig.maxHp = hero.statMods.hp;
  adminConfig.speedMult = hero.statMods.speedMult;
  adminConfig.dmgMult = hero.statMods.dmgMult;
  adminConfig.cdr = hero.statMods.cdr;
  // Update sliders
  const els = {
    'ap-maxhp': adminConfig.maxHp,
    'ap-speed': adminConfig.speedMult,
    'ap-dmg': adminConfig.dmgMult,
    'ap-cdr': adminConfig.cdr
  };
  for (const [id2, v] of Object.entries(els)) {
    const el = document.getElementById(id2);
    if (el) el.value = v;
  }
  updateAdminStat('maxhp', adminConfig.maxHp);
  updateAdminStat('speed', adminConfig.speedMult);
  updateAdminStat('dmg', adminConfig.dmgMult);
  updateAdminStat('cdr', adminConfig.cdr);
  refreshAdminWeapons();
  refreshAdminAbilities();
}

function resetAdminConfig() {
  adminConfig.weapons = []; adminConfig.abilities = [];
  adminConfig.maxHp = 100; adminConfig.speedMult = 1;
  adminConfig.dmgMult = 1; adminConfig.cdr = 0;
  ['ap-maxhp','ap-speed','ap-dmg','ap-cdr'].forEach(id2 => {
    const el = document.getElementById(id2);
    if (el) el.value = id2==='ap-maxhp'?100:id2==='ap-speed'?1:id2==='ap-dmg'?1:0;
  });
  updateAdminStat('maxhp',100); updateAdminStat('speed',1);
  updateAdminStat('dmg',1); updateAdminStat('cdr',0);
  document.getElementById('ap-hero').value = '';
  refreshAdminWeapons(); refreshAdminAbilities();
}

function applyAdminConfig() {
  // Store admin config for use in next game
  window._adminOverride = { ...adminConfig };
  toggleAdmin();
  gotoLobby();
}

// Live in-game admin actions
function adminFillHP() { if (GS) { GS.player.hp = GS.player.maxHp; kf('üíä HP FILLED', 'good'); } }
function adminFillEnergy() { if (GS) { GS.player.energy = GS.player.maxEnergy; kf('‚ö° ENERGY FILLED', 'good'); } }
function adminFillAmmo() { if (GS) { GS.player.weapons.forEach(w => { w.ammoLeft = w.maxAmmo||Infinity; w.reloading=false; }); kf('üì¶ AMMO FILLED', 'good'); } }
function adminKillEnemy() { if (GS) { GS.enemy.hp = 0; kf('üíÄ ENEMY ELIMINATED', 'legendary'); } }

function updateLiveAdmin() {
  const sec = document.getElementById('ap-live-section');
  if (!sec) return;
  if (GS && GS.running) {
    sec.innerHTML = `
      <div style="display:flex;flex-wrap:wrap;gap:4px;">
        <button class="admin-btn green" onclick="adminFillHP()">üíä HP</button>
        <button class="admin-btn" onclick="adminFillEnergy()">‚ö° EN</button>
        <button class="admin-btn" onclick="adminFillAmmo()">üì¶ AMMO</button>
        <button class="admin-btn red" onclick="adminKillEnemy()">üíÄ KILL ENEMY</button>
      </div>
      <div style="margin-top:6px;font-size:8px;color:#b060ff;font-family:'Orbitron',monospace;">
        LIVE STATS: HP=${Math.ceil(GS.player.hp)}/${GS.player.maxHp} | Wave=${GS.wave}
      </div>`;
  } else {
    sec.innerHTML = '<div style="font-size:8px;color:#555;font-family:\'Rajdhani\',sans-serif;">Start a game to use live adjustments.</div>';
  }
}
setInterval(updateLiveAdmin, 1000);

// ‚îÄ‚îÄ HERO ABILITY SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// This modifies the lobby flow to integrate hero class powers

// ‚îÄ‚îÄ SYSTEM 2: HERO CLASSES - gotoLobby override ‚îÄ‚îÄ
function gotoLobby() {
  rerollsLeft = PROG.unlocked.includes('reroll2') ? 2 : 1;
  rollLobby();
  showScreen('lobby');
}

function rollLobby() {
  const theme = pick(MAP_THEMES);
  document.getElementById('map-theme-label').textContent = 'MAP: ' + theme.name;
  drawMapPreview(theme);

  const hero = getHeroClass();
  const adminOv = window._adminOverride;

  // Weapons
  const allWepKeys = Object.keys(WEAPON_DEFS);
  let playerWeapons = [];

  if (adminOv && adminOv.weapons.length > 0) {
    playerWeapons = [...adminOv.weapons];
  } else if (hero) {
    playerWeapons = [...hero.weapons];
  } else {
    const usedCats = new Set();
    const weapCount = 2 + (PROG.level >= 6 ? 1 : 0);
    let attempts = 0;
    while (playerWeapons.length < weapCount && attempts < 200) {
      attempts++;
      const k = weightedPick(allWepKeys, WEAPON_DEFS);
      const def = WEAPON_DEFS[k];
      if (!def) continue;
      if (!usedCats.has(def.cat)) { playerWeapons.push(k); usedCats.add(def.cat); }
    }
  }

  // Abilities
  const allAbilKeys = Object.keys(ABILITY_DEFS);
  let playerAbils = [];

  if (adminOv && adminOv.abilities.length > 0) {
    playerAbils = [...adminOv.abilities];
  } else if (hero) {
    playerAbils = [...hero.abilities];
    // Inject hero special ability
    if (hero.heroAbility) {
      ABILITY_DEFS[hero.heroAbility.id] = {
        name: hero.heroAbility.name,
        icon: hero.heroAbility.icon,
        cd: hero.heroAbility.cd,
        energyCost: hero.heroAbility.energyCost || 0,
        duration: hero.heroAbility.duration,
        rarity: 'legendary',
        color: hero.color,
        desc: hero.power,
        _heroActivate: hero.heroAbility.activate,
      };
      playerAbils.unshift(hero.heroAbility.id);
    }
  } else {
    const abilCount = PROG.unlocked.includes('ability4') ? 4 : rndInt(2, 3);
    let attempts = 0;
    while (playerAbils.length < abilCount && attempts < 200) {
      attempts++;
      const k = weightedPick(allAbilKeys, ABILITY_DEFS);
      if (!playerAbils.includes(k)) playerAbils.push(k);
    }
  }

  // Enemy weapons
  const enemyWeapons = [];
  const eUsedCats = new Set();
  let attempts2 = 0;
  while (enemyWeapons.length < 2 && attempts2 < 200) {
    attempts2++;
    const k = weightedPick(allWepKeys, WEAPON_DEFS);
    const def = WEAPON_DEFS[k];
    if (!def) continue;
    if (!eUsedCats.has(def.cat) && def.cat !== 'experimental') { enemyWeapons.push(k); eUsedCats.add(def.cat); }
  }
  if (enemyWeapons.length === 0) enemyWeapons.push('AR');
  if (enemyWeapons.length === 1) enemyWeapons.push('PISTOL');

  const mods = [];
  const modCount = rndInt(1, 2);
  let mattempts = 0;
  while (mods.length < modCount && mattempts < 50) {
    mattempts++;
    const m = pick(MODIFIER_DEFS);
    if (!mods.find(x => x.id === m.id)) mods.push(m);
  }

  currentLobby = { theme, playerWeapons, playerAbils, enemyWeapons, mods };
  renderLobby();
}

// ‚îÄ‚îÄ PATCH: initGame to support hero class & admin overrides ‚îÄ‚îÄ
function initGame(lobby) {
  if (animId) cancelAnimationFrame(animId);
  const diff = DIFF_CONFIG[selectedDiff];
  const mods = lobby.mods;
  const hasMod = id => mods.some(m => m.id === id);
  const hero = getHeroClass();
  const adminOv = window._adminOverride;

  let baseHp = PROG.unlocked.includes('start_hp') ? 120 : 100;
  let speedMult = hasMod('double_speed') ? 2 : 1;
  let dmgMult = 1;
  let cdr = 0;

  if (hero) {
    baseHp = hero.statMods.hp;
    speedMult *= hero.statMods.speedMult;
    dmgMult = hero.statMods.dmgMult;
    cdr = hero.statMods.cdr;
  }
  if (adminOv) {
    baseHp = adminOv.maxHp;
    speedMult = adminOv.speedMult;
    dmgMult = adminOv.dmgMult;
    cdr = adminOv.cdr;
    window._adminOverride = null; // consume
  }

  const pWeapons = lobby.playerWeapons.map(k => {
    if (!WEAPON_DEFS[k]) k = 'PISTOL';
    const d = {...WEAPON_DEFS[k]};
    d.ammoLeft = isFinite(d.ammo) ? d.ammo : Infinity;
    d.maxAmmo = d.ammoLeft;
    d.key = k;
    d.reloading = false; d.reloadEnd = 0; d.lastShot = 0;
    d.spinLevel = 0; d.burstCount = 0; d.burstNext = 0;
    if (hasMod('infinite_ammo')) d.ammoLeft = Infinity;
    return d;
  });

  const pAbils = lobby.playerAbils.map((k, i) => {
    const def = ABILITY_DEFS[k] || { name: k, icon: '‚ùì', cd: 5000, energyCost: 0, rarity: 'common', color: '#888', desc: '' };
    const ab = { key: k, def, cd: 0, active: false, activeEnd: 0, slot: i };
    // Apply CDR
    if (cdr > 0) ab.def = { ...def, cd: Math.max(1000, Math.round(def.cd * (1 - cdr))) };
    return ab;
  });

  const eWeapons = lobby.enemyWeapons.map(k => {
    if (!WEAPON_DEFS[k]) k = 'PISTOL';
    const d = {...WEAPON_DEFS[k]};
    d.ammoLeft = isFinite(d.ammo) ? d.ammo : Infinity;
    d.maxAmmo = d.ammoLeft;
    d.key = k;
    d.reloading = false; d.reloadEnd = 0; d.lastShot = 0;
    d.spinLevel = 0;
    if (hasMod('bullet_rain')) d.rate = Math.floor(d.rate * 0.6);
    return d;
  });

  const platforms = generatePlatforms();
  const gravMult   = hasMod('low_grav') ? 0.45 : 1;
  const jumpMult   = hasMod('super_jump') ? 1.7 : 1;
  const glassCannon = hasMod('glass_cannon');
  const lifeSteal  = hasMod('shield_leech');
  const bigHead    = hasMod('giant_heads');
  const oneShot    = hasMod('one_shot');

  GS = {
    lobby, diff, theme: lobby.theme,
    score:0, wave:1, combo:0, comboTimer:0,
    running:true, paused:false,
    mods, hasMod, gravMult, speedMult, jumpMult, glassCannon, lifeSteal, bigHead, oneShot,
    platforms,
    bullets:[], particles:[], explosions:[], damageNums:[], blackholes:[], decoys:[],
    timeSlow:false, timeSlowEnd:0,
    bgParticles: generateBgParticles(lobby.theme),
    overchargeEnd: 0,
    _dmgMult: dmgMult,
    _heroClass: hero,

    player: {
      x:140, y:350, w:18, h:28,
      vx:0, vy:0, onGround:false, facing:1,
      hp: baseHp*(glassCannon?0.6:1), maxHp: baseHp*(glassCannon?0.6:1),
      energy:100, maxEnergy:100,
      weapons:pWeapons, weapIdx:0,
      abilities:pAbils,
      statuses:[],
      invincible:0,
      dashing:false, dashTimer:0, dashVx:0,
      reflecting:false, reflectEnd:0,
      berserk:false, berserkEnd:0,
      decoyActive:false,
      mheld:false,
    },

    enemy: {
      x:720, y:350, w:18, h:28,
      vx:0, vy:0, onGround:false, facing:-1,
      hp: 150 * diff.hpMult,
      maxHp: 150 * diff.hpMult,
      weapons:eWeapons, weapIdx:0,
      statuses:[],
      invincible:0,
      ai: {
        state:'idle', stateTimer:0, stratTimer:diff.strategyChange,
        jumpCd:0, dodgeCd:0, lastSawPlayer:0,
        aimOffset:{x:0,y:0}, aimUpdateTimer:0,
        reactionBuffer:[],
      },
    },

    keys:{}, mouse:{x:450,y:240,down:false},
    lastTime:0,
    fogMod: hasMod('fog'),
  };

  setupHUD(GS);
  setupInput(GS);
  document.getElementById('fog-overlay').style.display = GS.fogMod ? 'block' : 'none';
  lastTime = performance.now();
  animId = requestAnimationFrame(gameLoop);
}

// Patch activateAbility to support hero abilities
function activateAbility(gs, idx) {
  const ab = gs.player.abilities[idx];
  if (!ab || !ab.def) return;
  if (ab.def.passive) return;
  if (ab.cd > 0) return;
  if (gs.player.energy < ab.def.energyCost) return;
  gs.player.energy -= ab.def.energyCost;
  ab.cd = ab.def.cd || 5000;

  // Check if this is a hero special ability
  if (ab.def._heroActivate) {
    ab.def._heroActivate(gs);
    return;
  }

  // Default ability handling
  const k = ab.key;
  const p = gs.player;

  if (k==='DASH'||k==='DOUBLE_DASH') {
    p.dashing=true; p.dashTimer=150; p.dashVx=p.facing*14*gs.speedMult;
    if (k==='DOUBLE_DASH') { setTimeout(()=>{ p.dashing=true; p.dashTimer=150; p.dashVx=p.facing*14*gs.speedMult; },220); }
    burst(p.x+9,p.y+14,'#4488ff',8,3);
  }
  else if (k==='TELEPORT'||k==='BLINK') {
    const range = k==='BLINK' ? 120 : Infinity;
    const dx2=gs.mouse.x-p.x-9, dy2=gs.mouse.y-p.y-14;
    const len2=Math.sqrt(dx2*dx2+dy2*dy2)||1;
    const dist2=Math.min(len2, range);
    p.x=clamp(p.x+dx2/len2*dist2,0,W-p.w);
    p.y=clamp(p.y+dy2/len2*dist2,0,H-p.h);
    p.vy=0; burst(p.x+9,p.y+14,'#ff44ff',14,5); kf('üåÄ TELEPORT','info');
  }
  else if (k==='SUPER_JUMP') { if (p.onGround||true) { p.vy=-20*gs.jumpMult; burst(p.x+9,p.y+p.h,'#44ddff',10,3); } }
  else if (k==='GROUND_SLAM') {
    p.vy=18; p.vx=0;
    setTimeout(()=>{
      const d2=Math.sqrt((gs.enemy.x-p.x)**2+(gs.enemy.y-p.y)**2);
      if(d2<120){ damageEnemy(gs,rndInt(40,70)); burst(p.x,p.y+p.h,'#ff8800',16,6); kf('üí• GROUND SLAM!','good'); }
    },300);
  }
  else if (k==='VAULT'||k==='AIR_DASH'||k==='FLIP') {
    const dir=k==='FLIP'?-p.facing:p.facing;
    p.dashing=true; p.dashTimer=200; p.dashVx=dir*12;
    if (k==='AIR_DASH') p.vy=-3;
    burst(p.x+9,p.y+14,'#88aaff',6,2);
  }
  else if (k==='RUSH') { p.dashing=true; p.dashTimer=400; p.dashVx=p.facing*18; burst(p.x+9,p.y+14,'#ffaa44',10,4); kf('‚ö° RUSH!','info'); }
  else if (k==='SPEED_BURST') { ab.active=true; ab.activeEnd=Date.now()+3000; kf('üí® SPEED BOOST!','info'); }
  else if (k==='SHADOW_STEP') {
    const ex=gs.enemy.x, ey=gs.enemy.y;
    p.x=clamp(ex-(p.facing*60),0,W-p.w); p.y=clamp(ey,0,H-p.h);
    p.vy=0; burst(p.x+9,p.y+14,'#888888',10,3); kf('üåë SHADOW STEP','info');
  }
  else if (k==='WARP') { p.dashing=true; p.dashTimer=150; p.dashVx=p.facing*42; burst(p.x+9,p.y+14,'#44ffee',12,5); kf('üåä WARP JUMP','info'); }
  else if (k==='SHIELD'||k==='AEGIS'||k==='DIVINE_SHIELD') { ab.active=true; ab.activeEnd=Date.now()+(ab.def.duration||2000); kf('üõ° SHIELD ACTIVE','info'); }
  else if (k==='REFLECT') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; p.reflecting=true; p.reflectEnd=Date.now()+ab.def.duration; kf('ü™û REFLECT ACTIVE','info'); }
  else if (k==='IRON_SKIN'||k==='BARRIER'||k==='PHASE_ARMOR') { ab.active=true; ab.activeEnd=Date.now()+(ab.def.duration||2500); kf('ü¶æ ARMOR ACTIVE','info'); }
  else if (k==='DODGE_ROLL') { p.invincible=300; p.dashing=true; p.dashTimer=200; p.dashVx=p.facing*10; burst(p.x+9,p.y+14,'#88aa88',6,2); }
  else if (k==='COUNTER') { ab.active=true; ab.activeEnd=Date.now()+1000; kf('‚öîÔ∏è COUNTER READY','info'); }
  else if (k==='DECOY'||k==='CLONE'||k==='MIRROR_IMAGE') { gs.decoys.push({x:p.x,y:p.y,end:Date.now()+(ab.def.duration||3000)}); kf('üë§ DECOY PLACED','info'); }
  else if (k==='SHROUD') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üå´Ô∏è INVISIBLE!','info'); }
  else if (k==='THORNS') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üåµ THORNS ACTIVE','info'); }
  else if (k==='NULLIFY') { p.statuses=[]; kf('‚õî STATUSES CLEARED','good'); }
  else if (k==='REGEN_FIELD') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üíö REGEN FIELD','good'); }
  else if (k==='GRENADE') { throwGrenade(gs); }
  else if (k==='EMP') { applyStatus(gs.enemy,'stun',2000); burst(gs.enemy.x+9,gs.enemy.y+14,'#ffff00',16,5); kf('‚ö° ENEMY STUNNED!','good'); }
  else if (k==='AIRSTRIKE') { airstrike(gs); }
  else if (k==='BERSERK') { p.berserk=true; p.berserkEnd=Date.now()+ab.def.duration; kf('üò° BERSERK MODE!','legendary'); burst(p.x+9,p.y+14,'#ff2200',20,6); }
  else if (k==='CLUSTER') { for(let ci=0;ci<5;ci++) setTimeout(()=>triggerExplosionAt(gs,rnd(gs.enemy.x-80,gs.enemy.x+80),rnd(gs.enemy.y-80,gs.enemy.y+80),60,[30,55],'enemy'),ci*150); kf('üí• CLUSTER BOMB!','legendary'); }
  else if (k==='POISON_CLOUD') { applyStatus(gs.enemy,'poison',ab.def.duration); burst(gs.enemy.x+9,gs.enemy.y+14,'#44ff44',14,4); kf('‚ò†Ô∏è POISON CLOUD!','good'); }
  else if (k==='CHAIN_LIGHTNING') { const ld=rndInt(40,80); damageEnemy(gs,ld); applyStatus(gs.enemy,'stun',1500); spawnDmgNum(gs,gs.enemy.x+9,gs.enemy.y,ld,'#ffff88',false); kf('‚ö° CHAIN LIGHTNING!','good'); }
  else if (k==='FREEZE_BOMB') { applyStatus(gs.enemy,'freeze',2500); burst(gs.enemy.x+9,gs.enemy.y+14,'#44aaff',12,4); kf('‚ùÑÔ∏è FROZEN!','good'); }
  else if (k==='FIRE_STORM') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üî• FIRE STORM!','legendary'); }
  else if (k==='VOID_STRIKE') { const vsd=rndInt(60,100); damageEnemy(gs,vsd); spawnDmgNum(gs,gs.enemy.x+9,gs.enemy.y,vsd,'#aa44ff',true); burst(gs.enemy.x+9,gs.enemy.y+14,'#6600cc',16,6); kf('üåë VOID STRIKE!','legendary'); }
  else if (k==='METEOR') { for(let mi=0;mi<3;mi++) setTimeout(()=>{ const mx=rnd(gs.enemy.x-100,gs.enemy.x+100); triggerExplosionAt(gs,mx,0,80,[60,100],'enemy'); burst(mx,200,'#ff8822',20,8); },mi*400); kf('‚òÑÔ∏è METEOR STRIKE!','legendary'); }
  else if (k==='NOVA_BLAST') { const nd=rndInt(80,130); damageEnemy(gs,nd); applyStatus(gs.enemy,'stun',1000); spawnDmgNum(gs,gs.enemy.x+9,gs.enemy.y,nd,'#ffffaa',true); burst(p.x+9,p.y+14,'#ffffaa',25,8); kf('üí´ NOVA BLAST!','legendary'); }
  else if (k==='JUDGEMENT') { if(gs.enemy.hp/gs.enemy.maxHp<0.30){ damageEnemy(gs,99999); kf('‚ö° JUDGEMENT!','legendary'); } else { gs.player.energy+=ab.def.energyCost; ab.cd=1000; kf('‚ö° Enemy HP too high!','info'); } }
  else if (k==='SUMMON_BLADES') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('‚öîÔ∏è BLADES SUMMONED!','good'); }
  else if (k==='TURRET') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üî´ TURRET DEPLOYED!','good'); }
  else if (k==='OMNISLASH') { for(let oi=0;oi<10;oi++) setTimeout(()=>{ const od=rndInt(15,30); damageEnemy(gs,od); spawnDmgNum(gs,gs.enemy.x+9,gs.enemy.y-oi*4,od,'#ffdd44',false); },oi*80); kf('üåü OMNISLASH!','legendary'); }
  else if (k==='APOCALYPSE') { for(let ai2=0;ai2<12;ai2++) setTimeout(()=>triggerExplosionAt(gs,rnd(50,W-50),rnd(100,H-100),100,[50,90],'enemy'),ai2*200); kf('üåã APOCALYPSE!','legendary'); }
  else if (k==='HEAL') { p.hp=Math.min(p.maxHp,p.hp+40); burst(p.x+9,p.y+14,'#40ff80',10,3); kf('üíä HEALED 40 HP','good'); }
  else if (k==='BIG_HEAL') { p.hp=Math.min(p.maxHp,p.hp+70); burst(p.x+9,p.y+14,'#40ff80',16,4); kf('üíâ HEALED 70 HP','good'); }
  else if (k==='LIFE_LEECH') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üßõ LIFE LEECH ACTIVE','info'); }
  else if (k==='BLOOD_PACT') { if(p.hp>30){ p.hp-=25; p.energy=Math.min(p.maxEnergy,p.energy+50); kf('ü©∏ BLOOD PACT','info'); } }
  else if (k==='MEDPACK') { p.hp=Math.min(p.maxHp,p.hp+30); kf('üè• MEDPACK +30 HP','good'); }
  else if (k==='TRANSFUSION') { const td=Math.min(30,gs.enemy.hp-1); gs.enemy.hp-=td; p.hp=Math.min(p.maxHp,p.hp+td); kf('ü©∏ TRANSFUSION!','good'); }
  else if (k==='ADRENALINE') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üí™ ADRENALINE!','good'); }
  else if (k==='SOUL_DRAIN') { const sd2=30; damageEnemy(gs,sd2); p.hp=Math.min(p.maxHp,p.hp+sd2); kf('üíÄ SOUL DRAINED!','good'); }
  else if (k==='MASS_REGEN') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üíö MASS REGEN!','good'); }
  else if (k==='PHOENIX') { ab.active=true; ab.activeEnd=Date.now()+99999999; kf('üê¶ PHOENIX READY','legendary'); }
  else if (k==='TIME_SLOW') { gs.timeSlow=true; gs.timeSlowEnd=Date.now()+(ab.def.duration||5000); document.getElementById('slow-vignette').style.opacity=1; kf('‚¨° TIME SLOW','info'); }
  else if (k==='WARP_FIELD') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üåä WARP FIELD!','legendary'); }
  else if (k==='SCAN') { kf(`üëÅÔ∏è ENEMY HP: ${Math.ceil(gs.enemy.hp)}/${Math.ceil(gs.enemy.maxHp)}`,'info'); }
  else if (k==='OVERLOAD') { const ow=p.weapons[p.weapIdx]; ow.ammoLeft=ow.maxAmmo||Infinity; ow.reloading=false; kf('‚ö° AMMO REFILLED','good'); }
  else if (k==='AMMO_SUPPLY') { p.weapons.forEach(w=>{w.ammoLeft=w.maxAmmo||Infinity;w.reloading=false;}); kf('üì¶ ALL AMMO REFILLED','good'); }
  else if (k==='ENERGY_BURST') { p.energy=p.maxEnergy; kf('‚ö° FULL ENERGY!','good'); }
  else if (k==='COUNTER_HACK') { applyStatus(gs.enemy,'stun',5000); kf('üíª ENEMY HACKED!','good'); }
  else if (k==='TIME_LOCK') { applyStatus(gs.enemy,'freeze',3000); applyStatus(gs.enemy,'stun',3000); kf('üîí TIME LOCKED!','legendary'); }
  else if (k==='DISPLACE') { const tx3=p.x,ty3=p.y; p.x=gs.enemy.x; p.y=gs.enemy.y; gs.enemy.x=tx3; gs.enemy.y=ty3; burst(p.x+9,p.y+14,'#ff88cc',12,5); kf('üîÑ DISPLACED!','good'); }
  else if (k==='GRAVITY_WELL') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üåç GRAVITY WELL!','info'); }
  else if (k==='OVERCHARGE') { gs.overchargeEnd=Date.now()+ab.def.duration; kf('üîã OVERCHARGED!','good'); }
  else if (k==='QUANTUM_LOCK') { applyStatus(gs.enemy,'freeze',2000); applyStatus(gs.enemy,'stun',2000); burst(gs.enemy.x+9,gs.enemy.y+14,'#44ffff',14,5); kf('‚öõÔ∏è QUANTUM LOCK!','legendary'); }
  else if (k==='RELOAD_BOOST') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('‚ü≥ FAST RELOAD!','info'); }
  else if (k==='SACRIFICE') { if(p.hp>30){ p.hp-=25; p.energy=Math.min(p.maxEnergy,p.energy+50); kf('üíÄ SACRIFICE','info'); } }
  else if (k==='RAGE') { ab.active=true; ab.activeEnd=Date.now()+(ab.def.duration||4000); kf('üí¢ RAGE MODE!','legendary'); }
  else if (k==='VENGEANCE') { ab.active=true; ab.activeEnd=Date.now()+(ab.def.duration||3000); kf('üò§ VENGEANCE READY!','info'); }
  else if (k==='WILD_CARD') {
    const wAbils=['HEAL','EMP','FREEZE_BOMB','DASH','GRENADE','TELEPORT','VOID_STRIKE'];
    const wk=pick(wAbils); const wIdx=p.abilities.findIndex(a=>a.key===wk);
    if(wIdx>=0) activateAbility(gs,wIdx); else { p.hp=Math.min(p.maxHp,p.hp+25); kf('üÉè WILD CARD: +25 HP','good'); }
  }
  else if (k==='STATIC_FIELD') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('‚ö° STATIC FIELD!','info'); }
  else if (k==='ANCHOR') { applyStatus(gs.enemy,'freeze',2000); gs.enemy.vx=0; kf('‚öì ANCHORED!','good'); }
  else if (k==='NANO_SWARM') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üêù NANO SWARM!','good'); }
  else if (k==='BULLET_TIME') { gs.timeSlow=true; gs.timeSlowEnd=Date.now()+ab.def.duration; document.getElementById('slow-vignette').style.opacity=1; kf('üéØ BULLET TIME!','legendary'); }
  else if (k==='SOUL_LINK') { ab.active=true; ab.activeEnd=Date.now()+ab.def.duration; kf('üíû SOUL LINKED!','info'); }
  else if (k==='MATRIX') { p.invincible=ab.def.duration; kf('üü© MATRIX MODE!','legendary'); }
  else if (k==='REWIND') { p.x=clamp(p.x+p.vx*-180,0,W-p.w); p.y=clamp(p.y+p.vy*-180,0,H-p.h); p.vy=0; burst(p.x+9,p.y+14,'#aa88ff',12,5); kf('‚è™ REWIND!','info'); }
  else if (k==='COPY_CAT') { const eid=gs.enemy.ai.lastAbilUsed||'HEAL'; kf('üê± COPY: '+eid,'info'); }
  // Hero gravity shift handled via def
  else if (k==='BLACKHOLE') {
    const dx2=gs.mouse.x-p.x-9, dy2=gs.mouse.y-p.y-14;
    const len2=Math.sqrt(dx2*dx2+dy2*dy2)||1;
    gs.blackholes.push({x:p.x+9,y:p.y,vx:dx2/len2*8,vy:dy2/len2*8,life:120,r:0,maxR:100});
    kf('üåë BLACK HOLE!','legendary');
  }
}

// Patch calcDmg to apply hero dmg multiplier
function calcDmg(range, isPlayer, gs) {
  const base = rnd(range[0], range[1]);
  const hasCritBoost = isPlayer && gs.player.abilities.some(a => a.def?.passive && a.key === 'CRIT_BOOST');
  const critChance = (gs.bigHead ? 0.3 : 0.1) + (hasCritBoost ? 0.15 : 0);
  const isCrit = Math.random() < critChance;
  const mult = isCrit ? rnd(2, 3) : 1;
  const dmgMult = (isPlayer && gs._dmgMult) ? gs._dmgMult : 1;
  return { dmg: Math.round(base * mult * dmgMult), crit: isCrit };
}

// ‚îÄ‚îÄ HERO SPEEDSTER HANDLING ‚îÄ‚îÄ
function updatePlayer(gs, dt) {
  // Speedster hero speed surge handling
  if (gs._heroSpeedActive && Date.now() < gs._heroSpeedActive) {
    const origSpeedMult = gs.speedMult;
    gs.speedMult = Math.max(gs.speedMult, 2.5);
    _origUpdatePlayer(gs, dt);
    gs.speedMult = origSpeedMult;
  } else {
    _origUpdatePlayer(gs, dt);
  }
}

// ‚îÄ‚îÄ HUD: Hero class badge display ‚îÄ‚îÄ
function setupHUD(gs) {
  _origSetupHUD(gs);
  const hero = gs._heroClass;
  if (hero) {
    const existing = document.getElementById('hero-hud-badge');
    if (!existing) {
      const badge = document.createElement('div');
      badge.id = 'hero-hud-badge';
      badge.style.cssText = `position:fixed;top:6px;left:50%;transform:translateX(-50%);z-index:100;
        background:#0d0d1a;border:1px solid ${hero.color};color:${hero.color};
        font-family:'Orbitron',monospace;font-size:8px;font-weight:700;
        padding:3px 10px;letter-spacing:2px;`;
      badge.textContent = hero.icon + ' ' + hero.name;
      document.body.appendChild(badge);
    }
  } else {
    const b = document.getElementById('hero-hud-badge');
    if (b) b.remove();
  }
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
showScreen('menu');
showProgression();
applyTranslations();
renderHeroGrid();
</script>
</body>
</html>
